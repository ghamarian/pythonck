<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Convolution Implementation with Tensor Descriptors – Tile Distribution Documentation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-038ebe7de1ad581fc619d66ba7f7845b.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-9cae0046c5fab5900eed4751693c39dd.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-038ebe7de1ad581fc619d66ba7f7845b.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-185961ed47a39db2ff9d8581d2d02664.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-1f647ac581ac6b74d75948daead8752e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-185961ed47a39db2ff9d8581d2d02664.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/live-runtime/live-runtime.js" type="module"></script>
<link href="../site_libs/quarto-contrib/live-runtime/live-runtime.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    mermaid.initialize({ 
        startOnLoad: true,
        theme: 'default',
        themeVariables: {
            primaryColor: '#f0f7ff',
            primaryTextColor: '#1e293b',
            primaryBorderColor: '#2563eb',
            lineColor: '#6b7280',
            secondaryColor: '#fef3e2',
            tertiaryColor: '#f0fdf4',
            background: '#ffffff',
            mainBkg: '#f0f7ff',
            secondBkg: '#fef3e2',
            tertiaryBkg: '#f0fdf4',
            primaryTextColor: '#1e293b',
            fontSize: '16px'
        }
    });
});
</script>
<script type="module" src="../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">


<link rel="stylesheet" href="../global-font-override.css">
<link rel="stylesheet" href="../diagram-sizing-fixes.css">
</head>

<body class="nav-sidebar docked quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../concepts/02_tensor_coordinates.html">Transformation Engine</a></li><li class="breadcrumb-item"><a href="../concepts/02_convolution_example.html">Convolution Implementation with Tensor Descriptors</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Tile Distribution Documentation</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tile Distribution Documentation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/00_introduction_motivation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction and Motivation - Why Tile Distribution Matters</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/01_buffer_view.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Buffer Views - Raw Memory Access</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/01_tensor_view.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tensor Views - Multi-Dimensional Structure</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Transformation Engine</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_tensor_coordinates.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Coordinates</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Individual Transforms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_adaptors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tensor Adaptors - Chaining Transformations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_descriptors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tensor Descriptors - Complete Tensor Specifications</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_convolution_example.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Convolution Implementation with Tensor Descriptors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_coordinate_movement.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced Coordinate Operations</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Distribution API</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/03_tile_distribution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tile Distribution - The Core API</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/03_tile_window.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tile Window - Data Access Gateway</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/03_sweep_tile.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sweep Tile - Elegant Iteration</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Coordinate Systems</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/04_coordinate_systems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coordinate Systems - The Mathematical Foundation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Implementation Deep Dive</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/05_encoding_internals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Encoding Internals - The Internal Machinery</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/05_static_distributed_tensor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Static Distributed Tensor - Thread-Local Data Containers</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Thread Mapping</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/06_thread_mapping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Thread Mapping - Connecting to Hardware</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#setup-and-test-data" id="toc-setup-and-test-data" class="nav-link" data-scroll-target="#setup-and-test-data">Setup and Test Data</a></li>
  <li><a href="#understanding-as_strided-simple-tiling-first" id="toc-understanding-as_strided-simple-tiling-first" class="nav-link" data-scroll-target="#understanding-as_strided-simple-tiling-first">Understanding as_strided: Simple Tiling First</a>
  <ul class="collapse">
  <li><a href="#understanding-strides" id="toc-understanding-strides" class="nav-link" data-scroll-target="#understanding-strides">Understanding Strides</a></li>
  </ul></li>
  <li><a href="#overlapping-windows-with-as_strided" id="toc-overlapping-windows-with-as_strided" class="nav-link" data-scroll-target="#overlapping-windows-with-as_strided">Overlapping Windows with as_strided</a>
  <ul class="collapse">
  <li><a href="#key-difference-overlap-vs-no-overlap" id="toc-key-difference-overlap-vs-no-overlap" class="nav-link" data-scroll-target="#key-difference-overlap-vs-no-overlap">Key Difference: Overlap vs No Overlap</a></li>
  </ul></li>
  <li><a href="#naive-convolution-reference" id="toc-naive-convolution-reference" class="nav-link" data-scroll-target="#naive-convolution-reference">1. Naive Convolution Reference</a></li>
  <li><a href="#window-extraction-with-numpy-as_strided" id="toc-window-extraction-with-numpy-as_strided" class="nav-link" data-scroll-target="#window-extraction-with-numpy-as_strided">2. Window Extraction with NumPy as_strided</a></li>
  <li><a href="#window-extraction-with-tensor-descriptors" id="toc-window-extraction-with-tensor-descriptors" class="nav-link" data-scroll-target="#window-extraction-with-tensor-descriptors">3. Window Extraction with Tensor Descriptors</a>
  <ul class="collapse">
  <li><a href="#verification-numpy-vs-tensor-descriptor-windows" id="toc-verification-numpy-vs-tensor-descriptor-windows" class="nav-link" data-scroll-target="#verification-numpy-vs-tensor-descriptor-windows">Verification: NumPy vs Tensor Descriptor Windows</a></li>
  </ul></li>
  <li><a href="#im2col-transformation-with-numpy" id="toc-im2col-transformation-with-numpy" class="nav-link" data-scroll-target="#im2col-transformation-with-numpy">4. Im2col Transformation with NumPy</a></li>
  <li><a href="#im2col-with-tensor-descriptors" id="toc-im2col-with-tensor-descriptors" class="nav-link" data-scroll-target="#im2col-with-tensor-descriptors">5. Im2col with Tensor Descriptors</a>
  <ul class="collapse">
  <li><a href="#simple-approach-reshape-existing-windows" id="toc-simple-approach-reshape-existing-windows" class="nav-link" data-scroll-target="#simple-approach-reshape-existing-windows">Simple Approach: Reshape Existing Windows</a></li>
  <li><a href="#advanced-direct-2d-tensor-descriptor" id="toc-advanced-direct-2d-tensor-descriptor" class="nav-link" data-scroll-target="#advanced-direct-2d-tensor-descriptor">Advanced: Direct 2D Tensor Descriptor</a></li>
  <li><a href="#why-both-approaches" id="toc-why-both-approaches" class="nav-link" data-scroll-target="#why-both-approaches">Why Both Approaches?</a></li>
  <li><a href="#verification-numpy-vs-tensor-descriptor-im2col" id="toc-verification-numpy-vs-tensor-descriptor-im2col" class="nav-link" data-scroll-target="#verification-numpy-vs-tensor-descriptor-im2col">Verification: NumPy vs Tensor Descriptor Im2col</a></li>
  </ul></li>
  <li><a href="#convolution-via-matrix-multiplication" id="toc-convolution-via-matrix-multiplication" class="nav-link" data-scroll-target="#convolution-via-matrix-multiplication">6. Convolution via Matrix Multiplication</a>
  <ul class="collapse">
  <li><a href="#final-verification-all-methods-equivalent" id="toc-final-verification-all-methods-equivalent" class="nav-link" data-scroll-target="#final-verification-all-methods-equivalent">Final Verification: All Methods Equivalent</a></li>
  </ul></li>
  <li><a href="#multi-channel-convolution" id="toc-multi-channel-convolution" class="nav-link" data-scroll-target="#multi-channel-convolution">7. Multi-Channel Convolution</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a>
  <ul class="collapse">
  <li><a href="#key-insights" id="toc-key-insights" class="nav-link" data-scroll-target="#key-insights">Key Insights</a></li>
  <li><a href="#performance-characteristics" id="toc-performance-characteristics" class="nav-link" data-scroll-target="#performance-characteristics">Performance Characteristics</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../concepts/02_tensor_coordinates.html">Transformation Engine</a></li><li class="breadcrumb-item"><a href="../concepts/02_convolution_example.html">Convolution Implementation with Tensor Descriptors</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Convolution Implementation with Tensor Descriptors</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This chapter demonstrates a practical application of tensor descriptors by implementing convolution operations. We’ll progress from a naive implementation to an optimized approach using tensor descriptors, showing how they enable efficient memory access patterns for GPU acceleration. First we show how we can achieve the results using numpy implementation.</p>
<p>The convolution operation is fundamental in deep learning, and understanding its implementation details reveals how high-performance libraries achieve their efficiency. We’ll explore:</p>
<ol type="1">
<li><strong>Naive Implementation</strong>: Direct nested loops for reference</li>
<li><strong>Window Extraction</strong>: Using NumPy’s <code>as_strided</code> for overlapping windows</li>
<li><strong>Tensor Descriptor Windows</strong>: Achieving the same with tensor descriptors</li>
<li><strong>Im2col Transformation</strong>: Converting convolution to matrix multiplication</li>
<li><strong>Multi-channel Extension</strong>: Handling realistic deep learning scenarios</li>
</ol>
<div class="mermaid">
graph TB
    subgraph "Convolution Process"
        I["Input Image<br>6×6"]
        K["Kernel<br>3×3"]
        SW["Sliding Window<br>Extract 3×3 patches"]
        DP["Dot Product<br>Element-wise multiply &amp; sum"]
        O["Output<br>4×4"]
    end
    
    subgraph "Im2col Optimization"
        W["Windows Matrix<br>16×9<br>(all patches)"]
        KF["Kernel Flattened<br>9×1"]
        MM["Matrix Multiply<br>W @ K"]
        OF["Output Flattened<br>16×1"]
    end
    
    I --&gt; SW
    K --&gt; DP
    SW --&gt; DP
    DP --&gt; O
    
    SW --&gt; W
    K --&gt; KF
    W --&gt; MM
    KF --&gt; MM
    MM --&gt; OF
    OF --&gt; O
    
    style I fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style O fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    style MM fill:#fff3e0,stroke:#f57c00,stroke-width:2px
</div>
<section id="setup-and-test-data" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-test-data">Setup and Test Data</h2>
<div>
<div id="pyodide-1" class="exercise-cell">

</div>
<script type="pyodide-1-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOnRydWUsImVjaG8iOmZhbHNlLCJlZGl0IjpmYWxzZSwiZXZhbCI6dHJ1ZSwib3V0cHV0IjpmYWxzZX0sImNvZGUiOiJcbiMgQXV0by1pbnN0YWxsIHB5dGhvbmNrIHBhY2thZ2VcbmltcG9ydCBtaWNyb3BpcFxuYXdhaXQgbWljcm9waXAuaW5zdGFsbChcImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9naGFtYXJpYW4vcHl0aG9uY2svbWFzdGVyL2RvY3VtZW50YXRpb24vcHl0aG9uY2stMC4xLjAtcHkzLW5vbmUtYW55LndobFwiKSJ9
</script>
</div>
<div>
<div id="pyodide-2" class="exercise-cell">

</div>
<script type="pyodide-2-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlY2hvIjp0cnVlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlLCJvdXRwdXQiOnRydWV9LCJjb2RlIjoiXG4jIEltcG9ydCBhbGwgcmVxdWlyZWQgbW9kdWxlc1xuaW1wb3J0IG51bXB5IGFzIG5wXG5mcm9tIHB5dGVuc29yLnRlbnNvcl9kZXNjcmlwdG9yIGltcG9ydCAoXG4gICAgbWFrZV9uYWl2ZV90ZW5zb3JfZGVzY3JpcHRvcixcbiAgICBtYWtlX25haXZlX3RlbnNvcl9kZXNjcmlwdG9yX3BhY2tlZCxcbiAgICBtYWtlX25haXZlX3RlbnNvcl9kZXNjcmlwdG9yX2FsaWduZWQsXG4gICAgdHJhbnNmb3JtX3RlbnNvcl9kZXNjcmlwdG9yLFxuICAgIFBhc3NUaHJvdWdoVHJhbnNmb3JtLFxuICAgIFVubWVyZ2VUcmFuc2Zvcm0sXG4gICAgTWVyZ2VUcmFuc2Zvcm0sIFxuICAgIG1ha2VfbWVyZ2VfdHJhbnNmb3JtLFxuICAgIEVtYmVkVHJhbnNmb3JtLFxuICAgIE11bHRpSW5kZXhcbilcblxuZGVmIGNyZWF0ZV90ZXN0X2RhdGEoKTpcbiAgICBcIlwiXCJDcmVhdGUgdGVzdCBkYXRhIGZvciBjb252b2x1dGlvbiBleGFtcGxlcy5cIlwiXCJcbiAgICAjIDZ4NiBpbnB1dCBpbWFnZSB3aXRoIHNlcXVlbnRpYWwgbnVtYmVycyAoZWFzaWVyIHRvIGZvbGxvdylcbiAgICBpbWFnZSA9IG5wLmFyYW5nZSgxLCAzNykucmVzaGFwZSg2LCA2KVxuICAgIFxuICAgICMgUmFuZG9tIDN4MyBrZXJuZWwgZm9yIG1vcmUgaW50ZXJlc3Rpbmcgb3V0cHV0XG4gICAgbnAucmFuZG9tLnNlZWQoNDIpICAjIEZvciByZXByb2R1Y2libGUgcmVzdWx0c1xuICAgIGtlcm5lbCA9IG5wLnJhbmRvbS5yYW5kaW50KC0yLCAzLCAoMywgMykpXG4gICAgXG4gICAgcmV0dXJuIGltYWdlLCBrZXJuZWxcblxuZGVmIHByaW50X21hdHJpeChtYXRyaXgsIHRpdGxlPVwiTWF0cml4XCIpOlxuICAgIFwiXCJcIlByaW50IGEgbWF0cml4IGluIGEgbmljZSBmb3JtYXQuXCJcIlwiXG4gICAgaWYgdGl0bGU6XG4gICAgICAgIHByaW50KGZcIlxcbnt0aXRsZX06XCIpXG4gICAgaWYgbGVuKG1hdHJpeC5zaGFwZSkgPT0gMjpcbiAgICAgICAgZm9yIHJvdyBpbiBtYXRyaXg6XG4gICAgICAgICAgICBwcmludChcIiBcIi5qb2luKGZcInt2YWw6My4wZn1cIiBpZiBhYnModmFsIC0gcm91bmQodmFsKSkgPCAxZS0xMCBlbHNlIGZcInt2YWw6My4xZn1cIiBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHZhbCBpbiByb3cpKVxuICAgIGVsc2U6XG4gICAgICAgIHByaW50KGZcIlNoYXBlOiB7bWF0cml4LnNoYXBlfVwiKVxuICAgICAgICBwcmludChtYXRyaXgpXG5cblxuZGVmIHByaW50X3dpbmRvd3NfdGlsZWQod2luZG93cywgdGl0bGU9XCJXaW5kb3dzIFRpbGVkIFZpZXdcIik6XG4gICAgXCJcIlwiUHJpbnQgNEQgd2luZG93cyB0ZW5zb3IgYXMgYSB0aWxlZCAyRCBsYXlvdXQgd2l0aCBzcGFjaW5nLlwiXCJcIlxuICAgIGlmIHRpdGxlOlxuICAgICAgICBwcmludChmXCJcXG57dGl0bGV9OlwiKVxuICAgIFxuICAgIG91dF9oLCBvdXRfdywgSywgSyA9IHdpbmRvd3Muc2hhcGVcbiAgICBcbiAgICAjIENyZWF0ZSBzZXBhcmF0b3IgcGF0dGVybnNcbiAgICAjIEVhY2ggbnVtYmVyIHRha2VzIDMgY2hhcnMsIHNlcGFyYXRlZCBieSBzcGFjZXMsIHNvIEsgbnVtYmVycyA9IDMqSyArIChLLTEpIGNoYXJzXG4gICAgd2luZG93X3dpZHRoID0gMyAqIEsgKyAoSyAtIDEpXG4gICAgcm93X3NlcCA9IFwiLVwiICogd2luZG93X3dpZHRoXG4gICAgY29sX3NlcCA9IFwiIHwgXCJcbiAgICBcbiAgICBmb3Igd2luZG93X3JvdyBpbiByYW5nZShvdXRfaCk6XG4gICAgICAgICMgUHJpbnQgZWFjaCByb3cgb2Ygd2luZG93c1xuICAgICAgICBmb3Iga19yb3cgaW4gcmFuZ2UoSyk6XG4gICAgICAgICAgICBsaW5lX3BhcnRzID0gW11cbiAgICAgICAgICAgIGZvciB3aW5kb3dfY29sIGluIHJhbmdlKG91dF93KTpcbiAgICAgICAgICAgICAgICB3aW5kb3dfZGF0YSA9IFwiIFwiLmpvaW4oZlwie3ZhbDozLjBmfVwiIGZvciB2YWwgaW4gd2luZG93c1t3aW5kb3dfcm93LCB3aW5kb3dfY29sLCBrX3JvdywgOl0pXG4gICAgICAgICAgICAgICAgbGluZV9wYXJ0cy5hcHBlbmQod2luZG93X2RhdGEpXG4gICAgICAgICAgICBwcmludChjb2xfc2VwLmpvaW4obGluZV9wYXJ0cykpXG4gICAgICAgIFxuICAgICAgICAjIFByaW50IGhvcml6b250YWwgc2VwYXJhdG9yIGJldHdlZW4gd2luZG93IHJvd3MgKGV4Y2VwdCBhZnRlciBsYXN0IHJvdylcbiAgICAgICAgaWYgd2luZG93X3JvdyA8IG91dF9oIC0gMTpcbiAgICAgICAgICAgICMgQ3JlYXRlIHNlcGFyYXRvciB0aGF0IGFsaWducyB3aXRoIHRoZSB8IGNoYXJhY3RlcnMgaW4gY29udGVudCBsaW5lc1xuICAgICAgICAgICAgIyBDb250ZW50IHVzZXMgXCIgfCBcIiBzbyBzZXBhcmF0b3Igc2hvdWxkIHVzZSBcIiArIFwiXG4gICAgICAgICAgICBzZXBfcGFydHMgPSBbcm93X3NlcF0gKiBvdXRfd1xuICAgICAgICAgICAgc2VwX2xpbmUgPSAoXCIgKyBcIikuam9pbihzZXBfcGFydHMpXG4gICAgICAgICAgICBwcmludChzZXBfbGluZSlcbiAgICBcbiAgICBwcmludCgpICAjIEVtcHR5IGxpbmUgZm9yIHNwYWNpbmdcblxuIyBDcmVhdGUgb3VyIHRlc3QgZGF0YVxuaW1hZ2UsIGtlcm5lbCA9IGNyZWF0ZV90ZXN0X2RhdGEoKVxucHJpbnRfbWF0cml4KGltYWdlLCBcIjbDlzYgSW5wdXQgSW1hZ2VcIilcbnByaW50X21hdHJpeChrZXJuZWwsIFwiM8OXMyBLZXJuZWwgKEVkZ2UgRGV0ZWN0aW9uKVwiKSJ9
</script>
</div>
</section>
<section id="understanding-as_strided-simple-tiling-first" class="level2">
<h2 class="anchored" data-anchor-id="understanding-as_strided-simple-tiling-first">Understanding as_strided: Simple Tiling First</h2>
<p>Before diving into convolution, let’s understand how <code>as_strided</code> works with a simple example. We’ll start by tiling our matrix into non-overlapping blocks.</p>
<div>
<div id="pyodide-3" class="exercise-cell">

</div>
<script type="pyodide-3-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6ImRlZiBkZW1vbnN0cmF0ZV9zaW1wbGVfdGlsaW5nKCk6XG4gICAgXCJcIlwiRGVtb25zdHJhdGUgc2ltcGxlIHRpbGluZyB3aXRoIGFzX3N0cmlkZWQgKG5vIG92ZXJsYXApLlwiXCJcIlxuICAgIGZyb20gbnVtcHkubGliLnN0cmlkZV90cmlja3MgaW1wb3J0IGFzX3N0cmlkZWRcbiAgICBcbiAgICAjIENyZWF0ZSBhIHNpbXBsZSA2eDYgbWF0cml4XG4gICAgbWF0cml4ID0gbnAuYXJhbmdlKDEsIDM3KS5yZXNoYXBlKDYsIDYpXG4gICAgcHJpbnRfbWF0cml4KG1hdHJpeCwgXCJPcmlnaW5hbCA2w5c2IE1hdHJpeFwiKVxuICAgIFxuICAgICMgVGlsZSBpbnRvIDJ4MiBibG9ja3MgKG5vIG92ZXJsYXApXG4gICAgdGlsZV9zaXplID0gMlxuICAgIG1hdHJpeF9oLCBtYXRyaXhfdyA9IG1hdHJpeC5zaGFwZVxuICAgIG51bV90aWxlc19oID0gbWF0cml4X2ggLy8gdGlsZV9zaXplXG4gICAgbnVtX3RpbGVzX3cgPSBtYXRyaXhfdyAvLyB0aWxlX3NpemVcbiAgICBcbiAgICBwcmludChmXCJcXG5UaWxpbmcgaW50byB7bnVtX3RpbGVzX2h9w5d7bnVtX3RpbGVzX3d9IHRpbGVzIG9mIHNpemUge3RpbGVfc2l6ZX3Dl3t0aWxlX3NpemV9XCIpXG4gICAgcHJpbnQoZlwiT3JpZ2luYWwgc3RyaWRlczoge21hdHJpeC5zdHJpZGVzfSAoYnl0ZXMgcGVyIHN0ZXApXCIpXG4gICAgXG4gICAgIyBDYWxjdWxhdGUgbmV3IHN0cmlkZXMgZm9yIHRpbGluZ1xuICAgICMgVG8gbW92ZSB0byBuZXh0IHRpbGUgdmVydGljYWxseToganVtcCB0aWxlX3NpemUgcm93c1xuICAgICMgVG8gbW92ZSB0byBuZXh0IHRpbGUgaG9yaXpvbnRhbGx5OiBqdW1wIHRpbGVfc2l6ZSBjb2x1bW5zICBcbiAgICAjIFdpdGhpbiB0aWxlOiB1c2Ugb3JpZ2luYWwgc3RyaWRlc1xuICAgIHRpbGVzID0gYXNfc3RyaWRlZChcbiAgICAgICAgbWF0cml4LFxuICAgICAgICBzaGFwZT0obnVtX3RpbGVzX2gsIG51bV90aWxlc193LCB0aWxlX3NpemUsIHRpbGVfc2l6ZSksXG4gICAgICAgIHN0cmlkZXM9KG1hdHJpeC5zdHJpZGVzWzBdICogdGlsZV9zaXplLCBtYXRyaXguc3RyaWRlc1sxXSAqIHRpbGVfc2l6ZSwgXG4gICAgICAgICAgICAgICAgbWF0cml4LnN0cmlkZXNbMF0sIG1hdHJpeC5zdHJpZGVzWzFdKVxuICAgIClcbiAgICBcbiAgICBwcmludChmXCJUaWxlcyBzaGFwZToge3RpbGVzLnNoYXBlfVwiKVxuICAgIHByaW50KGZcIk5ldyBzdHJpZGVzOiB7dGlsZXMuc3RyaWRlc31cIilcbiAgICBwcmludChmXCJTdHJpZGUgY2FsY3VsYXRpb246XCIpXG4gICAgcHJpbnQoZlwiICAtIE1vdmUgdG8gbmV4dCB0aWxlIHJvdzoge21hdHJpeC5zdHJpZGVzWzBdfSDDlyB7dGlsZV9zaXplfSA9IHttYXRyaXguc3RyaWRlc1swXSAqIHRpbGVfc2l6ZX1cIilcbiAgICBwcmludChmXCIgIC0gTW92ZSB0byBuZXh0IHRpbGUgY29sOiB7bWF0cml4LnN0cmlkZXNbMV19IMOXIHt0aWxlX3NpemV9ID0ge21hdHJpeC5zdHJpZGVzWzFdICogdGlsZV9zaXplfVwiKVxuICAgIHByaW50KGZcIiAgLSBXaXRoaW4gdGlsZSByb3c6IHttYXRyaXguc3RyaWRlc1swXX0gKG9yaWdpbmFsKVwiKVxuICAgIHByaW50KGZcIiAgLSBXaXRoaW4gdGlsZSBjb2w6IHttYXRyaXguc3RyaWRlc1sxXX0gKG9yaWdpbmFsKVwiKVxuICAgIFxuICAgIHJldHVybiB0aWxlc1xuXG4jIERlbW9uc3RyYXRlIHNpbXBsZSB0aWxpbmdcbnRpbGVzID0gZGVtb25zdHJhdGVfc2ltcGxlX3RpbGluZygpXG5cbiMgU2hvdyBhbGwgdGlsZXMgaW4gdGlsZWQgbGF5b3V0XG5wcmludF93aW5kb3dzX3RpbGVkKHRpbGVzLCBcIkFsbCAyw5cyIFRpbGVzIGluIFRpbGVkIExheW91dFwiKSJ9
</script>
</div>
<section id="understanding-strides" class="level3">
<h3 class="anchored" data-anchor-id="understanding-strides">Understanding Strides</h3>
<p>The key insight is understanding <strong>strides</strong> - how many bytes to skip to move to the next element in each dimension:</p>
<ul>
<li><strong>Original matrix</strong>: <code>shape=(6, 6)</code>, <code>strides=(48, 8)</code> (8 bytes per int64, 6 elements per row)</li>
<li><strong>Tiled view</strong>: <code>shape=(3, 3, 2, 2)</code>, <code>strides=(96, 16, 48, 8)</code>
<ul>
<li>To move to next tile row: skip 2 matrix rows = <code>48 × 2 = 96</code> bytes</li>
<li>To move to next tile col: skip 2 matrix cols = <code>8 × 2 = 16</code> bytes<br>
</li>
<li>Within tile: use original strides <code>(48, 8)</code></li>
</ul></li>
</ul>
</section>
</section>
<section id="overlapping-windows-with-as_strided" class="level2">
<h2 class="anchored" data-anchor-id="overlapping-windows-with-as_strided">Overlapping Windows with as_strided</h2>
<p>Now let’s see how to create overlapping windows - the foundation of convolution:</p>
<div>
<div id="pyodide-4" class="exercise-cell">

</div>
<script type="pyodide-4-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6ImRlZiBkZW1vbnN0cmF0ZV9vdmVybGFwcGluZ193aW5kb3dzKCk6XG4gICAgXCJcIlwiRGVtb25zdHJhdGUgb3ZlcmxhcHBpbmcgd2luZG93cyB3aXRoIGFzX3N0cmlkZWQuXCJcIlwiXG4gICAgZnJvbSBudW1weS5saWIuc3RyaWRlX3RyaWNrcyBpbXBvcnQgYXNfc3RyaWRlZFxuICAgIFxuICAgICMgVXNlIG91ciB0ZXN0IGltYWdlXG4gICAgaW1hZ2UsIF8gPSBjcmVhdGVfdGVzdF9kYXRhKClcbiAgICBwcmludF9tYXRyaXgoaW1hZ2UsIFwiNsOXNiBJbnB1dCBJbWFnZVwiKVxuICAgIFxuICAgICMgRXh0cmFjdCAzeDMgb3ZlcmxhcHBpbmcgd2luZG93c1xuICAgIEsgPSAzICAjIGtlcm5lbCBzaXplXG4gICAgSCwgVyA9IGltYWdlLnNoYXBlXG4gICAgb3V0X2gsIG91dF93ID0gSCAtIEsgKyAxLCBXIC0gSyArIDFcbiAgICBcbiAgICBwcmludChmXCJcXG5FeHRyYWN0aW5nIHtLfcOXe0t9IG92ZXJsYXBwaW5nIHdpbmRvd3NcIilcbiAgICBwcmludChmXCJPdXRwdXQgcG9zaXRpb25zOiB7b3V0X2h9w5d7b3V0X3d9ID0ge291dF9oICogb3V0X3d9IHdpbmRvd3NcIilcbiAgICBwcmludChmXCJPcmlnaW5hbCBzdHJpZGVzOiB7aW1hZ2Uuc3RyaWRlc31cIilcbiAgICBcbiAgICAjIEZvciBvdmVybGFwcGluZyB3aW5kb3dzLCB3ZSBtb3ZlIGJ5IDEgZWxlbWVudCAobm90IHRpbGVfc2l6ZSlcbiAgICAjIEJ1dCB3aXRoaW4gZWFjaCB3aW5kb3csIHdlIHN0aWxsIHVzZSBvcmlnaW5hbCBzdHJpZGVzXG4gICAgd2luZG93cyA9IGFzX3N0cmlkZWQoXG4gICAgICAgIGltYWdlLFxuICAgICAgICBzaGFwZT0ob3V0X2gsIG91dF93LCBLLCBLKSxcbiAgICAgICAgc3RyaWRlcz0oaW1hZ2Uuc3RyaWRlc1swXSwgaW1hZ2Uuc3RyaWRlc1sxXSwgaW1hZ2Uuc3RyaWRlc1swXSwgaW1hZ2Uuc3RyaWRlc1sxXSlcbiAgICApXG4gICAgXG4gICAgcHJpbnQoZlwiV2luZG93cyBzaGFwZToge3dpbmRvd3Muc2hhcGV9XCIpXG4gICAgcHJpbnQoZlwiTmV3IHN0cmlkZXM6IHt3aW5kb3dzLnN0cmlkZXN9XCIpXG4gICAgcHJpbnQoZlwiU3RyaWRlIG1lYW5pbmc6XCIpXG4gICAgcHJpbnQoZlwiICAtIE1vdmUgdG8gbmV4dCB3aW5kb3cgcm93OiB7aW1hZ2Uuc3RyaWRlc1swXX0gKDEgcm93IGRvd24pXCIpXG4gICAgcHJpbnQoZlwiICAtIE1vdmUgdG8gbmV4dCB3aW5kb3cgY29sOiB7aW1hZ2Uuc3RyaWRlc1sxXX0gKDEgY29sIHJpZ2h0KVwiKVxuICAgIHByaW50KGZcIiAgLSBXaXRoaW4gd2luZG93IHJvdzoge2ltYWdlLnN0cmlkZXNbMF19ICgxIHJvdyBkb3duKVwiKVxuICAgIHByaW50KGZcIiAgLSBXaXRoaW4gd2luZG93IGNvbDoge2ltYWdlLnN0cmlkZXNbMV19ICgxIGNvbCByaWdodClcIilcbiAgICBcbiAgICByZXR1cm4gd2luZG93c1xuXG4jIERlbW9uc3RyYXRlIG92ZXJsYXBwaW5nIHdpbmRvd3NcbndpbmRvd3MgPSBkZW1vbnN0cmF0ZV9vdmVybGFwcGluZ193aW5kb3dzKClcblxuIyBTaG93IGFsbCBvdmVybGFwcGluZyB3aW5kb3dzIGluIHRpbGVkIGxheW91dFxucHJpbnRfd2luZG93c190aWxlZCh3aW5kb3dzLCBcIkFsbCAzw5czIE92ZXJsYXBwaW5nIFdpbmRvd3MgaW4gVGlsZWQgTGF5b3V0XCIpXG5cbnByaW50KGZcIlxcbk5vdGljZSB0aGUgb3ZlcmxhcCAtIGFkamFjZW50IHdpbmRvd3Mgc2hhcmUgY29sdW1ucyBhbmQgcm93cyFcIikifQ==
</script>
</div>
<section id="key-difference-overlap-vs-no-overlap" class="level3">
<h3 class="anchored" data-anchor-id="key-difference-overlap-vs-no-overlap">Key Difference: Overlap vs No Overlap</h3>
<ul>
<li><strong>Non-overlapping tiles</strong>: We skip by <code>tile_size</code> in strides: <code>(stride[0] * tile_size, stride[1] * tile_size, ...)</code></li>
<li><strong>Overlapping windows</strong>: We skip by <code>1</code> in strides: <code>(stride[0] * 1, stride[1] * 1, ...)</code></li>
</ul>
<p>This creates sliding windows that overlap, which is exactly what we need for convolution!</p>
</section>
</section>
<section id="naive-convolution-reference" class="level2">
<h2 class="anchored" data-anchor-id="naive-convolution-reference">1. Naive Convolution Reference</h2>
<p>Let’s start with the most straightforward implementation using nested loops:</p>
<div>
<div id="pyodide-5" class="exercise-cell">

</div>
<script type="pyodide-5-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6ImRlZiBuYWl2ZV9jb252b2x1dGlvbl8yZChpbWFnZSwga2VybmVsKTpcbiAgICBcIlwiXCJSZWZlcmVuY2UgaW1wbGVtZW50YXRpb246IG5haXZlIDJEIGNvbnZvbHV0aW9uIHdpdGggbmVzdGVkIGxvb3BzLlwiXCJcIlxuICAgIEgsIFcgPSBpbWFnZS5zaGFwZVxuICAgIEsgPSBrZXJuZWwuc2hhcGVbMF0gICMgQXNzdW1lIHNxdWFyZSBrZXJuZWxcbiAgICBvdXRfaCwgb3V0X3cgPSBIIC0gSyArIDEsIFcgLSBLICsgMVxuICAgIFxuICAgIG91dHB1dCA9IG5wLnplcm9zKChvdXRfaCwgb3V0X3cpKVxuICAgIFxuICAgIHByaW50KGZcIklucHV0IHNoYXBlOiB7aW1hZ2Uuc2hhcGV9XCIpXG4gICAgcHJpbnQoZlwiS2VybmVsIHNoYXBlOiB7a2VybmVsLnNoYXBlfVwiKVxuICAgIHByaW50KGZcIk91dHB1dCBzaGFwZToge291dHB1dC5zaGFwZX1cIilcbiAgICBcbiAgICBmb3IgaSBpbiByYW5nZShvdXRfaCk6XG4gICAgICAgIGZvciBqIGluIHJhbmdlKG91dF93KTpcbiAgICAgICAgICAgICMgRXh0cmFjdCB3aW5kb3dcbiAgICAgICAgICAgIHdpbmRvdyA9IGltYWdlW2k6aStLLCBqOmorS11cbiAgICAgICAgICAgICMgQXBwbHkgY29udm9sdXRpb25cbiAgICAgICAgICAgIG91dHB1dFtpLCBqXSA9IG5wLnN1bSh3aW5kb3cgKiBrZXJuZWwpXG4gICAgXG4gICAgcmV0dXJuIG91dHB1dFxuXG4jIFJ1biBuYWl2ZSBjb252b2x1dGlvblxucmVmZXJlbmNlX291dHB1dCA9IG5haXZlX2NvbnZvbHV0aW9uXzJkKGltYWdlLCBrZXJuZWwpXG5wcmludF9tYXRyaXgocmVmZXJlbmNlX291dHB1dCwgXCJOYWl2ZSBDb252b2x1dGlvbiBPdXRwdXRcIikifQ==
</script>
</div>
<p>This implementation directly follows the mathematical definition of convolution. For each output position, we extract the corresponding window from the input image and compute the element-wise product with the kernel.</p>
</section>
<section id="window-extraction-with-numpy-as_strided" class="level2">
<h2 class="anchored" data-anchor-id="window-extraction-with-numpy-as_strided">2. Window Extraction with NumPy as_strided</h2>
<p>Now let’s apply what we learned about overlapping windows to convolution. We need to extract all 3×3 windows for convolution:</p>
<div>
<div id="pyodide-6" class="exercise-cell">

</div>
<script type="pyodide-6-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6ImRlZiBleHRyYWN0X3dpbmRvd3NfbnVtcHkoaW1hZ2UsIGtlcm5lbF9zaXplPTMpOlxuICAgIFwiXCJcIkV4dHJhY3QgY29udm9sdXRpb24gd2luZG93cyB1c2luZyBudW1weSBhc19zdHJpZGVkLlwiXCJcIlxuICAgIGZyb20gbnVtcHkubGliLnN0cmlkZV90cmlja3MgaW1wb3J0IGFzX3N0cmlkZWRcbiAgICBcbiAgICBILCBXID0gaW1hZ2Uuc2hhcGVcbiAgICBLID0ga2VybmVsX3NpemVcbiAgICBvdXRfaCwgb3V0X3cgPSBIIC0gSyArIDEsIFcgLSBLICsgMVxuICAgIFxuICAgICMgVXNlIGFzX3N0cmlkZWQgdG8gY3JlYXRlIG92ZXJsYXBwaW5nIHdpbmRvd3NcbiAgICB3aW5kb3dzID0gYXNfc3RyaWRlZChcbiAgICAgICAgaW1hZ2UsXG4gICAgICAgIHNoYXBlPShvdXRfaCwgb3V0X3csIEssIEspLFxuICAgICAgICBzdHJpZGVzPShpbWFnZS5zdHJpZGVzWzBdLCBpbWFnZS5zdHJpZGVzWzFdLCBpbWFnZS5zdHJpZGVzWzBdLCBpbWFnZS5zdHJpZGVzWzFdKVxuICAgIClcbiAgICBcbiAgICBwcmludChmXCJPcmlnaW5hbCBpbWFnZSBzaGFwZToge2ltYWdlLnNoYXBlfVwiKVxuICAgIHByaW50KGZcIldpbmRvd3Mgc2hhcGU6IHt3aW5kb3dzLnNoYXBlfVwiKVxuICAgIHByaW50KGZcIk1lbW9yeSB2aWV3OiA0RCB0ZW5zb3IgW291dF9oLCBvdXRfdywga2VybmVsX2gsIGtlcm5lbF93XVwiKVxuICAgIFxuICAgIHJldHVybiB3aW5kb3dzXG5cbiMgRXh0cmFjdCB3aW5kb3dzXG53aW5kb3dzX251bXB5ID0gZXh0cmFjdF93aW5kb3dzX251bXB5KGltYWdlKVxuXG4jIFNob3cgd2luZG93cyBpbiB0aWxlZCBsYXlvdXRcbnByaW50X3dpbmRvd3NfdGlsZWQod2luZG93c19udW1weSwgXCJBbGwgV2luZG93cyBpbiBUaWxlZCBMYXlvdXRcIikifQ==
</script>
</div>
<p>Perfect! We now have a 4D tensor <code>[4, 4, 3, 3]</code> containing all 16 convolution windows. Each <code>[i, j, :, :]</code> slice contains the window at output position <code>(i, j)</code>.</p>
</section>
<section id="window-extraction-with-tensor-descriptors" class="level2">
<h2 class="anchored" data-anchor-id="window-extraction-with-tensor-descriptors">3. Window Extraction with Tensor Descriptors</h2>
<p>Now let’s achieve the same result using tensor descriptors, we have seen a similar results before when we learnt about the <code>EmbedTransform</code> that is behind <code>make_naive_tensor_descriptor</code>.</p>
<div>
<div id="pyodide-7" class="exercise-cell">

</div>
<script type="pyodide-7-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6ImRlZiBleHRyYWN0X3dpbmRvd3NfdGVuc29yX2Rlc2NyaXB0b3IoaW1hZ2UsIGtlcm5lbF9zaXplPTMpOlxuICAgIFwiXCJcIkV4dHJhY3QgY29udm9sdXRpb24gd2luZG93cyB1c2luZyBUZW5zb3IgRGVzY3JpcHRvcnMuXCJcIlwiXG4gICAgSCwgVyA9IGltYWdlLnNoYXBlXG4gICAgSyA9IGtlcm5lbF9zaXplXG4gICAgb3V0X2gsIG91dF93ID0gSCAtIEsgKyAxLCBXIC0gSyArIDFcbiAgICBcbiAgICAjIENyZWF0ZSB0ZW5zb3IgZGVzY3JpcHRvciBmb3IgNEQgd2luZG93c1xuICAgIHdpbmRvd19sZW5ndGhzID0gW291dF9oLCBvdXRfdywgSywgS11cbiAgICB3aW5kb3dfc3RyaWRlcyA9IFtXLCAxLCBXLCAxXSAgIyBTdHJpZGVzIGZvciBvdmVybGFwcGluZyB3aW5kb3dzXG4gICAgXG4gICAgd2luZG93c19kZXNjcmlwdG9yID0gbWFrZV9uYWl2ZV90ZW5zb3JfZGVzY3JpcHRvcih3aW5kb3dfbGVuZ3Rocywgd2luZG93X3N0cmlkZXMpXG4gICAgXG4gICAgcHJpbnQoZlwiVGVuc29yIGRlc2NyaXB0b3Igc2hhcGU6IHt3aW5kb3dzX2Rlc2NyaXB0b3IuZ2V0X2xlbmd0aHMoKX1cIilcbiAgICBwcmludChmXCJFbGVtZW50IHNwYWNlIHNpemU6IHt3aW5kb3dzX2Rlc2NyaXB0b3IuZ2V0X2VsZW1lbnRfc3BhY2Vfc2l6ZSgpfVwiKVxuICAgIFxuICAgICMgRXh0cmFjdCB3aW5kb3dzIHVzaW5nIHRlbnNvciBkZXNjcmlwdG9yXG4gICAgaW1hZ2VfZmxhdCA9IGltYWdlLmZsYXR0ZW4oKVxuICAgIHdpbmRvd3NfdGQgPSBucC56ZXJvcygob3V0X2gsIG91dF93LCBLLCBLKSlcbiAgICBcbiAgICBmb3IgaSBpbiByYW5nZShvdXRfaCk6XG4gICAgICAgIGZvciBqIGluIHJhbmdlKG91dF93KTpcbiAgICAgICAgICAgIGZvciBraSBpbiByYW5nZShLKTpcbiAgICAgICAgICAgICAgICBmb3Iga2ogaW4gcmFuZ2UoSyk6XG4gICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IHdpbmRvd3NfZGVzY3JpcHRvci5jYWxjdWxhdGVfb2Zmc2V0KFtpLCBqLCBraSwga2pdKVxuICAgICAgICAgICAgICAgICAgICB3aW5kb3dzX3RkW2ksIGosIGtpLCBral0gPSBpbWFnZV9mbGF0W29mZnNldF1cbiAgICBcbiAgICByZXR1cm4gd2luZG93c190ZFxuXG4jIEV4dHJhY3Qgd2luZG93cyB1c2luZyB0ZW5zb3IgZGVzY3JpcHRvclxud2luZG93c190ZCA9IGV4dHJhY3Rfd2luZG93c190ZW5zb3JfZGVzY3JpcHRvcihpbWFnZSlcblxuIyBTaG93IGFsbCB3aW5kb3dzIGluIHRpbGVkIGxheW91dFxucHJpbnRfd2luZG93c190aWxlZCh3aW5kb3dzX3RkLCBcIkFsbCBXaW5kb3dzIGluIFRpbGVkIExheW91dCAoVGVuc29yIERlc2NyaXB0b3IpXCIpIn0=
</script>
</div>
<p>The key insight is the stride pattern <code>[W, 1, W, 1]</code>:</p>
<ul>
<li>Moving one step in <code>out_h</code> direction requires jumping <code>W</code> elements (one row)</li>
<li>Moving one step in <code>out_w</code> direction requires jumping <code>1</code> element (one column)<br>
</li>
<li>Moving one step in <code>kernel_h</code> direction requires jumping <code>W</code> elements (one row)</li>
<li>Moving one step in <code>kernel_w</code> direction requires jumping <code>1</code> element (one column)</li>
</ul>
<section id="verification-numpy-vs-tensor-descriptor-windows" class="level3">
<h3 class="anchored" data-anchor-id="verification-numpy-vs-tensor-descriptor-windows">Verification: NumPy vs Tensor Descriptor Windows</h3>
<p>We can see that we get the same results as we do in numpy approach.</p>
<div>
<div id="pyodide-8" class="exercise-cell">

</div>
<script type="pyodide-8-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6IiMgQ29tcGFyZSB0aGUgdHdvIGFwcHJvYWNoZXNcbmRpZmZlcmVuY2UgPSBucC5saW5hbGcubm9ybSh3aW5kb3dzX251bXB5IC0gd2luZG93c190ZClcbnByaW50KGZcIkwyIG5vcm0gb2YgZGlmZmVyZW5jZToge2RpZmZlcmVuY2V9XCIpXG5cbmlmIGRpZmZlcmVuY2UgPCAxZS0xMDpcbiAgICBwcmludChcIuKchSBTVUNDRVNTOiBUZW5zb3IgZGVzY3JpcHRvciB3aW5kb3dzIGlkZW50aWNhbCB0byBOdW1QeSFcIilcbmVsc2U6XG4gICAgcHJpbnQoXCLinYwgRVJST1I6IFRlbnNvciBkZXNjcmlwdG9yIHdpbmRvd3MgZGlmZmVyIGZyb20gTnVtUHlcIilcbiAgICBwcmludChmXCJNYXggZGlmZmVyZW5jZToge25wLm1heChucC5hYnMod2luZG93c19udW1weSAtIHdpbmRvd3NfdGQpKX1cIikifQ==
</script>
</div>
</section>
</section>
<section id="im2col-transformation-with-numpy" class="level2">
<h2 class="anchored" data-anchor-id="im2col-transformation-with-numpy">4. Im2col Transformation with NumPy</h2>
<p>The next step is converting our 4D windows to a 2D matrix format suitable for matrix multiplication. This is called the “im2col” (image to column) transformation. This can be done by using reshape operator of numpy.</p>
<div>
<div id="pyodide-9" class="exercise-cell">

</div>
<script type="pyodide-9-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6ImRlZiBpbTJjb2xfbnVtcHkod2luZG93cyk6XG4gICAgXCJcIlwiQ29udmVydCA0RCB3aW5kb3dzIHRvIDJEIGltMmNvbCBtYXRyaXggdXNpbmcgTnVtUHkuXCJcIlwiXG4gICAgb3V0X2gsIG91dF93LCBLLCBLID0gd2luZG93cy5zaGFwZVxuICAgIG51bV93aW5kb3dzID0gb3V0X2ggKiBvdXRfd1xuICAgIHBhdGNoX3NpemUgPSBLICogS1xuICAgIFxuICAgICMgUmVzaGFwZSB0byAyRCBtYXRyaXhcbiAgICBpbTJjb2xfbWF0cml4ID0gd2luZG93cy5yZXNoYXBlKG51bV93aW5kb3dzLCBwYXRjaF9zaXplKVxuICAgIFxuICAgIHByaW50KGZcIjREIHdpbmRvd3Mgc2hhcGU6IHt3aW5kb3dzLnNoYXBlfVwiKVxuICAgIHByaW50KGZcIjJEIGltMmNvbCBzaGFwZToge2ltMmNvbF9tYXRyaXguc2hhcGV9XCIpXG4gICAgcHJpbnQoZlwiVHJhbnNmb3JtYXRpb246IFt7b3V0X2h9LCB7b3V0X3d9LCB7S30sIHtLfV0g4oaSIFt7bnVtX3dpbmRvd3N9LCB7cGF0Y2hfc2l6ZX1dXCIpXG4gICAgXG4gICAgcmV0dXJuIGltMmNvbF9tYXRyaXhcblxuIyBDcmVhdGUgaW0yY29sIG1hdHJpeFxuaW0yY29sX251bXB5ID0gaW0yY29sX251bXB5KHdpbmRvd3NfbnVtcHkpXG5cbiMgU2hvdyB0aGUgbWF0cml4IHN0cnVjdHVyZVxucHJpbnQoZlwiXFxuSW0yY29sIG1hdHJpeCAoZWFjaCByb3cgaXMgYSBmbGF0dGVuZWQgd2luZG93KTpcIilcbm91dF9oLCBvdXRfdyA9IDQsIDQgICMgT3VyIG91dHB1dCBkaW1lbnNpb25zXG5mb3IgaSwgcm93IGluIGVudW1lcmF0ZShpbTJjb2xfbnVtcHkpOlxuICAgIHdpbl9pLCB3aW5faiA9IGkgLy8gb3V0X3csIGkgJSBvdXRfd1xuICAgIHByaW50KGZcIlJvdyB7aX0gKHdpbmRvdyBbe3dpbl9pfSx7d2luX2p9XSk6IHsnICcuam9pbihmJ3t2YWw6My4wZn0nIGZvciB2YWwgaW4gcm93KX1cIikifQ==
</script>
</div>
<p>Each row of the im2col matrix contains a flattened convolution window. This transformation allows us to compute all convolutions simultaneously using a single matrix multiplication.</p>
</section>
<section id="im2col-with-tensor-descriptors" class="level2">
<h2 class="anchored" data-anchor-id="im2col-with-tensor-descriptors">5. Im2col with Tensor Descriptors</h2>
<p>Since we already extracted windows using tensor descriptors, we can simply reshape them just like the NumPy version, let’s see how we can do it using the transformation pipelines.</p>
<section id="simple-approach-reshape-existing-windows" class="level3">
<h3 class="anchored" data-anchor-id="simple-approach-reshape-existing-windows">Simple Approach: Reshape Existing Windows</h3>
<p>Since we already extracted the 4D windows using a tensor descriptor, the simplest way to get the im2col matrix is to just reshape the result, similar to how we handled the NumPy array.</p>
<div>
<div id="pyodide-10" class="exercise-cell">

</div>
<script type="pyodide-10-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6ImRlZiBpbTJjb2xfdGRfc2ltcGxlKHdpbmRvd3NfdGQpOlxuICAgIFwiXCJcIkNvbnZlcnQgNEQgdGVuc29yIGRlc2NyaXB0b3Igd2luZG93cyB0byAyRCBpbTJjb2wgbWF0cml4LlwiXCJcIlxuICAgIG91dF9oLCBvdXRfdywgSywgSyA9IHdpbmRvd3NfdGQuc2hhcGVcbiAgICBudW1fd2luZG93cyA9IG91dF9oICogb3V0X3dcbiAgICBwYXRjaF9zaXplID0gSyAqIEtcbiAgICBcbiAgICAjIFJlc2hhcGUgdG8gMkQgbWF0cml4XG4gICAgaW0yY29sX21hdHJpeCA9IHdpbmRvd3NfdGQucmVzaGFwZShudW1fd2luZG93cywgcGF0Y2hfc2l6ZSlcbiAgICBcbiAgICBwcmludChmXCI0RCBURCB3aW5kb3dzIHNoYXBlOiB7d2luZG93c190ZC5zaGFwZX1cIilcbiAgICBwcmludChmXCIyRCBpbTJjb2wgKHNpbXBsZSkgc2hhcGU6IHtpbTJjb2xfbWF0cml4LnNoYXBlfVwiKVxuICAgIFxuICAgIHJldHVybiBpbTJjb2xfbWF0cml4XG5cbiMgQ3JlYXRlIGltMmNvbCBmcm9tIHRlbnNvciBkZXNjcmlwdG9yIHdpbmRvd3NcbmltMmNvbF90ZF9tYXRyaXggPSBpbTJjb2xfdGRfc2ltcGxlKHdpbmRvd3NfdGQpIn0=
</script>
</div>
<p>Perfect! This is exactly the same as the NumPy approach - just reshape the 4D windows into a 2D matrix.</p>
</section>
<section id="advanced-direct-2d-tensor-descriptor" class="level3">
<h3 class="anchored" data-anchor-id="advanced-direct-2d-tensor-descriptor">Advanced: Direct 2D Tensor Descriptor</h3>
<p>However, tensor descriptors can also create the im2col layout directly without intermediate 4D windows. This is useful for GPU implementations:</p>
<div>
<div id="pyodide-11" class="exercise-cell">

</div>
<script type="pyodide-11-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6ImZyb20gcHl0ZW5zb3IudGVuc29yX2Rlc2NyaXB0b3IgaW1wb3J0IG1ha2VfbWVyZ2VfdHJhbnNmb3JtXG5cbmRlZiBjcmVhdGVfZGlyZWN0X2ltMmNvbF9kZXNjcmlwdG9yKGltYWdlLCBrZXJuZWxfc2l6ZT0zKTpcbiAgICBcIlwiXCJDcmVhdGUgaW0yY29sIG1hdHJpeCBkaXJlY3RseSB1c2luZyB0ZW5zb3IgZGVzY3JpcHRvcnMuXCJcIlwiXG4gICAgSCwgVyA9IGltYWdlLnNoYXBlXG4gICAgSyA9IGtlcm5lbF9zaXplXG4gICAgb3V0X2gsIG91dF93ID0gSCAtIEsgKyAxLCBXIC0gSyArIDFcbiAgICBcbiAgICAjIFN0ZXAgMTogQ3JlYXRlIDREIHdpbmRvd3MgZGVzY3JpcHRvclxuICAgIHdpbmRvd19sZW5ndGhzID0gW291dF9oLCBvdXRfdywgSywgS11cbiAgICB3aW5kb3dfc3RyaWRlcyA9IFtXLCAxLCBXLCAxXVxuICAgIHdpbmRvd3NfZGVzY3JpcHRvciA9IG1ha2VfbmFpdmVfdGVuc29yX2Rlc2NyaXB0b3Iod2luZG93X2xlbmd0aHMsIHdpbmRvd19zdHJpZGVzKVxuICAgIFxuICAgICMgU3RlcCAyOiBBcHBseSBtZXJnZSB0cmFuc2Zvcm1zIHRvIGNyZWF0ZSAyRCBpbTJjb2wgbGF5b3V0IGRpcmVjdGx5XG4gICAgbWVyZ2Vfd2luZG93cyA9IG1ha2VfbWVyZ2VfdHJhbnNmb3JtKFtvdXRfaCwgb3V0X3ddKSAgIyBNZXJnZSBzcGF0aWFsIG91dHB1dCBkaW1lbnNpb25zXG4gICAgbWVyZ2VfcGF0Y2ggPSBtYWtlX21lcmdlX3RyYW5zZm9ybShbSywgS10pICAjIE1lcmdlIGtlcm5lbCBkaW1lbnNpb25zXG4gICAgXG4gICAgaW0yY29sX2Rlc2NyaXB0b3IgPSB0cmFuc2Zvcm1fdGVuc29yX2Rlc2NyaXB0b3IoICNcbiAgICAgICAgd2luZG93c19kZXNjcmlwdG9yLFxuICAgICAgICB0cmFuc2Zvcm1zPVttZXJnZV93aW5kb3dzLCBtZXJnZV9wYXRjaF0sXG4gICAgICAgIGxvd2VyX2RpbWVuc2lvbl9oaWRkZW5faWRzcz1bWzAsIDFdLCBbMiwgM11dLFxuICAgICAgICB1cHBlcl9kaW1lbnNpb25faGlkZGVuX2lkc3M9W1swXSwgWzFdXVxuICAgIClcbiAgICBcbiAgICBwcmludChmXCJEaXJlY3QgaW0yY29sIGRlc2NyaXB0b3Igc2hhcGU6IHtpbTJjb2xfZGVzY3JpcHRvci5nZXRfbGVuZ3RocygpfVwiKVxuICAgIHJldHVybiBpbTJjb2xfZGVzY3JpcHRvclxuXG4jIENyZWF0ZSBkaXJlY3QgaW0yY29sIGRlc2NyaXB0b3JcbmltMmNvbF9kZXNjcmlwdG9yID0gY3JlYXRlX2RpcmVjdF9pbTJjb2xfZGVzY3JpcHRvcihpbWFnZSlcblxuIyBUaGlzIGRlc2NyaXB0b3IgY2FuIGRpcmVjdGx5IGNvbXB1dGUgb2Zmc2V0cyBmb3IgdGhlIDJEIGltMmNvbCBsYXlvdXRcbnByaW50KGZcIlxcbkV4YW1wbGU6IG9mZnNldCBmb3Igd2luZG93IDAsIHBhdGNoIGVsZW1lbnQgMDoge2ltMmNvbF9kZXNjcmlwdG9yLmNhbGN1bGF0ZV9vZmZzZXQoWzAsIDBdKX1cIilcbnByaW50KGZcIkV4YW1wbGU6IG9mZnNldCBmb3Igd2luZG93IDAsIHBhdGNoIGVsZW1lbnQgNDoge2ltMmNvbF9kZXNjcmlwdG9yLmNhbGN1bGF0ZV9vZmZzZXQoWzAsIDRdKX1cIilcbnByaW50KGZcIkV4YW1wbGU6IG9mZnNldCBmb3Igd2luZG93IDEsIHBhdGNoIGVsZW1lbnQgMDoge2ltMmNvbF9kZXNjcmlwdG9yLmNhbGN1bGF0ZV9vZmZzZXQoWzEsIDBdKX1cIilcblxuIyBFeHRyYWN0IGRhdGEgdXNpbmcgdGhlIGRpcmVjdCBkZXNjcmlwdG9yXG5kZWYgZXh0cmFjdF9pbTJjb2xfd2l0aF9kZXNjcmlwdG9yKGltYWdlLCBkZXNjcmlwdG9yKTpcbiAgICBcIlwiXCJFeHRyYWN0IGltMmNvbCBtYXRyaXggdXNpbmcgdGVuc29yIGRlc2NyaXB0b3IuXCJcIlwiXG4gICAgaW1hZ2VfZmxhdCA9IGltYWdlLmZsYXR0ZW4oKVxuICAgIGRlc2NyaXB0b3Jfc2hhcGUgPSBkZXNjcmlwdG9yLmdldF9sZW5ndGhzKClcbiAgICBudW1fd2luZG93cywgcGF0Y2hfc2l6ZSA9IGRlc2NyaXB0b3Jfc2hhcGVcbiAgICBcbiAgICBpbTJjb2xfbWF0cml4ID0gbnAuemVyb3MoKG51bV93aW5kb3dzLCBwYXRjaF9zaXplKSlcbiAgICBcbiAgICBmb3IgaSBpbiByYW5nZShudW1fd2luZG93cyk6XG4gICAgICAgIGZvciBqIGluIHJhbmdlKHBhdGNoX3NpemUpOlxuICAgICAgICAgICAgb2Zmc2V0ID0gZGVzY3JpcHRvci5jYWxjdWxhdGVfb2Zmc2V0KFtpLCBqXSlcbiAgICAgICAgICAgIGltMmNvbF9tYXRyaXhbaSwgal0gPSBpbWFnZV9mbGF0W29mZnNldF1cbiAgICBcbiAgICBwcmludChmXCJFeHRyYWN0ZWQgaW0yY29sIG1hdHJpeCB1c2luZyBkZXNjcmlwdG9yOiB7aW0yY29sX21hdHJpeC5zaGFwZX1cIilcbiAgICByZXR1cm4gaW0yY29sX21hdHJpeFxuXG4jIEV4dHJhY3QgaW0yY29sIG1hdHJpeCB1c2luZyB0ZW5zb3IgZGVzY3JpcHRvclxuaW0yY29sX3RkX2RpcmVjdCA9IGV4dHJhY3RfaW0yY29sX3dpdGhfZGVzY3JpcHRvcihpbWFnZSwgaW0yY29sX2Rlc2NyaXB0b3IpXG5cbiMgU2hvdyB0aGUgbWF0cml4IHN0cnVjdHVyZVxucHJpbnQoZlwiXFxuaW0yY29sX3RkX2RpcmVjdCBtYXRyaXggKGVhY2ggcm93IGlzIGEgZmxhdHRlbmVkIHdpbmRvdyk6XCIpXG5vdXRfaCwgb3V0X3cgPSA0LCA0ICAjIE91ciBvdXRwdXQgZGltZW5zaW9uc1xuZm9yIGksIHJvdyBpbiBlbnVtZXJhdGUoaW0yY29sX3RkX2RpcmVjdCk6XG4gICAgd2luX2ksIHdpbl9qID0gaSAvLyBvdXRfdywgaSAlIG91dF93XG4gICAgcHJpbnQoZlwiUm93IHtpfSAod2luZG93IFt7d2luX2l9LHt3aW5fan1dKTogeycgJy5qb2luKGYne3ZhbDozLjBmfScgZm9yIHZhbCBpbiByb3cpfVwiKSJ9
</script>
</div>
</section>
<section id="why-both-approaches" class="level3">
<h3 class="anchored" data-anchor-id="why-both-approaches">Why Both Approaches?</h3>
<ul>
<li><strong>Simple reshape</strong>: Easy to understand, perfect for CPU implementations</li>
<li><strong>Direct tensor descriptor</strong>: Enables efficient GPU kernel generation where the hardware can directly compute memory addresses for the im2col layout without materializing intermediate 4D arrays</li>
</ul>
<p>The advanced direct tensor descriptor approach uses two <code>MergeTransform</code> operations: 1. <strong>Merge spatial dimensions</strong>: <code>[out_h, out_w] → num_windows</code> 2. <strong>Merge kernel dimensions</strong>: <code>[K, K] → patch_size</code></p>
<p>This transforms the 4D tensor <code>[out_h, out_w, K, K]</code> directly into a 2D matrix <code>[num_windows, patch_size]</code> without materializing the intermediate 4D array.</p>
</section>
<section id="verification-numpy-vs-tensor-descriptor-im2col" class="level3">
<h3 class="anchored" data-anchor-id="verification-numpy-vs-tensor-descriptor-im2col">Verification: NumPy vs Tensor Descriptor Im2col</h3>
<div>
<div id="pyodide-12" class="exercise-cell">

</div>
<script type="pyodide-12-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6IiMgQ29tcGFyZSBOdW1QeSBhcHByb2FjaCB3aXRoIGRpcmVjdCB0ZW5zb3IgZGVzY3JpcHRvciBhcHByb2FjaFxuZGlmZmVyZW5jZSA9IG5wLmxpbmFsZy5ub3JtKGltMmNvbF9udW1weSAtIGltMmNvbF90ZF9kaXJlY3QpXG5wcmludChmXCJMMiBub3JtIG9mIGRpZmZlcmVuY2UgKE51bVB5IHZzIFRlbnNvciBEZXNjcmlwdG9yKToge2RpZmZlcmVuY2V9XCIpXG5cbmlmIGRpZmZlcmVuY2UgPCAxZS0xMDpcbiAgICBwcmludChcIuKchSBTVUNDRVNTOiBUZW5zb3IgZGVzY3JpcHRvciBpbTJjb2wgaWRlbnRpY2FsIHRvIE51bVB5IVwiKVxuZWxzZTpcbiAgICBwcmludChcIuKdjCBFUlJPUjogVGVuc29yIGRlc2NyaXB0b3IgaW0yY29sIGRpZmZlcnMgZnJvbSBOdW1QeVwiKVxuICAgIHByaW50KGZcIk1heCBkaWZmZXJlbmNlOiB7bnAubWF4KG5wLmFicyhpbTJjb2xfbnVtcHkgLSBpbTJjb2xfdGRfZGlyZWN0KSl9XCIpXG5cbiMgQWxzbyB2ZXJpZnkgdGhhdCBzaW1wbGUgcmVzaGFwZSBnaXZlcyBzYW1lIHJlc3VsdFxuZGlmZmVyZW5jZV9zaW1wbGUgPSBucC5saW5hbGcubm9ybShpbTJjb2xfbnVtcHkgLSBpbTJjb2xfdGRfbWF0cml4KVxucHJpbnQoZlwiXFxuTDIgbm9ybSBvZiBkaWZmZXJlbmNlIChOdW1QeSB2cyBTaW1wbGUgUmVzaGFwZSk6IHtkaWZmZXJlbmNlX3NpbXBsZX1cIilcbmlmIGRpZmZlcmVuY2Vfc2ltcGxlIDwgMWUtMTA6XG4gICAgcHJpbnQoXCLinIUgU1VDQ0VTUzogU2ltcGxlIHJlc2hhcGUgYXBwcm9hY2ggYWxzbyBpZGVudGljYWwhXCIpIn0=
</script>
</div>
</section>
</section>
<section id="convolution-via-matrix-multiplication" class="level2">
<h2 class="anchored" data-anchor-id="convolution-via-matrix-multiplication">6. Convolution via Matrix Multiplication</h2>
<p>With our im2col matrix ready, we can now perform convolution using simple matrix multiplication:</p>
<div>
<div id="pyodide-13" class="exercise-cell">

</div>
<script type="pyodide-13-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6ImRlZiBjb252b2x1dGlvbl93aXRoX2ltMmNvbChpbTJjb2xfbWF0cml4LCBrZXJuZWwsIG91dF9zaGFwZSk6XG4gICAgXCJcIlwiUGVyZm9ybSBjb252b2x1dGlvbiB1c2luZyBpbTJjb2wgbWF0cml4IG11bHRpcGxpY2F0aW9uLlwiXCJcIlxuICAgICMgRmxhdHRlbiBrZXJuZWxcbiAgICBrZXJuZWxfZmxhdCA9IGtlcm5lbC5mbGF0dGVuKClcbiAgICBcbiAgICBwcmludChmXCJJbTJjb2wgbWF0cml4IHNoYXBlOiB7aW0yY29sX21hdHJpeC5zaGFwZX1cIilcbiAgICBwcmludChmXCJLZXJuZWwgZmxhdCBzaGFwZToge2tlcm5lbF9mbGF0LnNoYXBlfVwiKVxuICAgIFxuICAgICMgTWF0cml4IG11bHRpcGxpY2F0aW9uOiBlYWNoIHJvdyBvZiBpbTJjb2wgd2l0aCBrZXJuZWxcbiAgICBvdXRwdXRfZmxhdCA9IGltMmNvbF9tYXRyaXggQCBrZXJuZWxfZmxhdFxuICAgIFxuICAgICMgUmVzaGFwZSB0byBvdXRwdXQgZGltZW5zaW9uc1xuICAgIG91dHB1dCA9IG91dHB1dF9mbGF0LnJlc2hhcGUob3V0X3NoYXBlKVxuICAgIFxuICAgIHByaW50KGZcIk91dHB1dCBmbGF0IHNoYXBlOiB7b3V0cHV0X2ZsYXQuc2hhcGV9XCIpXG4gICAgcHJpbnQoZlwiRmluYWwgb3V0cHV0IHNoYXBlOiB7b3V0cHV0LnNoYXBlfVwiKVxuICAgIFxuICAgIHJldHVybiBvdXRwdXRcblxuIyBQZXJmb3JtIGNvbnZvbHV0aW9uIHVzaW5nIGltMmNvbFxub3V0X3NoYXBlID0gcmVmZXJlbmNlX291dHB1dC5zaGFwZVxuaW0yY29sX291dHB1dCA9IGNvbnZvbHV0aW9uX3dpdGhfaW0yY29sKGltMmNvbF9udW1weSwga2VybmVsLCBvdXRfc2hhcGUpXG5cbnByaW50X21hdHJpeChpbTJjb2xfb3V0cHV0LCBcIkNvbnZvbHV0aW9uIHZpYSBJbTJjb2xcIikifQ==
</script>
</div>
<section id="final-verification-all-methods-equivalent" class="level3">
<h3 class="anchored" data-anchor-id="final-verification-all-methods-equivalent">Final Verification: All Methods Equivalent</h3>
<div>
<div id="pyodide-14" class="exercise-cell">

</div>
<script type="pyodide-14-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6IiMgVmVyaWZ5IHRoYXQgYWxsIG1ldGhvZHMgcHJvZHVjZSB0aGUgc2FtZSByZXN1bHRcbmRpZmZlcmVuY2UgPSBucC5saW5hbGcubm9ybShyZWZlcmVuY2Vfb3V0cHV0IC0gaW0yY29sX291dHB1dClcbnByaW50KGZcIkwyIG5vcm0gZGlmZmVyZW5jZSAobmFpdmUgdnMgaW0yY29sKToge2RpZmZlcmVuY2V9XCIpXG5cbmlmIGRpZmZlcmVuY2UgPCAxZS0xMDpcbiAgICBwcmludChcIuKchSBTVUNDRVNTOiBJbTJjb2wgY29udm9sdXRpb24gbWF0Y2hlcyBuYWl2ZSByZWZlcmVuY2UhXCIpXG5lbHNlOlxuICAgIHByaW50KFwi4p2MIEVSUk9SOiBJbTJjb2wgY29udm9sdXRpb24gZGlmZmVycyBmcm9tIHJlZmVyZW5jZVwiKVxuICAgIHByaW50KGZcIk1heCBkaWZmZXJlbmNlOiB7bnAubWF4KG5wLmFicyhyZWZlcmVuY2Vfb3V0cHV0IC0gaW0yY29sX291dHB1dCkpfVwiKSJ9
</script>
</div>
</section>
</section>
<section id="multi-channel-convolution" class="level2">
<h2 class="anchored" data-anchor-id="multi-channel-convolution">7. Multi-Channel Convolution</h2>
<p>Real-world deep learning scenarios involve multiple input and output channels. Let’s extend our approach:</p>
<div>
<div id="pyodide-15" class="exercise-cell">

</div>
<script type="pyodide-15-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6ImRlZiBtdWx0aV9jaGFubmVsX2NvbnZvbHV0aW9uKCk6XG4gICAgXCJcIlwiRGVtb25zdHJhdGUgbXVsdGktY2hhbm5lbCBjb252b2x1dGlvbi5cIlwiXCJcbiAgICAjIENyZWF0ZSBtdWx0aS1jaGFubmVsIGlucHV0OiA2eDZ4MiAoMiBpbnB1dCBjaGFubmVscylcbiAgICBucC5yYW5kb20uc2VlZCgxMjMpXG4gICAgaW5wdXRfdGVuc29yID0gbnAucmFuZG9tLnJhbmRpbnQoMCwgNSwgKDYsIDYsIDIpKVxuICAgIFxuICAgICMgQ3JlYXRlIG11bHRpLWNoYW5uZWwgZmlsdGVyczogM3gzeDJ4MyAoMiBpbnB1dCwgMyBvdXRwdXQgY2hhbm5lbHMpXG4gICAgZmlsdGVycyA9IG5wLnJhbmRvbS5yYW5kaW50KC0xLCAyLCAoMywgMywgMiwgMykpXG4gICAgXG4gICAgSCwgVywgQ19pbiA9IGlucHV0X3RlbnNvci5zaGFwZVxuICAgIEssIEssIENfaW5fZmlsdGVyLCBDX291dCA9IGZpbHRlcnMuc2hhcGVcbiAgICBvdXRfaCwgb3V0X3cgPSBIIC0gSyArIDEsIFcgLSBLICsgMVxuICAgIFxuICAgIHByaW50KGZcIklucHV0IHNoYXBlOiB7aW5wdXRfdGVuc29yLnNoYXBlfVwiKVxuICAgIHByaW50KGZcIkZpbHRlcnMgc2hhcGU6IHtmaWx0ZXJzLnNoYXBlfVwiKVxuICAgIHByaW50KGZcIk91dHB1dCBzaGFwZTogKHtvdXRfaH0sIHtvdXRfd30sIHtDX291dH0pXCIpXG4gICAgXG4gICAgIyBSZWZlcmVuY2UgY29udm9sdXRpb24gd2l0aCBuZXN0ZWQgbG9vcHNcbiAgICByZWZlcmVuY2Vfb3V0cHV0ID0gbnAuemVyb3MoKG91dF9oLCBvdXRfdywgQ19vdXQpKVxuICAgIGZvciBpIGluIHJhbmdlKG91dF9oKTpcbiAgICAgICAgZm9yIGogaW4gcmFuZ2Uob3V0X3cpOlxuICAgICAgICAgICAgZm9yIGNfb3V0IGluIHJhbmdlKENfb3V0KTpcbiAgICAgICAgICAgICAgICB3aW5kb3cgPSBpbnB1dF90ZW5zb3JbaTppK0ssIGo6aitLLCA6XSAgIyBbSywgSywgQ19pbl1cbiAgICAgICAgICAgICAgICByZWZlcmVuY2Vfb3V0cHV0W2ksIGosIGNfb3V0XSA9IG5wLnN1bSh3aW5kb3cgKiBmaWx0ZXJzWzosIDosIDosIGNfb3V0XSlcbiAgICBcbiAgICAjIEltMmNvbCBhcHByb2FjaCB1c2luZyBkaXJlY3QgYXNfc3RyaWRlZCAobGlrZSB0aGUgZmlndXJlIHNob3dzKVxuICAgICMgRXh0cmFjdCBhbGwgY2hhbm5lbHMgYXQgb25jZSB1c2luZyBhc19zdHJpZGVkXG4gICAgZnJvbSBudW1weS5saWIuc3RyaWRlX3RyaWNrcyBpbXBvcnQgYXNfc3RyaWRlZFxuICAgIFxuICAgICMgQ3JlYXRlIDVEIHdpbmRvd3MgW291dF9oLCBvdXRfdywgSywgSywgQ19pbl0gZGlyZWN0bHlcbiAgICB3aW5kb3dzXzVkID0gYXNfc3RyaWRlZChcbiAgICAgICAgaW5wdXRfdGVuc29yLFxuICAgICAgICBzaGFwZT0ob3V0X2gsIG91dF93LCBLLCBLLCBDX2luKSxcbiAgICAgICAgc3RyaWRlcz0oaW5wdXRfdGVuc29yLnN0cmlkZXNbMF0sIGlucHV0X3RlbnNvci5zdHJpZGVzWzFdLCBcbiAgICAgICAgICAgICAgICBpbnB1dF90ZW5zb3Iuc3RyaWRlc1swXSwgaW5wdXRfdGVuc29yLnN0cmlkZXNbMV0sIGlucHV0X3RlbnNvci5zdHJpZGVzWzJdKVxuICAgIClcbiAgICBcbiAgICAjIENvbnZlcnQgdG8gaW0yY29sIGZvcm1hdDogW251bV93aW5kb3dzLCBwYXRjaF9zaXplXVxuICAgIG51bV93aW5kb3dzID0gb3V0X2ggKiBvdXRfd1xuICAgIHBhdGNoX3NpemUgPSBLICogSyAqIENfaW5cbiAgICBpbTJjb2xfbWF0cml4ID0gd2luZG93c181ZC5yZXNoYXBlKG51bV93aW5kb3dzLCBwYXRjaF9zaXplKVxuICAgIFxuICAgICMgUmVzaGFwZSBmaWx0ZXJzIGFuZCBhcHBseVxuICAgIGZpbHRlcnNfcmVzaGFwZWQgPSBmaWx0ZXJzLnJlc2hhcGUocGF0Y2hfc2l6ZSwgQ19vdXQpXG4gICAgaW0yY29sX291dHB1dF9mbGF0ID0gaW0yY29sX21hdHJpeCBAIGZpbHRlcnNfcmVzaGFwZWRcbiAgICBpbTJjb2xfb3V0cHV0ID0gaW0yY29sX291dHB1dF9mbGF0LnJlc2hhcGUob3V0X2gsIG91dF93LCBDX291dClcbiAgICBcbiAgICBwcmludChmXCJcXG5JbTJjb2wgbWF0cml4IHNoYXBlOiB7aW0yY29sX21hdHJpeC5zaGFwZX1cIilcbiAgICBwcmludChmXCJSZXNoYXBlZCBmaWx0ZXJzIHNoYXBlOiB7ZmlsdGVyc19yZXNoYXBlZC5zaGFwZX1cIilcbiAgICBcbiAgICAjIENvbXBhcmUgcmVzdWx0c1xuICAgIGRpZmZlcmVuY2UgPSBucC5saW5hbGcubm9ybShyZWZlcmVuY2Vfb3V0cHV0IC0gaW0yY29sX291dHB1dClcbiAgICBwcmludChmXCJcXG5MMiBub3JtIGRpZmZlcmVuY2UgKHJlZmVyZW5jZSB2cyBpbTJjb2wpOiB7ZGlmZmVyZW5jZX1cIilcbiAgICBcbiAgICBpZiBkaWZmZXJlbmNlIDwgMWUtMTA6XG4gICAgICAgIHByaW50KFwi4pyFIFNVQ0NFU1M6IE11bHRpLWNoYW5uZWwgaW0yY29sIG1hdGNoZXMgcmVmZXJlbmNlIVwiKVxuICAgIGVsc2U6XG4gICAgICAgIHByaW50KFwi4p2MIEVSUk9SOiBNdWx0aS1jaGFubmVsIHJlc3VsdHMgZGlmZmVyXCIpXG4gICAgXG4gICAgcmV0dXJuIHJlZmVyZW5jZV9vdXRwdXQsIGltMmNvbF9vdXRwdXRcblxuIyBSdW4gbXVsdGktY2hhbm5lbCBkZW1vbnN0cmF0aW9uXG5tdWx0aV9jaGFubmVsX2NvbnZvbHV0aW9uKCkifQ==
</script>
</div>
<p>For multi-channel convolution:</p>
<ul>
<li><strong>Input</strong>: <code>[H, W, C_in]</code></li>
<li><strong>Filters</strong>: <code>[K, K, C_in, C_out]</code></li>
<li><strong>Im2col matrix</strong>: <code>[num_windows, K×K×C_in]</code></li>
<li><strong>Reshaped filters</strong>: <code>[K×K×C_in, C_out]</code></li>
<li><strong>Output</strong>: <code>[out_h, out_w, C_out]</code></li>
</ul>
<p>The same im2col principle applies, but now each window includes all input channels, and we can compute all output channels simultaneously.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>We’ve demonstrated the complete evolution from naive convolution to optimized tensor descriptor-based implementation:</p>
<ol type="1">
<li><strong>Naive approach</strong>: Direct mathematical implementation with nested loops</li>
<li><strong>Window extraction</strong>: Using <code>as_strided</code> to create efficient memory views</li>
<li><strong>Tensor descriptors</strong>: Achieving the same with structured transformations</li>
<li><strong>Im2col transformation</strong>: Converting convolution to matrix multiplication</li>
<li><strong>Multi-channel extension</strong>: Scaling to realistic deep learning scenarios</li>
</ol>
<section id="key-insights" class="level3">
<h3 class="anchored" data-anchor-id="key-insights">Key Insights</h3>
<ul>
<li><strong>Memory efficiency</strong>: Tensor descriptors avoid data duplication by creating views</li>
<li><strong>Parallelization</strong>: Im2col enables massive parallelization through matrix multiplication</li>
<li><strong>Generalization</strong>: The tensor descriptor <strong>approach</strong> extends naturally to complex memory patterns</li>
<li><strong>GPU acceleration</strong>: These transformations form the foundation for efficient GPU kernels</li>
</ul>
<p>The tensor descriptor system provides a unified framework for describing these transformations, making it possible to generate efficient code for various hardware architectures automatically. It is also important to note that the tensor descriptor machinary is implmented in compile time C++ code, therefore very efficient. This python implementation is just a simulator to demonstrate the concept.</p>
</section>
<section id="performance-characteristics" class="level3">
<h3 class="anchored" data-anchor-id="performance-characteristics">Performance Characteristics</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Method</th>
<th>Memory Usage</th>
<th>Parallelization</th>
<th>GPU Suitability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Naive loops</td>
<td>Low</td>
<td>Poor</td>
<td>Poor</td>
</tr>
<tr class="even">
<td>As_strided</td>
<td>Medium</td>
<td>Good</td>
<td>Limited</td>
</tr>
<tr class="odd">
<td>Tensor descriptors</td>
<td>Medium</td>
<td>Excellent</td>
<td>Excellent</td>
</tr>
<tr class="even">
<td>Im2col</td>
<td>High</td>
<td>Excellent</td>
<td>Excellent</td>
</tr>
</tbody>
</table>
<p>Tensor descriptors strike the optimal balance: they provide the parallelization benefits of im2col while maintaining the memory efficiency of strided operations, making them ideal for high-performance GPU implementations.</p>


<!-- -->

<script type="pyodide-data">
eyJvcHRpb25zIjp7ImVudiI6eyJQTE9UTFlfUkVOREVSRVIiOiJwbG90bHlfbWltZXR5cGUifSwiaW5kZXhVUkwiOiJodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvcHlvZGlkZS92MC4yNy4wL2Z1bGwvIn0sInBhY2thZ2VzIjp7InBrZ3MiOlsicHlvZGlkZV9odHRwIiwibWljcm9waXAiLCJpcHl0aG9uIiwibnVtcHkiLCJwYW5kYXMiLCJzeW1weSIsIm1pY3JvcGlwIl19fQ==
</script>
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W3siY2VsbE5hbWUiOiJweW9kaWRlLTE1IiwiaW5saW5lIjpmYWxzZSwibWV0aG9kTmFtZSI6ImludGVycHJldCIsInNvdXJjZSI6InZpZXdvZiBfcHlvZGlkZV9lZGl0b3JfMTUgPSB7XG4gIGNvbnN0IHsgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yLCBiNjREZWNvZGUgfSA9IHdpbmRvdy5fZXhlcmNpc2Vfb2pzX3J1bnRpbWU7XG5cbiAgY29uc3Qgc2NyaXB0Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYHNjcmlwdFt0eXBlPVxcXCJweW9kaWRlLTE1LWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtMTUtY29udGVudHNgIH0sIGJsb2NrLmF0dHIpO1xuICBjb25zdCBlZGl0b3IgPSBuZXcgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yKFxuICAgIHB5b2RpZGVPanMucHlvZGlkZVByb21pc2UsXG4gICAgYmxvY2suY29kZSxcbiAgICBvcHRpb25zXG4gICk7XG5cbiAgcmV0dXJuIGVkaXRvci5jb250YWluZXI7XG59XG5fcHlvZGlkZV92YWx1ZV8xNSA9IHB5b2RpZGVPanMucHJvY2VzcyhfcHlvZGlkZV9lZGl0b3JfMTUsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTE0IiwiaW5saW5lIjpmYWxzZSwibWV0aG9kTmFtZSI6ImludGVycHJldCIsInNvdXJjZSI6InZpZXdvZiBfcHlvZGlkZV9lZGl0b3JfMTQgPSB7XG4gIGNvbnN0IHsgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yLCBiNjREZWNvZGUgfSA9IHdpbmRvdy5fZXhlcmNpc2Vfb2pzX3J1bnRpbWU7XG5cbiAgY29uc3Qgc2NyaXB0Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYHNjcmlwdFt0eXBlPVxcXCJweW9kaWRlLTE0LWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtMTQtY29udGVudHNgIH0sIGJsb2NrLmF0dHIpO1xuICBjb25zdCBlZGl0b3IgPSBuZXcgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yKFxuICAgIHB5b2RpZGVPanMucHlvZGlkZVByb21pc2UsXG4gICAgYmxvY2suY29kZSxcbiAgICBvcHRpb25zXG4gICk7XG5cbiAgcmV0dXJuIGVkaXRvci5jb250YWluZXI7XG59XG5fcHlvZGlkZV92YWx1ZV8xNCA9IHB5b2RpZGVPanMucHJvY2VzcyhfcHlvZGlkZV9lZGl0b3JfMTQsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTEzIiwiaW5saW5lIjpmYWxzZSwibWV0aG9kTmFtZSI6ImludGVycHJldCIsInNvdXJjZSI6InZpZXdvZiBfcHlvZGlkZV9lZGl0b3JfMTMgPSB7XG4gIGNvbnN0IHsgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yLCBiNjREZWNvZGUgfSA9IHdpbmRvdy5fZXhlcmNpc2Vfb2pzX3J1bnRpbWU7XG5cbiAgY29uc3Qgc2NyaXB0Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYHNjcmlwdFt0eXBlPVxcXCJweW9kaWRlLTEzLWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtMTMtY29udGVudHNgIH0sIGJsb2NrLmF0dHIpO1xuICBjb25zdCBlZGl0b3IgPSBuZXcgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yKFxuICAgIHB5b2RpZGVPanMucHlvZGlkZVByb21pc2UsXG4gICAgYmxvY2suY29kZSxcbiAgICBvcHRpb25zXG4gICk7XG5cbiAgcmV0dXJuIGVkaXRvci5jb250YWluZXI7XG59XG5fcHlvZGlkZV92YWx1ZV8xMyA9IHB5b2RpZGVPanMucHJvY2VzcyhfcHlvZGlkZV9lZGl0b3JfMTMsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTEyIiwiaW5saW5lIjpmYWxzZSwibWV0aG9kTmFtZSI6ImludGVycHJldCIsInNvdXJjZSI6InZpZXdvZiBfcHlvZGlkZV9lZGl0b3JfMTIgPSB7XG4gIGNvbnN0IHsgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yLCBiNjREZWNvZGUgfSA9IHdpbmRvdy5fZXhlcmNpc2Vfb2pzX3J1bnRpbWU7XG5cbiAgY29uc3Qgc2NyaXB0Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYHNjcmlwdFt0eXBlPVxcXCJweW9kaWRlLTEyLWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtMTItY29udGVudHNgIH0sIGJsb2NrLmF0dHIpO1xuICBjb25zdCBlZGl0b3IgPSBuZXcgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yKFxuICAgIHB5b2RpZGVPanMucHlvZGlkZVByb21pc2UsXG4gICAgYmxvY2suY29kZSxcbiAgICBvcHRpb25zXG4gICk7XG5cbiAgcmV0dXJuIGVkaXRvci5jb250YWluZXI7XG59XG5fcHlvZGlkZV92YWx1ZV8xMiA9IHB5b2RpZGVPanMucHJvY2VzcyhfcHlvZGlkZV9lZGl0b3JfMTIsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTExIiwiaW5saW5lIjpmYWxzZSwibWV0aG9kTmFtZSI6ImludGVycHJldCIsInNvdXJjZSI6InZpZXdvZiBfcHlvZGlkZV9lZGl0b3JfMTEgPSB7XG4gIGNvbnN0IHsgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yLCBiNjREZWNvZGUgfSA9IHdpbmRvdy5fZXhlcmNpc2Vfb2pzX3J1bnRpbWU7XG5cbiAgY29uc3Qgc2NyaXB0Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYHNjcmlwdFt0eXBlPVxcXCJweW9kaWRlLTExLWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtMTEtY29udGVudHNgIH0sIGJsb2NrLmF0dHIpO1xuICBjb25zdCBlZGl0b3IgPSBuZXcgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yKFxuICAgIHB5b2RpZGVPanMucHlvZGlkZVByb21pc2UsXG4gICAgYmxvY2suY29kZSxcbiAgICBvcHRpb25zXG4gICk7XG5cbiAgcmV0dXJuIGVkaXRvci5jb250YWluZXI7XG59XG5fcHlvZGlkZV92YWx1ZV8xMSA9IHB5b2RpZGVPanMucHJvY2VzcyhfcHlvZGlkZV9lZGl0b3JfMTEsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTEwIiwiaW5saW5lIjpmYWxzZSwibWV0aG9kTmFtZSI6ImludGVycHJldCIsInNvdXJjZSI6InZpZXdvZiBfcHlvZGlkZV9lZGl0b3JfMTAgPSB7XG4gIGNvbnN0IHsgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yLCBiNjREZWNvZGUgfSA9IHdpbmRvdy5fZXhlcmNpc2Vfb2pzX3J1bnRpbWU7XG5cbiAgY29uc3Qgc2NyaXB0Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYHNjcmlwdFt0eXBlPVxcXCJweW9kaWRlLTEwLWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtMTAtY29udGVudHNgIH0sIGJsb2NrLmF0dHIpO1xuICBjb25zdCBlZGl0b3IgPSBuZXcgUHlvZGlkZUV4ZXJjaXNlRWRpdG9yKFxuICAgIHB5b2RpZGVPanMucHlvZGlkZVByb21pc2UsXG4gICAgYmxvY2suY29kZSxcbiAgICBvcHRpb25zXG4gICk7XG5cbiAgcmV0dXJuIGVkaXRvci5jb250YWluZXI7XG59XG5fcHlvZGlkZV92YWx1ZV8xMCA9IHB5b2RpZGVPanMucHJvY2VzcyhfcHlvZGlkZV9lZGl0b3JfMTAsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTkiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoidmlld29mIF9weW9kaWRlX2VkaXRvcl85ID0ge1xuICBjb25zdCB7IFB5b2RpZGVFeGVyY2lzZUVkaXRvciwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS05LWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtOS1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBQeW9kaWRlRXhlcmNpc2VFZGl0b3IoXG4gICAgcHlvZGlkZU9qcy5weW9kaWRlUHJvbWlzZSxcbiAgICBibG9jay5jb2RlLFxuICAgIG9wdGlvbnNcbiAgKTtcblxuICByZXR1cm4gZWRpdG9yLmNvbnRhaW5lcjtcbn1cbl9weW9kaWRlX3ZhbHVlXzkgPSBweW9kaWRlT2pzLnByb2Nlc3MoX3B5b2RpZGVfZWRpdG9yXzksIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTgiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoidmlld29mIF9weW9kaWRlX2VkaXRvcl84ID0ge1xuICBjb25zdCB7IFB5b2RpZGVFeGVyY2lzZUVkaXRvciwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS04LWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtOC1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBQeW9kaWRlRXhlcmNpc2VFZGl0b3IoXG4gICAgcHlvZGlkZU9qcy5weW9kaWRlUHJvbWlzZSxcbiAgICBibG9jay5jb2RlLFxuICAgIG9wdGlvbnNcbiAgKTtcblxuICByZXR1cm4gZWRpdG9yLmNvbnRhaW5lcjtcbn1cbl9weW9kaWRlX3ZhbHVlXzggPSBweW9kaWRlT2pzLnByb2Nlc3MoX3B5b2RpZGVfZWRpdG9yXzgsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTciLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoidmlld29mIF9weW9kaWRlX2VkaXRvcl83ID0ge1xuICBjb25zdCB7IFB5b2RpZGVFeGVyY2lzZUVkaXRvciwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS03LWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtNy1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBQeW9kaWRlRXhlcmNpc2VFZGl0b3IoXG4gICAgcHlvZGlkZU9qcy5weW9kaWRlUHJvbWlzZSxcbiAgICBibG9jay5jb2RlLFxuICAgIG9wdGlvbnNcbiAgKTtcblxuICByZXR1cm4gZWRpdG9yLmNvbnRhaW5lcjtcbn1cbl9weW9kaWRlX3ZhbHVlXzcgPSBweW9kaWRlT2pzLnByb2Nlc3MoX3B5b2RpZGVfZWRpdG9yXzcsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTYiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoidmlld29mIF9weW9kaWRlX2VkaXRvcl82ID0ge1xuICBjb25zdCB7IFB5b2RpZGVFeGVyY2lzZUVkaXRvciwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS02LWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtNi1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBQeW9kaWRlRXhlcmNpc2VFZGl0b3IoXG4gICAgcHlvZGlkZU9qcy5weW9kaWRlUHJvbWlzZSxcbiAgICBibG9jay5jb2RlLFxuICAgIG9wdGlvbnNcbiAgKTtcblxuICByZXR1cm4gZWRpdG9yLmNvbnRhaW5lcjtcbn1cbl9weW9kaWRlX3ZhbHVlXzYgPSBweW9kaWRlT2pzLnByb2Nlc3MoX3B5b2RpZGVfZWRpdG9yXzYsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTUiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoidmlld29mIF9weW9kaWRlX2VkaXRvcl81ID0ge1xuICBjb25zdCB7IFB5b2RpZGVFeGVyY2lzZUVkaXRvciwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS01LWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtNS1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBQeW9kaWRlRXhlcmNpc2VFZGl0b3IoXG4gICAgcHlvZGlkZU9qcy5weW9kaWRlUHJvbWlzZSxcbiAgICBibG9jay5jb2RlLFxuICAgIG9wdGlvbnNcbiAgKTtcblxuICByZXR1cm4gZWRpdG9yLmNvbnRhaW5lcjtcbn1cbl9weW9kaWRlX3ZhbHVlXzUgPSBweW9kaWRlT2pzLnByb2Nlc3MoX3B5b2RpZGVfZWRpdG9yXzUsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTQiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoidmlld29mIF9weW9kaWRlX2VkaXRvcl80ID0ge1xuICBjb25zdCB7IFB5b2RpZGVFeGVyY2lzZUVkaXRvciwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS00LWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtNC1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBQeW9kaWRlRXhlcmNpc2VFZGl0b3IoXG4gICAgcHlvZGlkZU9qcy5weW9kaWRlUHJvbWlzZSxcbiAgICBibG9jay5jb2RlLFxuICAgIG9wdGlvbnNcbiAgKTtcblxuICByZXR1cm4gZWRpdG9yLmNvbnRhaW5lcjtcbn1cbl9weW9kaWRlX3ZhbHVlXzQgPSBweW9kaWRlT2pzLnByb2Nlc3MoX3B5b2RpZGVfZWRpdG9yXzQsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTMiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoidmlld29mIF9weW9kaWRlX2VkaXRvcl8zID0ge1xuICBjb25zdCB7IFB5b2RpZGVFeGVyY2lzZUVkaXRvciwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS0zLWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtMy1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBQeW9kaWRlRXhlcmNpc2VFZGl0b3IoXG4gICAgcHlvZGlkZU9qcy5weW9kaWRlUHJvbWlzZSxcbiAgICBibG9jay5jb2RlLFxuICAgIG9wdGlvbnNcbiAgKTtcblxuICByZXR1cm4gZWRpdG9yLmNvbnRhaW5lcjtcbn1cbl9weW9kaWRlX3ZhbHVlXzMgPSBweW9kaWRlT2pzLnByb2Nlc3MoX3B5b2RpZGVfZWRpdG9yXzMsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTIiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoidmlld29mIF9weW9kaWRlX2VkaXRvcl8yID0ge1xuICBjb25zdCB7IFB5b2RpZGVFeGVyY2lzZUVkaXRvciwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS0yLWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtMi1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBQeW9kaWRlRXhlcmNpc2VFZGl0b3IoXG4gICAgcHlvZGlkZU9qcy5weW9kaWRlUHJvbWlzZSxcbiAgICBibG9jay5jb2RlLFxuICAgIG9wdGlvbnNcbiAgKTtcblxuICByZXR1cm4gZWRpdG9yLmNvbnRhaW5lcjtcbn1cbl9weW9kaWRlX3ZhbHVlXzIgPSBweW9kaWRlT2pzLnByb2Nlc3MoX3B5b2RpZGVfZWRpdG9yXzIsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTEiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoiX3B5b2RpZGVfdmFsdWVfMSA9IHtcbiAgY29uc3QgeyBoaWdobGlnaHRQeXRob24sIGI2NERlY29kZX0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS0xLWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgLy8gRGVmYXVsdCBldmFsdWF0aW9uIGNvbmZpZ3VyYXRpb25cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe1xuICAgIGlkOiBcInB5b2RpZGUtMS1jb250ZW50c1wiLFxuICAgIGVjaG86IHRydWUsXG4gICAgb3V0cHV0OiB0cnVlXG4gIH0sIGJsb2NrLmF0dHIpO1xuXG4gIC8vIEV2YWx1YXRlIHRoZSBwcm92aWRlZCBQeXRob24gY29kZVxuICBjb25zdCByZXN1bHQgPSBweW9kaWRlT2pzLnByb2Nlc3Moe2NvZGU6IGJsb2NrLmNvZGUsIG9wdGlvbnN9LCB7fSk7XG5cbiAgLy8gRWFybHkgeWllbGQgd2hpbGUgd2Ugd2FpdCBmb3IgdGhlIGZpcnN0IGV2YWx1YXRpb24gYW5kIHJlbmRlclxuICBpZiAob3B0aW9ucy5vdXRwdXQgJiYgIShcIjFcIiBpbiBweW9kaWRlT2pzLnJlbmRlcmVkT2pzKSkge1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgY29uc3Qgc3Bpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG5cbiAgICBpZiAob3B0aW9ucy5lY2hvKSB7XG4gICAgICAvLyBTaG93IG91dHB1dCBhcyBoaWdobGlnaHRlZCBzb3VyY2VcbiAgICAgIGNvbnN0IHByZUVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwicHJlXCIpO1xuICAgICAgY29udGFpbmVyLmNsYXNzTmFtZSA9IFwic291cmNlQ29kZVwiO1xuICAgICAgcHJlRWxlbS5jbGFzc05hbWUgPSBcInNvdXJjZUNvZGUgcHl0aG9uXCI7XG4gICAgICBwcmVFbGVtLmFwcGVuZENoaWxkKGhpZ2hsaWdodFB5dGhvbihibG9jay5jb2RlKSk7XG4gICAgICBzcGlubmVyLmNsYXNzTmFtZSA9IFwic3Bpbm5lci1ncm93IHNwaW5uZXItZ3Jvdy1zbSBtLTIgcG9zaXRpb24tYWJzb2x1dGUgdG9wLTAgZW5kLTBcIjtcbiAgICAgIHByZUVsZW0uYXBwZW5kQ2hpbGQoc3Bpbm5lcik7XG4gICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQocHJlRWxlbSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNwaW5uZXIuY2xhc3NOYW1lID0gXCJzcGlubmVyLWJvcmRlciBzcGlubmVyLWJvcmRlci1zbVwiO1xuICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHNwaW5uZXIpO1xuICAgIH1cblxuICAgIHlpZWxkIGNvbnRhaW5lcjtcbiAgfVxuXG4gIHB5b2RpZGVPanMucmVuZGVyZWRPanNbXCIxXCJdID0gdHJ1ZTtcbiAgeWllbGQgYXdhaXQgcmVzdWx0O1xufVxuIn0seyJjZWxsTmFtZSI6InB5b2RpZGUtcHJlbHVkZSIsImlubGluZSI6ZmFsc2UsIm1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InB5b2RpZGVPanMgPSB7XG4gIGNvbnN0IHtcbiAgICBQeW9kaWRlRXZhbHVhdG9yLFxuICAgIFB5b2RpZGVFbnZpcm9ubWVudE1hbmFnZXIsXG4gICAgc2V0dXBQeXRob24sXG4gICAgc3RhcnRQeW9kaWRlV29ya2VyLFxuICAgIGI2NERlY29kZSxcbiAgICBjb2xsYXBzZVBhdGgsXG4gIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHN0YXR1c0NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZXhlcmNpc2UtbG9hZGluZy1zdGF0dXNcIik7XG4gIGNvbnN0IGluZGljYXRvckNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZXhlcmNpc2UtbG9hZGluZy1pbmRpY2F0b3JcIik7XG4gIGluZGljYXRvckNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKFwiZC1ub25lXCIpO1xuXG4gIGxldCBzdGF0dXNUZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKVxuICBzdGF0dXNUZXh0LmNsYXNzTGlzdCA9IFwiZXhlcmNpc2UtbG9hZGluZy1kZXRhaWxzXCI7XG4gIHN0YXR1c1RleHQgPSBzdGF0dXNDb250YWluZXIuYXBwZW5kQ2hpbGQoc3RhdHVzVGV4dCk7XG4gIHN0YXR1c1RleHQudGV4dENvbnRlbnQgPSBgSW5pdGlhbGlzZWA7XG5cbiAgLy8gSG9pc3QgaW5kaWNhdG9yIG91dCBmcm9tIGZpbmFsIHNsaWRlIHdoZW4gcnVubmluZyB1bmRlciByZXZlYWxcbiAgY29uc3QgcmV2ZWFsU3RhdHVzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5yZXZlYWwgLmV4ZXJjaXNlLWxvYWRpbmctaW5kaWNhdG9yXCIpO1xuICBpZiAocmV2ZWFsU3RhdHVzKSB7XG4gICAgcmV2ZWFsU3RhdHVzLnJlbW92ZSgpO1xuICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucmV2ZWFsID4gLnNsaWRlc1wiKS5hcHBlbmRDaGlsZChyZXZlYWxTdGF0dXMpO1xuICB9XG5cbiAgLy8gTWFrZSBhbnkgcmV2ZWFsIHNsaWRlcyB3aXRoIGxpdmUgY2VsbHMgc2Nyb2xsYWJsZVxuICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLnJldmVhbCAuZXhlcmNpc2UtY2VsbFwiKS5mb3JFYWNoKChlbCkgPT4ge1xuICAgIGVsLmNsb3Nlc3QoJ3NlY3Rpb24uc2xpZGUnKS5jbGFzc0xpc3QuYWRkKFwic2Nyb2xsYWJsZVwiKTtcbiAgfSlcblxuICAvLyBQeW9kaWRlIHN1cHBsZW1lbnRhbCBkYXRhIGFuZCBvcHRpb25zXG4gIGNvbnN0IGRhdGFDb250ZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihgc2NyaXB0W3R5cGU9XFxcInB5b2RpZGUtZGF0YVxcXCJdYCkudGV4dENvbnRlbnQ7XG4gIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGI2NERlY29kZShkYXRhQ29udGVudCkpO1xuXG4gIC8vIEdyYWIgbGlzdCBvZiByZXNvdXJjZXMgdG8gYmUgZG93bmxvYWRlZFxuICBjb25zdCBmaWxlc0NvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwidmZzLWZpbGVcXFwiXWApLnRleHRDb250ZW50O1xuICBjb25zdCBmaWxlcyA9IEpTT04ucGFyc2UoYjY0RGVjb2RlKGZpbGVzQ29udGVudCkpO1xuXG4gIGxldCBweW9kaWRlUHJvbWlzZSA9IChhc3luYyAoKSA9PiB7XG4gICAgc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9IGBEb3dubG9hZGluZyBQeW9kaWRlYDtcbiAgICBjb25zdCBweW9kaWRlID0gYXdhaXQgc3RhcnRQeW9kaWRlV29ya2VyKGRhdGEub3B0aW9ucyk7XG5cbiAgICBzdGF0dXNUZXh0LnRleHRDb250ZW50ID0gYERvd25sb2FkaW5nIHBhY2thZ2U6IG1pY3JvcGlwYDtcbiAgICBhd2FpdCBweW9kaWRlLmxvYWRQYWNrYWdlKFwibWljcm9waXBcIik7XG4gICAgY29uc3QgbWljcm9waXAgPSBhd2FpdCBweW9kaWRlLnB5aW1wb3J0KFwibWljcm9waXBcIik7XG4gICAgYXdhaXQgZGF0YS5wYWNrYWdlcy5wa2dzLm1hcCgocGtnKSA9PiAoKSA9PiB7XG4gICAgICBzdGF0dXNUZXh0LnRleHRDb250ZW50ID0gYERvd25sb2FkaW5nIHBhY2thZ2U6ICR7cGtnfWA7XG4gICAgICByZXR1cm4gbWljcm9waXAuaW5zdGFsbChwa2cpO1xuICAgIH0pLnJlZHVjZSgoY3VyLCBuZXh0KSA9PiBjdXIudGhlbihuZXh0KSwgUHJvbWlzZS5yZXNvbHZlKCkpO1xuICAgIGF3YWl0IG1pY3JvcGlwLmRlc3Ryb3koKTtcblxuICAgIC8vIERvd25sb2FkIGFuZCBpbnN0YWxsIHJlc291cmNlc1xuICAgIGF3YWl0IGZpbGVzLm1hcCgoZmlsZSkgPT4gYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbmFtZSA9IGZpbGUuc3Vic3RyaW5nKGZpbGUubGFzdEluZGV4T2YoJy8nKSArIDEpO1xuICAgICAgc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9IGBEb3dubG9hZGluZyByZXNvdXJjZTogJHtuYW1lfWA7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGZpbGUpO1xuICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbid0IGRvd25sb2FkIFxcYCR7ZmlsZX1cXGAuIEVycm9yICR7cmVzcG9uc2Uuc3RhdHVzfTogXCIke3Jlc3BvbnNlLnN0YXR1c1RleHR9XCIuYCk7XG4gICAgICB9XG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuYXJyYXlCdWZmZXIoKTtcblxuICAgICAgLy8gU3RvcmUgVVJMcyBpbiB0aGUgY3dkIHdpdGhvdXQgYW55IHN1YmRpcmVjdG9yeSBzdHJ1Y3R1cmVcbiAgICAgIGlmIChmaWxlLmluY2x1ZGVzKFwiOi8vXCIpKSB7XG4gICAgICAgIGZpbGUgPSBuYW1lO1xuICAgICAgfVxuXG4gICAgICAvLyBDb2xsYXBzZSBoaWdoZXIgZGlyZWN0b3J5IHN0cnVjdHVyZVxuICAgICAgZmlsZSA9IGNvbGxhcHNlUGF0aChmaWxlKTtcblxuICAgICAgLy8gQ3JlYXRlIGRpcmVjdG9yeSB0cmVlLCBpZ25vcmluZyBcImRpcmVjdG9yeSBleGlzdHNcIiBWRlMgZXJyb3JzXG4gICAgICBjb25zdCBwYXJ0cyA9IGZpbGUuc3BsaXQoJy8nKS5zbGljZSgwLCAtMSk7XG4gICAgICBsZXQgcGF0aCA9ICcnO1xuICAgICAgd2hpbGUgKHBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcGF0aCArPSBwYXJ0cy5zaGlmdCgpICsgJy8nO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHB5b2RpZGUuRlMubWtkaXIocGF0aCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBpZiAoZS5uYW1lICE9PSBcIkVycm5vRXJyb3JcIikgdGhyb3cgZTtcbiAgICAgICAgICBpZiAoZS5lcnJubyAhPT0gMjApIHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yVGV4dFB0ciA9IGF3YWl0IHB5b2RpZGUuX21vZHVsZS5fc3RyZXJyb3IoZS5lcnJubyk7XG4gICAgICAgICAgICBjb25zdCBlcnJvclRleHQgPSBhd2FpdCBweW9kaWRlLl9tb2R1bGUuVVRGOFRvU3RyaW5nKGVycm9yVGV4dFB0cik7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpbGVzeXN0ZW0gRXJyb3IgJHtlLmVycm5vfSBcIiR7ZXJyb3JUZXh0fVwiLmApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBXcml0ZSB0aGlzIGZpbGUgdG8gdGhlIFZGU1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHB5b2RpZGUuRlMud3JpdGVGaWxlKGZpbGUsIG5ldyBVaW50OEFycmF5KGRhdGEpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGUubmFtZSAhPT0gXCJFcnJub0Vycm9yXCIpIHRocm93IGU7XG4gICAgICAgIGNvbnN0IGVycm9yVGV4dFB0ciA9IGF3YWl0IHB5b2RpZGUuX21vZHVsZS5fc3RyZXJyb3IoZS5lcnJubyk7XG4gICAgICAgIGNvbnN0IGVycm9yVGV4dCA9IGF3YWl0IHB5b2RpZGUuX21vZHVsZS5VVEY4VG9TdHJpbmcoZXJyb3JUZXh0UHRyKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlc3lzdGVtIEVycm9yICR7ZS5lcnJub30gXCIke2Vycm9yVGV4dH1cIi5gKTtcbiAgICAgIH1cbiAgICB9KS5yZWR1Y2UoKGN1ciwgbmV4dCkgPT4gY3VyLnRoZW4obmV4dCksIFByb21pc2UucmVzb2x2ZSgpKTtcblxuICAgIHN0YXR1c1RleHQudGV4dENvbnRlbnQgPSBgUHlvZGlkZSBlbnZpcm9ubWVudCBzZXR1cGA7XG4gICAgYXdhaXQgc2V0dXBQeXRob24ocHlvZGlkZSk7XG5cbiAgICBzdGF0dXNUZXh0LnJlbW92ZSgpO1xuICAgIGlmIChzdGF0dXNDb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID09IDApIHtcbiAgICAgIHN0YXR1c0NvbnRhaW5lci5wYXJlbnROb2RlLnJlbW92ZSgpO1xuICAgIH1cbiAgICByZXR1cm4gcHlvZGlkZTtcbiAgfSkoKS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgc3RhdHVzVGV4dC5zdHlsZS5jb2xvciA9IFwidmFyKC0tZXhlcmNpc2UtZWRpdG9yLWhsLWVyLCAjQUQwMDAwKVwiO1xuICAgIHN0YXR1c1RleHQudGV4dENvbnRlbnQgPSBlcnIubWVzc2FnZTtcbiAgICAvL2luZGljYXRvckNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKFwiLnNwaW5uZXItZ3Jvd1wiKS5jbGFzc0xpc3QuYWRkKFwiZC1ub25lXCIpO1xuICAgIHRocm93IGVycjtcbiAgfSk7XG5cbiAgLy8gS2VlcCB0cmFjayBvZiBpbml0aWFsIE9KUyBibG9jayByZW5kZXJcbiAgY29uc3QgcmVuZGVyZWRPanMgPSB7fTtcblxuICBjb25zdCBwcm9jZXNzID0gYXN5bmMgKGNvbnRleHQsIGlucHV0cykgPT4ge1xuICAgIGNvbnN0IHB5b2RpZGUgPSBhd2FpdCBweW9kaWRlUHJvbWlzZTtcbiAgICBjb25zdCBldmFsdWF0b3IgPSBuZXcgUHlvZGlkZUV2YWx1YXRvcihweW9kaWRlLCBjb250ZXh0KTtcbiAgICBhd2FpdCBldmFsdWF0b3IucHJvY2VzcyhpbnB1dHMpO1xuICAgIHJldHVybiBldmFsdWF0b3IuY29udGFpbmVyO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBweW9kaWRlUHJvbWlzZSxcbiAgICByZW5kZXJlZE9qcyxcbiAgICBwcm9jZXNzLFxuICB9O1xufVxuIn1dfQ==
</script>
<div id="exercise-loading-indicator" class="exercise-loading-indicator d-none d-flex align-items-center gap-2">
<div id="exercise-loading-status" class="d-flex gap-2">

</div>
<div class="spinner-grow spinner-grow-sm">

</div>
</div>
<script type="vfs-file">
W10=
</script>
</section>
</section>
</section>

</main> <!-- /main -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W119
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../../concepts";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb1" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Convolution Implementation with Tensor Descriptors"</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> live-html</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>This chapter demonstrates a practical application of tensor descriptors by implementing convolution operations. We'll progress from a naive implementation to an optimized approach using tensor descriptors, showing how they enable efficient memory access patterns for GPU acceleration. First we show how we can achieve the results using numpy implementation.</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>The convolution operation is fundamental in deep learning, and understanding its implementation details reveals how high-performance libraries achieve their efficiency. We'll explore:</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Naive Implementation**: Direct nested loops for reference</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Window Extraction**: Using NumPy's <span class="in">`as_strided`</span> for overlapping windows</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Tensor Descriptor Windows**: Achieving the same with tensor descriptors</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Im2col Transformation**: Converting convolution to matrix multiplication</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Multi-channel Extension**: Handling realistic deep learning scenarios</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;div class="mermaid"&gt;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="in">graph TB</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph "Convolution Process"</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="in">        I["Input Image&lt;br/&gt;6×6"]</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="in">        K["Kernel&lt;br/&gt;3×3"]</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="in">        SW["Sliding Window&lt;br/&gt;Extract 3×3 patches"]</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="in">        DP["Dot Product&lt;br/&gt;Element-wise multiply &amp; sum"]</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="in">        O["Output&lt;br/&gt;4×4"]</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph "Im2col Optimization"</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="in">        W["Windows Matrix&lt;br/&gt;16×9&lt;br/&gt;(all patches)"]</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="in">        KF["Kernel Flattened&lt;br/&gt;9×1"]</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="in">        MM["Matrix Multiply&lt;br/&gt;W @ K"]</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="in">        OF["Output Flattened&lt;br/&gt;16×1"]</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="in">    I --&gt; SW</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="in">    K --&gt; DP</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="in">    SW --&gt; DP</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="in">    DP --&gt; O</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="in">    SW --&gt; W</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="in">    K --&gt; KF</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="in">    W --&gt; MM</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="in">    KF --&gt; MM</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="in">    MM --&gt; OF</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="in">    OF --&gt; O</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="in">    style I fill:#e3f2fd,stroke:#1976d2,stroke-width:2px</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="in">    style O fill:#e8f5e9,stroke:#388e3c,stroke-width:2px</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="in">    style MM fill:#fff3e0,stroke:#f57c00,stroke-width:2px</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/div&gt;</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup and Test Data</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="co">#| autorun: true</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Auto-install pythonck package</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> micropip</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> micropip.install(<span class="st">"https://raw.githubusercontent.com/ghamarian/pythonck/master/documentation/pythonck-0.1.0-py3-none-any.whl"</span>)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Import all required modules</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytensor.tensor_descriptor <span class="im">import</span> (</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    make_naive_tensor_descriptor,</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    make_naive_tensor_descriptor_packed,</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    make_naive_tensor_descriptor_aligned,</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    transform_tensor_descriptor,</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    PassThroughTransform,</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    UnmergeTransform,</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    MergeTransform, </span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    make_merge_transform,</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    EmbedTransform,</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    MultiIndex</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_test_data():</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create test data for convolution examples."""</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6x6 input image with sequential numbers (easier to follow)</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> np.arange(<span class="dv">1</span>, <span class="dv">37</span>).reshape(<span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Random 3x3 kernel for more interesting output</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)  <span class="co"># For reproducible results</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>    kernel <span class="op">=</span> np.random.randint(<span class="op">-</span><span class="dv">2</span>, <span class="dv">3</span>, (<span class="dv">3</span>, <span class="dv">3</span>))</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image, kernel</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_matrix(matrix, title<span class="op">=</span><span class="st">"Matrix"</span>):</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Print a matrix in a nice format."""</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title:</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(matrix.shape) <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> row <span class="kw">in</span> matrix:</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">" "</span>.join(<span class="ss">f"</span><span class="sc">{</span>val<span class="sc">:3.0f}</span><span class="ss">"</span> <span class="cf">if</span> <span class="bu">abs</span>(val <span class="op">-</span> <span class="bu">round</span>(val)) <span class="op">&lt;</span> <span class="fl">1e-10</span> <span class="cf">else</span> <span class="ss">f"</span><span class="sc">{</span>val<span class="sc">:3.1f}</span><span class="ss">"</span> </span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>                          <span class="cf">for</span> val <span class="kw">in</span> row))</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Shape: </span><span class="sc">{</span>matrix<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(matrix)</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_windows_tiled(windows, title<span class="op">=</span><span class="st">"Windows Tiled View"</span>):</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Print 4D windows tensor as a tiled 2D layout with spacing."""</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title:</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>    out_h, out_w, K, K <span class="op">=</span> windows.shape</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create separator patterns</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Each number takes 3 chars, separated by spaces, so K numbers = 3*K + (K-1) chars</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>    window_width <span class="op">=</span> <span class="dv">3</span> <span class="op">*</span> K <span class="op">+</span> (K <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>    row_sep <span class="op">=</span> <span class="st">"-"</span> <span class="op">*</span> window_width</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>    col_sep <span class="op">=</span> <span class="st">" | "</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> window_row <span class="kw">in</span> <span class="bu">range</span>(out_h):</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print each row of windows</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k_row <span class="kw">in</span> <span class="bu">range</span>(K):</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>            line_parts <span class="op">=</span> []</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> window_col <span class="kw">in</span> <span class="bu">range</span>(out_w):</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>                window_data <span class="op">=</span> <span class="st">" "</span>.join(<span class="ss">f"</span><span class="sc">{</span>val<span class="sc">:3.0f}</span><span class="ss">"</span> <span class="cf">for</span> val <span class="kw">in</span> windows[window_row, window_col, k_row, :])</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>                line_parts.append(window_data)</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(col_sep.join(line_parts))</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print horizontal separator between window rows (except after last row)</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> window_row <span class="op">&lt;</span> out_h <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create separator that aligns with the | characters in content lines</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Content uses " | " so separator should use " + "</span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>            sep_parts <span class="op">=</span> [row_sep] <span class="op">*</span> out_w</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>            sep_line <span class="op">=</span> (<span class="st">" + "</span>).join(sep_parts)</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(sep_line)</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()  <span class="co"># Empty line for spacing</span></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a><span class="co"># Create our test data</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>image, kernel <span class="op">=</span> create_test_data()</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>print_matrix(image, <span class="st">"6×6 Input Image"</span>)</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>print_matrix(kernel, <span class="st">"3×3 Kernel (Edge Detection)"</span>)</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a><span class="fu">## Understanding as_strided: Simple Tiling First</span></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>Before diving into convolution, let's understand how <span class="in">`as_strided`</span> works with a simple example. We'll start by tiling our matrix into non-overlapping blocks.</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> demonstrate_simple_tiling():</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate simple tiling with as_strided (no overlap)."""</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> numpy.lib.stride_tricks <span class="im">import</span> as_strided</span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a simple 6x6 matrix</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>    matrix <span class="op">=</span> np.arange(<span class="dv">1</span>, <span class="dv">37</span>).reshape(<span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>    print_matrix(matrix, <span class="st">"Original 6×6 Matrix"</span>)</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tile into 2x2 blocks (no overlap)</span></span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>    tile_size <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>    matrix_h, matrix_w <span class="op">=</span> matrix.shape</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>    num_tiles_h <span class="op">=</span> matrix_h <span class="op">//</span> tile_size</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>    num_tiles_w <span class="op">=</span> matrix_w <span class="op">//</span> tile_size</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Tiling into </span><span class="sc">{</span>num_tiles_h<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>num_tiles_w<span class="sc">}</span><span class="ss"> tiles of size </span><span class="sc">{</span>tile_size<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>tile_size<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Original strides: </span><span class="sc">{</span>matrix<span class="sc">.</span>strides<span class="sc">}</span><span class="ss"> (bytes per step)"</span>)</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate new strides for tiling</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># To move to next tile vertically: jump tile_size rows</span></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>    <span class="co"># To move to next tile horizontally: jump tile_size columns  </span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Within tile: use original strides</span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>    tiles <span class="op">=</span> as_strided(</span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>        matrix,</span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>        shape<span class="op">=</span>(num_tiles_h, num_tiles_w, tile_size, tile_size),</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>        strides<span class="op">=</span>(matrix.strides[<span class="dv">0</span>] <span class="op">*</span> tile_size, matrix.strides[<span class="dv">1</span>] <span class="op">*</span> tile_size, </span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>                matrix.strides[<span class="dv">0</span>], matrix.strides[<span class="dv">1</span>])</span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Tiles shape: </span><span class="sc">{</span>tiles<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"New strides: </span><span class="sc">{</span>tiles<span class="sc">.</span>strides<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Stride calculation:"</span>)</span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - Move to next tile row: </span><span class="sc">{</span>matrix<span class="sc">.</span>strides[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> × </span><span class="sc">{</span>tile_size<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>matrix<span class="sc">.</span>strides[<span class="dv">0</span>] <span class="op">*</span> tile_size<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - Move to next tile col: </span><span class="sc">{</span>matrix<span class="sc">.</span>strides[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> × </span><span class="sc">{</span>tile_size<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>matrix<span class="sc">.</span>strides[<span class="dv">1</span>] <span class="op">*</span> tile_size<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - Within tile row: </span><span class="sc">{</span>matrix<span class="sc">.</span>strides[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> (original)"</span>)</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - Within tile col: </span><span class="sc">{</span>matrix<span class="sc">.</span>strides[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> (original)"</span>)</span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tiles</span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate simple tiling</span></span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>tiles <span class="op">=</span> demonstrate_simple_tiling()</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Show all tiles in tiled layout</span></span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>print_windows_tiled(tiles, <span class="st">"All 2×2 Tiles in Tiled Layout"</span>)</span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding Strides</span></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>The key insight is understanding **strides** - how many bytes to skip to move to the next element in each dimension:</span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Original matrix**: <span class="in">`shape=(6, 6)`</span>, <span class="in">`strides=(48, 8)`</span> (8 bytes per int64, 6 elements per row)</span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Tiled view**: <span class="in">`shape=(3, 3, 2, 2)`</span>, <span class="in">`strides=(96, 16, 48, 8)`</span></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>To move to next tile row: skip 2 matrix rows = <span class="in">`48 × 2 = 96`</span> bytes</span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>To move to next tile col: skip 2 matrix cols = <span class="in">`8 × 2 = 16`</span> bytes  </span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Within tile: use original strides <span class="in">`(48, 8)`</span></span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overlapping Windows with as_strided</span></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>Now let's see how to create overlapping windows - the foundation of convolution:</span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> demonstrate_overlapping_windows():</span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate overlapping windows with as_strided."""</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> numpy.lib.stride_tricks <span class="im">import</span> as_strided</span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use our test image</span></span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>    image, _ <span class="op">=</span> create_test_data()</span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>    print_matrix(image, <span class="st">"6×6 Input Image"</span>)</span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract 3x3 overlapping windows</span></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> <span class="dv">3</span>  <span class="co"># kernel size</span></span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>    H, W <span class="op">=</span> image.shape</span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>    out_h, out_w <span class="op">=</span> H <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span>, W <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Extracting </span><span class="sc">{</span>K<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>K<span class="sc">}</span><span class="ss"> overlapping windows"</span>)</span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Output positions: </span><span class="sc">{</span>out_h<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>out_w<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>out_h <span class="op">*</span> out_w<span class="sc">}</span><span class="ss"> windows"</span>)</span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Original strides: </span><span class="sc">{</span>image<span class="sc">.</span>strides<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For overlapping windows, we move by 1 element (not tile_size)</span></span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>    <span class="co"># But within each window, we still use original strides</span></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>    windows <span class="op">=</span> as_strided(</span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>        image,</span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>        shape<span class="op">=</span>(out_h, out_w, K, K),</span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>        strides<span class="op">=</span>(image.strides[<span class="dv">0</span>], image.strides[<span class="dv">1</span>], image.strides[<span class="dv">0</span>], image.strides[<span class="dv">1</span>])</span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Windows shape: </span><span class="sc">{</span>windows<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"New strides: </span><span class="sc">{</span>windows<span class="sc">.</span>strides<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Stride meaning:"</span>)</span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - Move to next window row: </span><span class="sc">{</span>image<span class="sc">.</span>strides[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> (1 row down)"</span>)</span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - Move to next window col: </span><span class="sc">{</span>image<span class="sc">.</span>strides[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> (1 col right)"</span>)</span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - Within window row: </span><span class="sc">{</span>image<span class="sc">.</span>strides[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> (1 row down)"</span>)</span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - Within window col: </span><span class="sc">{</span>image<span class="sc">.</span>strides[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> (1 col right)"</span>)</span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> windows</span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate overlapping windows</span></span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a>windows <span class="op">=</span> demonstrate_overlapping_windows()</span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a><span class="co"># Show all overlapping windows in tiled layout</span></span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>print_windows_tiled(windows, <span class="st">"All 3×3 Overlapping Windows in Tiled Layout"</span>)</span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Notice the overlap - adjacent windows share columns and rows!"</span>)</span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key Difference: Overlap vs No Overlap</span></span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Non-overlapping tiles**: We skip by <span class="in">`tile_size`</span> in strides: <span class="in">`(stride[0] * tile_size, stride[1] * tile_size, ...)`</span></span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Overlapping windows**: We skip by <span class="in">`1`</span> in strides: <span class="in">`(stride[0] * 1, stride[1] * 1, ...)`</span></span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>This creates sliding windows that overlap, which is exactly what we need for convolution!</span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a><span class="fu">## 1. Naive Convolution Reference</span></span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>Let's start with the most straightforward implementation using nested loops:</span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> naive_convolution_2d(image, kernel):</span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Reference implementation: naive 2D convolution with nested loops."""</span></span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>    H, W <span class="op">=</span> image.shape</span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> kernel.shape[<span class="dv">0</span>]  <span class="co"># Assume square kernel</span></span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>    out_h, out_w <span class="op">=</span> H <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span>, W <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> np.zeros((out_h, out_w))</span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Input shape: </span><span class="sc">{</span>image<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Kernel shape: </span><span class="sc">{</span>kernel<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Output shape: </span><span class="sc">{</span>output<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(out_h):</span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(out_w):</span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract window</span></span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a>            window <span class="op">=</span> image[i:i<span class="op">+</span>K, j:j<span class="op">+</span>K]</span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Apply convolution</span></span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a>            output[i, j] <span class="op">=</span> np.<span class="bu">sum</span>(window <span class="op">*</span> kernel)</span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> output</span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a><span class="co"># Run naive convolution</span></span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>reference_output <span class="op">=</span> naive_convolution_2d(image, kernel)</span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a>print_matrix(reference_output, <span class="st">"Naive Convolution Output"</span>)</span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>This implementation directly follows the mathematical definition of convolution. For each output position, we extract the corresponding window from the input image and compute the element-wise product with the kernel.</span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2. Window Extraction with NumPy as_strided</span></span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a>Now let's apply what we learned about overlapping windows to convolution. We need to extract all 3×3 windows for convolution:</span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-312"><a href="#cb1-312" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-313"><a href="#cb1-313" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_windows_numpy(image, kernel_size<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb1-314"><a href="#cb1-314" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract convolution windows using numpy as_strided."""</span></span>
<span id="cb1-315"><a href="#cb1-315" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> numpy.lib.stride_tricks <span class="im">import</span> as_strided</span>
<span id="cb1-316"><a href="#cb1-316" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-317"><a href="#cb1-317" aria-hidden="true" tabindex="-1"></a>    H, W <span class="op">=</span> image.shape</span>
<span id="cb1-318"><a href="#cb1-318" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> kernel_size</span>
<span id="cb1-319"><a href="#cb1-319" aria-hidden="true" tabindex="-1"></a>    out_h, out_w <span class="op">=</span> H <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span>, W <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb1-320"><a href="#cb1-320" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-321"><a href="#cb1-321" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use as_strided to create overlapping windows</span></span>
<span id="cb1-322"><a href="#cb1-322" aria-hidden="true" tabindex="-1"></a>    windows <span class="op">=</span> as_strided(</span>
<span id="cb1-323"><a href="#cb1-323" aria-hidden="true" tabindex="-1"></a>        image,</span>
<span id="cb1-324"><a href="#cb1-324" aria-hidden="true" tabindex="-1"></a>        shape<span class="op">=</span>(out_h, out_w, K, K),</span>
<span id="cb1-325"><a href="#cb1-325" aria-hidden="true" tabindex="-1"></a>        strides<span class="op">=</span>(image.strides[<span class="dv">0</span>], image.strides[<span class="dv">1</span>], image.strides[<span class="dv">0</span>], image.strides[<span class="dv">1</span>])</span>
<span id="cb1-326"><a href="#cb1-326" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-327"><a href="#cb1-327" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-328"><a href="#cb1-328" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Original image shape: </span><span class="sc">{</span>image<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-329"><a href="#cb1-329" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Windows shape: </span><span class="sc">{</span>windows<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-330"><a href="#cb1-330" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Memory view: 4D tensor [out_h, out_w, kernel_h, kernel_w]"</span>)</span>
<span id="cb1-331"><a href="#cb1-331" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-332"><a href="#cb1-332" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> windows</span>
<span id="cb1-333"><a href="#cb1-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-334"><a href="#cb1-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract windows</span></span>
<span id="cb1-335"><a href="#cb1-335" aria-hidden="true" tabindex="-1"></a>windows_numpy <span class="op">=</span> extract_windows_numpy(image)</span>
<span id="cb1-336"><a href="#cb1-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-337"><a href="#cb1-337" aria-hidden="true" tabindex="-1"></a><span class="co"># Show windows in tiled layout</span></span>
<span id="cb1-338"><a href="#cb1-338" aria-hidden="true" tabindex="-1"></a>print_windows_tiled(windows_numpy, <span class="st">"All Windows in Tiled Layout"</span>)</span>
<span id="cb1-339"><a href="#cb1-339" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-340"><a href="#cb1-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-341"><a href="#cb1-341" aria-hidden="true" tabindex="-1"></a>Perfect! We now have a 4D tensor <span class="in">`[4, 4, 3, 3]`</span> containing all 16 convolution windows. Each <span class="in">`[i, j, :, :]`</span> slice contains the window at output position <span class="in">`(i, j)`</span>.</span>
<span id="cb1-342"><a href="#cb1-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-343"><a href="#cb1-343" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3. Window Extraction with Tensor Descriptors</span></span>
<span id="cb1-344"><a href="#cb1-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-345"><a href="#cb1-345" aria-hidden="true" tabindex="-1"></a>Now let's achieve the same result using tensor descriptors, we have seen a similar results before when we learnt about the <span class="in">`EmbedTransform`</span> that is behind <span class="in">`make_naive_tensor_descriptor`</span>.</span>
<span id="cb1-346"><a href="#cb1-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-349"><a href="#cb1-349" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-350"><a href="#cb1-350" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_windows_tensor_descriptor(image, kernel_size<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb1-351"><a href="#cb1-351" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract convolution windows using Tensor Descriptors."""</span></span>
<span id="cb1-352"><a href="#cb1-352" aria-hidden="true" tabindex="-1"></a>    H, W <span class="op">=</span> image.shape</span>
<span id="cb1-353"><a href="#cb1-353" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> kernel_size</span>
<span id="cb1-354"><a href="#cb1-354" aria-hidden="true" tabindex="-1"></a>    out_h, out_w <span class="op">=</span> H <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span>, W <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb1-355"><a href="#cb1-355" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-356"><a href="#cb1-356" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create tensor descriptor for 4D windows</span></span>
<span id="cb1-357"><a href="#cb1-357" aria-hidden="true" tabindex="-1"></a>    window_lengths <span class="op">=</span> [out_h, out_w, K, K]</span>
<span id="cb1-358"><a href="#cb1-358" aria-hidden="true" tabindex="-1"></a>    window_strides <span class="op">=</span> [W, <span class="dv">1</span>, W, <span class="dv">1</span>]  <span class="co"># Strides for overlapping windows</span></span>
<span id="cb1-359"><a href="#cb1-359" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-360"><a href="#cb1-360" aria-hidden="true" tabindex="-1"></a>    windows_descriptor <span class="op">=</span> make_naive_tensor_descriptor(window_lengths, window_strides)</span>
<span id="cb1-361"><a href="#cb1-361" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-362"><a href="#cb1-362" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Tensor descriptor shape: </span><span class="sc">{</span>windows_descriptor<span class="sc">.</span>get_lengths()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-363"><a href="#cb1-363" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Element space size: </span><span class="sc">{</span>windows_descriptor<span class="sc">.</span>get_element_space_size()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-364"><a href="#cb1-364" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-365"><a href="#cb1-365" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract windows using tensor descriptor</span></span>
<span id="cb1-366"><a href="#cb1-366" aria-hidden="true" tabindex="-1"></a>    image_flat <span class="op">=</span> image.flatten()</span>
<span id="cb1-367"><a href="#cb1-367" aria-hidden="true" tabindex="-1"></a>    windows_td <span class="op">=</span> np.zeros((out_h, out_w, K, K))</span>
<span id="cb1-368"><a href="#cb1-368" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-369"><a href="#cb1-369" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(out_h):</span>
<span id="cb1-370"><a href="#cb1-370" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(out_w):</span>
<span id="cb1-371"><a href="#cb1-371" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> ki <span class="kw">in</span> <span class="bu">range</span>(K):</span>
<span id="cb1-372"><a href="#cb1-372" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> kj <span class="kw">in</span> <span class="bu">range</span>(K):</span>
<span id="cb1-373"><a href="#cb1-373" aria-hidden="true" tabindex="-1"></a>                    offset <span class="op">=</span> windows_descriptor.calculate_offset([i, j, ki, kj])</span>
<span id="cb1-374"><a href="#cb1-374" aria-hidden="true" tabindex="-1"></a>                    windows_td[i, j, ki, kj] <span class="op">=</span> image_flat[offset]</span>
<span id="cb1-375"><a href="#cb1-375" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-376"><a href="#cb1-376" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> windows_td</span>
<span id="cb1-377"><a href="#cb1-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-378"><a href="#cb1-378" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract windows using tensor descriptor</span></span>
<span id="cb1-379"><a href="#cb1-379" aria-hidden="true" tabindex="-1"></a>windows_td <span class="op">=</span> extract_windows_tensor_descriptor(image)</span>
<span id="cb1-380"><a href="#cb1-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-381"><a href="#cb1-381" aria-hidden="true" tabindex="-1"></a><span class="co"># Show all windows in tiled layout</span></span>
<span id="cb1-382"><a href="#cb1-382" aria-hidden="true" tabindex="-1"></a>print_windows_tiled(windows_td, <span class="st">"All Windows in Tiled Layout (Tensor Descriptor)"</span>)</span>
<span id="cb1-383"><a href="#cb1-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-384"><a href="#cb1-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-385"><a href="#cb1-385" aria-hidden="true" tabindex="-1"></a>The key insight is the stride pattern <span class="in">`[W, 1, W, 1]`</span>:</span>
<span id="cb1-386"><a href="#cb1-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-387"><a href="#cb1-387" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Moving one step in <span class="in">`out_h`</span> direction requires jumping <span class="in">`W`</span> elements (one row)</span>
<span id="cb1-388"><a href="#cb1-388" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Moving one step in <span class="in">`out_w`</span> direction requires jumping <span class="in">`1`</span> element (one column)  </span>
<span id="cb1-389"><a href="#cb1-389" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Moving one step in <span class="in">`kernel_h`</span> direction requires jumping <span class="in">`W`</span> elements (one row)</span>
<span id="cb1-390"><a href="#cb1-390" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Moving one step in <span class="in">`kernel_w`</span> direction requires jumping <span class="in">`1`</span> element (one column)</span>
<span id="cb1-391"><a href="#cb1-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-392"><a href="#cb1-392" aria-hidden="true" tabindex="-1"></a><span class="fu">### Verification: NumPy vs Tensor Descriptor Windows</span></span>
<span id="cb1-393"><a href="#cb1-393" aria-hidden="true" tabindex="-1"></a>We can see that we get the same results as we do in numpy approach.</span>
<span id="cb1-394"><a href="#cb1-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-397"><a href="#cb1-397" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-398"><a href="#cb1-398" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the two approaches</span></span>
<span id="cb1-399"><a href="#cb1-399" aria-hidden="true" tabindex="-1"></a>difference <span class="op">=</span> np.linalg.norm(windows_numpy <span class="op">-</span> windows_td)</span>
<span id="cb1-400"><a href="#cb1-400" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"L2 norm of difference: </span><span class="sc">{</span>difference<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-401"><a href="#cb1-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-402"><a href="#cb1-402" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> difference <span class="op">&lt;</span> <span class="fl">1e-10</span>:</span>
<span id="cb1-403"><a href="#cb1-403" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✅ SUCCESS: Tensor descriptor windows identical to NumPy!"</span>)</span>
<span id="cb1-404"><a href="#cb1-404" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-405"><a href="#cb1-405" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"❌ ERROR: Tensor descriptor windows differ from NumPy"</span>)</span>
<span id="cb1-406"><a href="#cb1-406" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Max difference: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(np.<span class="bu">abs</span>(windows_numpy <span class="op">-</span> windows_td))<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-407"><a href="#cb1-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-408"><a href="#cb1-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-409"><a href="#cb1-409" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4. Im2col Transformation with NumPy</span></span>
<span id="cb1-410"><a href="#cb1-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-411"><a href="#cb1-411" aria-hidden="true" tabindex="-1"></a>The next step is converting our 4D windows to a 2D matrix format suitable for matrix multiplication. This is called the "im2col" (image to column) transformation. This can be done by using reshape operator of numpy.</span>
<span id="cb1-412"><a href="#cb1-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-415"><a href="#cb1-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-416"><a href="#cb1-416" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> im2col_numpy(windows):</span>
<span id="cb1-417"><a href="#cb1-417" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert 4D windows to 2D im2col matrix using NumPy."""</span></span>
<span id="cb1-418"><a href="#cb1-418" aria-hidden="true" tabindex="-1"></a>    out_h, out_w, K, K <span class="op">=</span> windows.shape</span>
<span id="cb1-419"><a href="#cb1-419" aria-hidden="true" tabindex="-1"></a>    num_windows <span class="op">=</span> out_h <span class="op">*</span> out_w</span>
<span id="cb1-420"><a href="#cb1-420" aria-hidden="true" tabindex="-1"></a>    patch_size <span class="op">=</span> K <span class="op">*</span> K</span>
<span id="cb1-421"><a href="#cb1-421" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-422"><a href="#cb1-422" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reshape to 2D matrix</span></span>
<span id="cb1-423"><a href="#cb1-423" aria-hidden="true" tabindex="-1"></a>    im2col_matrix <span class="op">=</span> windows.reshape(num_windows, patch_size)</span>
<span id="cb1-424"><a href="#cb1-424" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-425"><a href="#cb1-425" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"4D windows shape: </span><span class="sc">{</span>windows<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-426"><a href="#cb1-426" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"2D im2col shape: </span><span class="sc">{</span>im2col_matrix<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-427"><a href="#cb1-427" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Transformation: [</span><span class="sc">{</span>out_h<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>out_w<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>K<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>K<span class="sc">}</span><span class="ss">] → [</span><span class="sc">{</span>num_windows<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>patch_size<span class="sc">}</span><span class="ss">]"</span>)</span>
<span id="cb1-428"><a href="#cb1-428" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-429"><a href="#cb1-429" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> im2col_matrix</span>
<span id="cb1-430"><a href="#cb1-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-431"><a href="#cb1-431" aria-hidden="true" tabindex="-1"></a><span class="co"># Create im2col matrix</span></span>
<span id="cb1-432"><a href="#cb1-432" aria-hidden="true" tabindex="-1"></a>im2col_numpy <span class="op">=</span> im2col_numpy(windows_numpy)</span>
<span id="cb1-433"><a href="#cb1-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-434"><a href="#cb1-434" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the matrix structure</span></span>
<span id="cb1-435"><a href="#cb1-435" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Im2col matrix (each row is a flattened window):"</span>)</span>
<span id="cb1-436"><a href="#cb1-436" aria-hidden="true" tabindex="-1"></a>out_h, out_w <span class="op">=</span> <span class="dv">4</span>, <span class="dv">4</span>  <span class="co"># Our output dimensions</span></span>
<span id="cb1-437"><a href="#cb1-437" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, row <span class="kw">in</span> <span class="bu">enumerate</span>(im2col_numpy):</span>
<span id="cb1-438"><a href="#cb1-438" aria-hidden="true" tabindex="-1"></a>    win_i, win_j <span class="op">=</span> i <span class="op">//</span> out_w, i <span class="op">%</span> out_w</span>
<span id="cb1-439"><a href="#cb1-439" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Row </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> (window [</span><span class="sc">{</span>win_i<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>win_j<span class="sc">}</span><span class="ss">]): </span><span class="sc">{</span><span class="st">' '</span><span class="sc">.</span>join(<span class="ss">f'</span><span class="sc">{</span>val<span class="sc">:3.0f}</span><span class="ss">'</span> <span class="cf">for</span> val <span class="kw">in</span> row)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-440"><a href="#cb1-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-441"><a href="#cb1-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-442"><a href="#cb1-442" aria-hidden="true" tabindex="-1"></a>Each row of the im2col matrix contains a flattened convolution window. This transformation allows us to compute all convolutions simultaneously using a single matrix multiplication.</span>
<span id="cb1-443"><a href="#cb1-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-444"><a href="#cb1-444" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5. Im2col with Tensor Descriptors</span></span>
<span id="cb1-445"><a href="#cb1-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-446"><a href="#cb1-446" aria-hidden="true" tabindex="-1"></a>Since we already extracted windows using tensor descriptors, we can simply reshape them just like the NumPy version, let's see how we can do it using the transformation pipelines.</span>
<span id="cb1-447"><a href="#cb1-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-448"><a href="#cb1-448" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simple Approach: Reshape Existing Windows</span></span>
<span id="cb1-449"><a href="#cb1-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-450"><a href="#cb1-450" aria-hidden="true" tabindex="-1"></a>Since we already extracted the 4D windows using a tensor descriptor, the simplest way to get the im2col matrix is to just reshape the result, similar to how we handled the NumPy array.</span>
<span id="cb1-451"><a href="#cb1-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-454"><a href="#cb1-454" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-455"><a href="#cb1-455" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> im2col_td_simple(windows_td):</span>
<span id="cb1-456"><a href="#cb1-456" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert 4D tensor descriptor windows to 2D im2col matrix."""</span></span>
<span id="cb1-457"><a href="#cb1-457" aria-hidden="true" tabindex="-1"></a>    out_h, out_w, K, K <span class="op">=</span> windows_td.shape</span>
<span id="cb1-458"><a href="#cb1-458" aria-hidden="true" tabindex="-1"></a>    num_windows <span class="op">=</span> out_h <span class="op">*</span> out_w</span>
<span id="cb1-459"><a href="#cb1-459" aria-hidden="true" tabindex="-1"></a>    patch_size <span class="op">=</span> K <span class="op">*</span> K</span>
<span id="cb1-460"><a href="#cb1-460" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-461"><a href="#cb1-461" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reshape to 2D matrix</span></span>
<span id="cb1-462"><a href="#cb1-462" aria-hidden="true" tabindex="-1"></a>    im2col_matrix <span class="op">=</span> windows_td.reshape(num_windows, patch_size)</span>
<span id="cb1-463"><a href="#cb1-463" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-464"><a href="#cb1-464" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"4D TD windows shape: </span><span class="sc">{</span>windows_td<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-465"><a href="#cb1-465" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"2D im2col (simple) shape: </span><span class="sc">{</span>im2col_matrix<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-466"><a href="#cb1-466" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-467"><a href="#cb1-467" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> im2col_matrix</span>
<span id="cb1-468"><a href="#cb1-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-469"><a href="#cb1-469" aria-hidden="true" tabindex="-1"></a><span class="co"># Create im2col from tensor descriptor windows</span></span>
<span id="cb1-470"><a href="#cb1-470" aria-hidden="true" tabindex="-1"></a>im2col_td_matrix <span class="op">=</span> im2col_td_simple(windows_td)</span>
<span id="cb1-471"><a href="#cb1-471" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-472"><a href="#cb1-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-473"><a href="#cb1-473" aria-hidden="true" tabindex="-1"></a>Perfect! This is exactly the same as the NumPy approach - just reshape the 4D windows into a 2D matrix.</span>
<span id="cb1-474"><a href="#cb1-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-475"><a href="#cb1-475" aria-hidden="true" tabindex="-1"></a><span class="fu">### Advanced: Direct 2D Tensor Descriptor</span></span>
<span id="cb1-476"><a href="#cb1-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-477"><a href="#cb1-477" aria-hidden="true" tabindex="-1"></a>However, tensor descriptors can also create the im2col layout directly without intermediate 4D windows. This is useful for GPU implementations:</span>
<span id="cb1-478"><a href="#cb1-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-481"><a href="#cb1-481" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-482"><a href="#cb1-482" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytensor.tensor_descriptor <span class="im">import</span> make_merge_transform</span>
<span id="cb1-483"><a href="#cb1-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-484"><a href="#cb1-484" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_direct_im2col_descriptor(image, kernel_size<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb1-485"><a href="#cb1-485" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create im2col matrix directly using tensor descriptors."""</span></span>
<span id="cb1-486"><a href="#cb1-486" aria-hidden="true" tabindex="-1"></a>    H, W <span class="op">=</span> image.shape</span>
<span id="cb1-487"><a href="#cb1-487" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> kernel_size</span>
<span id="cb1-488"><a href="#cb1-488" aria-hidden="true" tabindex="-1"></a>    out_h, out_w <span class="op">=</span> H <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span>, W <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb1-489"><a href="#cb1-489" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-490"><a href="#cb1-490" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Create 4D windows descriptor</span></span>
<span id="cb1-491"><a href="#cb1-491" aria-hidden="true" tabindex="-1"></a>    window_lengths <span class="op">=</span> [out_h, out_w, K, K]</span>
<span id="cb1-492"><a href="#cb1-492" aria-hidden="true" tabindex="-1"></a>    window_strides <span class="op">=</span> [W, <span class="dv">1</span>, W, <span class="dv">1</span>]</span>
<span id="cb1-493"><a href="#cb1-493" aria-hidden="true" tabindex="-1"></a>    windows_descriptor <span class="op">=</span> make_naive_tensor_descriptor(window_lengths, window_strides)</span>
<span id="cb1-494"><a href="#cb1-494" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-495"><a href="#cb1-495" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Apply merge transforms to create 2D im2col layout directly</span></span>
<span id="cb1-496"><a href="#cb1-496" aria-hidden="true" tabindex="-1"></a>    merge_windows <span class="op">=</span> make_merge_transform([out_h, out_w])  <span class="co"># Merge spatial output dimensions</span></span>
<span id="cb1-497"><a href="#cb1-497" aria-hidden="true" tabindex="-1"></a>    merge_patch <span class="op">=</span> make_merge_transform([K, K])  <span class="co"># Merge kernel dimensions</span></span>
<span id="cb1-498"><a href="#cb1-498" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-499"><a href="#cb1-499" aria-hidden="true" tabindex="-1"></a>    im2col_descriptor <span class="op">=</span> transform_tensor_descriptor( <span class="co">#</span></span>
<span id="cb1-500"><a href="#cb1-500" aria-hidden="true" tabindex="-1"></a>        windows_descriptor,</span>
<span id="cb1-501"><a href="#cb1-501" aria-hidden="true" tabindex="-1"></a>        transforms<span class="op">=</span>[merge_windows, merge_patch],</span>
<span id="cb1-502"><a href="#cb1-502" aria-hidden="true" tabindex="-1"></a>        lower_dimension_hidden_idss<span class="op">=</span>[[<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">2</span>, <span class="dv">3</span>]],</span>
<span id="cb1-503"><a href="#cb1-503" aria-hidden="true" tabindex="-1"></a>        upper_dimension_hidden_idss<span class="op">=</span>[[<span class="dv">0</span>], [<span class="dv">1</span>]]</span>
<span id="cb1-504"><a href="#cb1-504" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-505"><a href="#cb1-505" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-506"><a href="#cb1-506" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Direct im2col descriptor shape: </span><span class="sc">{</span>im2col_descriptor<span class="sc">.</span>get_lengths()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-507"><a href="#cb1-507" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> im2col_descriptor</span>
<span id="cb1-508"><a href="#cb1-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-509"><a href="#cb1-509" aria-hidden="true" tabindex="-1"></a><span class="co"># Create direct im2col descriptor</span></span>
<span id="cb1-510"><a href="#cb1-510" aria-hidden="true" tabindex="-1"></a>im2col_descriptor <span class="op">=</span> create_direct_im2col_descriptor(image)</span>
<span id="cb1-511"><a href="#cb1-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-512"><a href="#cb1-512" aria-hidden="true" tabindex="-1"></a><span class="co"># This descriptor can directly compute offsets for the 2D im2col layout</span></span>
<span id="cb1-513"><a href="#cb1-513" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Example: offset for window 0, patch element 0: </span><span class="sc">{</span>im2col_descriptor<span class="sc">.</span>calculate_offset([<span class="dv">0</span>, <span class="dv">0</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-514"><a href="#cb1-514" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Example: offset for window 0, patch element 4: </span><span class="sc">{</span>im2col_descriptor<span class="sc">.</span>calculate_offset([<span class="dv">0</span>, <span class="dv">4</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-515"><a href="#cb1-515" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Example: offset for window 1, patch element 0: </span><span class="sc">{</span>im2col_descriptor<span class="sc">.</span>calculate_offset([<span class="dv">1</span>, <span class="dv">0</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-516"><a href="#cb1-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-517"><a href="#cb1-517" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract data using the direct descriptor</span></span>
<span id="cb1-518"><a href="#cb1-518" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_im2col_with_descriptor(image, descriptor):</span>
<span id="cb1-519"><a href="#cb1-519" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract im2col matrix using tensor descriptor."""</span></span>
<span id="cb1-520"><a href="#cb1-520" aria-hidden="true" tabindex="-1"></a>    image_flat <span class="op">=</span> image.flatten()</span>
<span id="cb1-521"><a href="#cb1-521" aria-hidden="true" tabindex="-1"></a>    descriptor_shape <span class="op">=</span> descriptor.get_lengths()</span>
<span id="cb1-522"><a href="#cb1-522" aria-hidden="true" tabindex="-1"></a>    num_windows, patch_size <span class="op">=</span> descriptor_shape</span>
<span id="cb1-523"><a href="#cb1-523" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-524"><a href="#cb1-524" aria-hidden="true" tabindex="-1"></a>    im2col_matrix <span class="op">=</span> np.zeros((num_windows, patch_size))</span>
<span id="cb1-525"><a href="#cb1-525" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-526"><a href="#cb1-526" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_windows):</span>
<span id="cb1-527"><a href="#cb1-527" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(patch_size):</span>
<span id="cb1-528"><a href="#cb1-528" aria-hidden="true" tabindex="-1"></a>            offset <span class="op">=</span> descriptor.calculate_offset([i, j])</span>
<span id="cb1-529"><a href="#cb1-529" aria-hidden="true" tabindex="-1"></a>            im2col_matrix[i, j] <span class="op">=</span> image_flat[offset]</span>
<span id="cb1-530"><a href="#cb1-530" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-531"><a href="#cb1-531" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Extracted im2col matrix using descriptor: </span><span class="sc">{</span>im2col_matrix<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-532"><a href="#cb1-532" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> im2col_matrix</span>
<span id="cb1-533"><a href="#cb1-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-534"><a href="#cb1-534" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract im2col matrix using tensor descriptor</span></span>
<span id="cb1-535"><a href="#cb1-535" aria-hidden="true" tabindex="-1"></a>im2col_td_direct <span class="op">=</span> extract_im2col_with_descriptor(image, im2col_descriptor)</span>
<span id="cb1-536"><a href="#cb1-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-537"><a href="#cb1-537" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the matrix structure</span></span>
<span id="cb1-538"><a href="#cb1-538" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">im2col_td_direct matrix (each row is a flattened window):"</span>)</span>
<span id="cb1-539"><a href="#cb1-539" aria-hidden="true" tabindex="-1"></a>out_h, out_w <span class="op">=</span> <span class="dv">4</span>, <span class="dv">4</span>  <span class="co"># Our output dimensions</span></span>
<span id="cb1-540"><a href="#cb1-540" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, row <span class="kw">in</span> <span class="bu">enumerate</span>(im2col_td_direct):</span>
<span id="cb1-541"><a href="#cb1-541" aria-hidden="true" tabindex="-1"></a>    win_i, win_j <span class="op">=</span> i <span class="op">//</span> out_w, i <span class="op">%</span> out_w</span>
<span id="cb1-542"><a href="#cb1-542" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Row </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> (window [</span><span class="sc">{</span>win_i<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>win_j<span class="sc">}</span><span class="ss">]): </span><span class="sc">{</span><span class="st">' '</span><span class="sc">.</span>join(<span class="ss">f'</span><span class="sc">{</span>val<span class="sc">:3.0f}</span><span class="ss">'</span> <span class="cf">for</span> val <span class="kw">in</span> row)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-543"><a href="#cb1-543" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-544"><a href="#cb1-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-545"><a href="#cb1-545" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why Both Approaches?</span></span>
<span id="cb1-546"><a href="#cb1-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-547"><a href="#cb1-547" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Simple reshape**: Easy to understand, perfect for CPU implementations</span>
<span id="cb1-548"><a href="#cb1-548" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Direct tensor descriptor**: Enables efficient GPU kernel generation where the hardware can directly compute memory addresses for the im2col layout without materializing intermediate 4D arrays</span>
<span id="cb1-549"><a href="#cb1-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-550"><a href="#cb1-550" aria-hidden="true" tabindex="-1"></a>The advanced direct tensor descriptor approach uses two <span class="in">`MergeTransform`</span> operations:</span>
<span id="cb1-551"><a href="#cb1-551" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Merge spatial dimensions**: <span class="in">`[out_h, out_w] → num_windows`</span></span>
<span id="cb1-552"><a href="#cb1-552" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Merge kernel dimensions**: <span class="in">`[K, K] → patch_size`</span></span>
<span id="cb1-553"><a href="#cb1-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-554"><a href="#cb1-554" aria-hidden="true" tabindex="-1"></a>This transforms the 4D tensor <span class="in">`[out_h, out_w, K, K]`</span> directly into a 2D matrix <span class="in">`[num_windows, patch_size]`</span> without materializing the intermediate 4D array.</span>
<span id="cb1-555"><a href="#cb1-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-556"><a href="#cb1-556" aria-hidden="true" tabindex="-1"></a><span class="fu">### Verification: NumPy vs Tensor Descriptor Im2col</span></span>
<span id="cb1-557"><a href="#cb1-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-560"><a href="#cb1-560" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-561"><a href="#cb1-561" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare NumPy approach with direct tensor descriptor approach</span></span>
<span id="cb1-562"><a href="#cb1-562" aria-hidden="true" tabindex="-1"></a>difference <span class="op">=</span> np.linalg.norm(im2col_numpy <span class="op">-</span> im2col_td_direct)</span>
<span id="cb1-563"><a href="#cb1-563" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"L2 norm of difference (NumPy vs Tensor Descriptor): </span><span class="sc">{</span>difference<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-564"><a href="#cb1-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-565"><a href="#cb1-565" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> difference <span class="op">&lt;</span> <span class="fl">1e-10</span>:</span>
<span id="cb1-566"><a href="#cb1-566" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✅ SUCCESS: Tensor descriptor im2col identical to NumPy!"</span>)</span>
<span id="cb1-567"><a href="#cb1-567" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-568"><a href="#cb1-568" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"❌ ERROR: Tensor descriptor im2col differs from NumPy"</span>)</span>
<span id="cb1-569"><a href="#cb1-569" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Max difference: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(np.<span class="bu">abs</span>(im2col_numpy <span class="op">-</span> im2col_td_direct))<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-570"><a href="#cb1-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-571"><a href="#cb1-571" aria-hidden="true" tabindex="-1"></a><span class="co"># Also verify that simple reshape gives same result</span></span>
<span id="cb1-572"><a href="#cb1-572" aria-hidden="true" tabindex="-1"></a>difference_simple <span class="op">=</span> np.linalg.norm(im2col_numpy <span class="op">-</span> im2col_td_matrix)</span>
<span id="cb1-573"><a href="#cb1-573" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">L2 norm of difference (NumPy vs Simple Reshape): </span><span class="sc">{</span>difference_simple<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-574"><a href="#cb1-574" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> difference_simple <span class="op">&lt;</span> <span class="fl">1e-10</span>:</span>
<span id="cb1-575"><a href="#cb1-575" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✅ SUCCESS: Simple reshape approach also identical!"</span>)</span>
<span id="cb1-576"><a href="#cb1-576" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-577"><a href="#cb1-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-578"><a href="#cb1-578" aria-hidden="true" tabindex="-1"></a><span class="fu">## 6. Convolution via Matrix Multiplication</span></span>
<span id="cb1-579"><a href="#cb1-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-580"><a href="#cb1-580" aria-hidden="true" tabindex="-1"></a>With our im2col matrix ready, we can now perform convolution using simple matrix multiplication:</span>
<span id="cb1-581"><a href="#cb1-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-584"><a href="#cb1-584" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-585"><a href="#cb1-585" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convolution_with_im2col(im2col_matrix, kernel, out_shape):</span>
<span id="cb1-586"><a href="#cb1-586" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Perform convolution using im2col matrix multiplication."""</span></span>
<span id="cb1-587"><a href="#cb1-587" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flatten kernel</span></span>
<span id="cb1-588"><a href="#cb1-588" aria-hidden="true" tabindex="-1"></a>    kernel_flat <span class="op">=</span> kernel.flatten()</span>
<span id="cb1-589"><a href="#cb1-589" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-590"><a href="#cb1-590" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Im2col matrix shape: </span><span class="sc">{</span>im2col_matrix<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-591"><a href="#cb1-591" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Kernel flat shape: </span><span class="sc">{</span>kernel_flat<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-592"><a href="#cb1-592" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-593"><a href="#cb1-593" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Matrix multiplication: each row of im2col with kernel</span></span>
<span id="cb1-594"><a href="#cb1-594" aria-hidden="true" tabindex="-1"></a>    output_flat <span class="op">=</span> im2col_matrix <span class="op">@</span> kernel_flat</span>
<span id="cb1-595"><a href="#cb1-595" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-596"><a href="#cb1-596" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reshape to output dimensions</span></span>
<span id="cb1-597"><a href="#cb1-597" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> output_flat.reshape(out_shape)</span>
<span id="cb1-598"><a href="#cb1-598" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-599"><a href="#cb1-599" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Output flat shape: </span><span class="sc">{</span>output_flat<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-600"><a href="#cb1-600" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Final output shape: </span><span class="sc">{</span>output<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-601"><a href="#cb1-601" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-602"><a href="#cb1-602" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> output</span>
<span id="cb1-603"><a href="#cb1-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-604"><a href="#cb1-604" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform convolution using im2col</span></span>
<span id="cb1-605"><a href="#cb1-605" aria-hidden="true" tabindex="-1"></a>out_shape <span class="op">=</span> reference_output.shape</span>
<span id="cb1-606"><a href="#cb1-606" aria-hidden="true" tabindex="-1"></a>im2col_output <span class="op">=</span> convolution_with_im2col(im2col_numpy, kernel, out_shape)</span>
<span id="cb1-607"><a href="#cb1-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-608"><a href="#cb1-608" aria-hidden="true" tabindex="-1"></a>print_matrix(im2col_output, <span class="st">"Convolution via Im2col"</span>)</span>
<span id="cb1-609"><a href="#cb1-609" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-610"><a href="#cb1-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-611"><a href="#cb1-611" aria-hidden="true" tabindex="-1"></a><span class="fu">### Final Verification: All Methods Equivalent</span></span>
<span id="cb1-612"><a href="#cb1-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-613"><a href="#cb1-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-616"><a href="#cb1-616" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-617"><a href="#cb1-617" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify that all methods produce the same result</span></span>
<span id="cb1-618"><a href="#cb1-618" aria-hidden="true" tabindex="-1"></a>difference <span class="op">=</span> np.linalg.norm(reference_output <span class="op">-</span> im2col_output)</span>
<span id="cb1-619"><a href="#cb1-619" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"L2 norm difference (naive vs im2col): </span><span class="sc">{</span>difference<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-620"><a href="#cb1-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-621"><a href="#cb1-621" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> difference <span class="op">&lt;</span> <span class="fl">1e-10</span>:</span>
<span id="cb1-622"><a href="#cb1-622" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✅ SUCCESS: Im2col convolution matches naive reference!"</span>)</span>
<span id="cb1-623"><a href="#cb1-623" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-624"><a href="#cb1-624" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"❌ ERROR: Im2col convolution differs from reference"</span>)</span>
<span id="cb1-625"><a href="#cb1-625" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Max difference: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(np.<span class="bu">abs</span>(reference_output <span class="op">-</span> im2col_output))<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-626"><a href="#cb1-626" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-627"><a href="#cb1-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-628"><a href="#cb1-628" aria-hidden="true" tabindex="-1"></a><span class="fu">## 7. Multi-Channel Convolution</span></span>
<span id="cb1-629"><a href="#cb1-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-630"><a href="#cb1-630" aria-hidden="true" tabindex="-1"></a>Real-world deep learning scenarios involve multiple input and output channels. Let's extend our approach:</span>
<span id="cb1-631"><a href="#cb1-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-634"><a href="#cb1-634" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb1-635"><a href="#cb1-635" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> multi_channel_convolution():</span>
<span id="cb1-636"><a href="#cb1-636" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate multi-channel convolution."""</span></span>
<span id="cb1-637"><a href="#cb1-637" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create multi-channel input: 6x6x2 (2 input channels)</span></span>
<span id="cb1-638"><a href="#cb1-638" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">123</span>)</span>
<span id="cb1-639"><a href="#cb1-639" aria-hidden="true" tabindex="-1"></a>    input_tensor <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="dv">5</span>, (<span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">2</span>))</span>
<span id="cb1-640"><a href="#cb1-640" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-641"><a href="#cb1-641" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create multi-channel filters: 3x3x2x3 (2 input, 3 output channels)</span></span>
<span id="cb1-642"><a href="#cb1-642" aria-hidden="true" tabindex="-1"></a>    filters <span class="op">=</span> np.random.randint(<span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>, (<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb1-643"><a href="#cb1-643" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-644"><a href="#cb1-644" aria-hidden="true" tabindex="-1"></a>    H, W, C_in <span class="op">=</span> input_tensor.shape</span>
<span id="cb1-645"><a href="#cb1-645" aria-hidden="true" tabindex="-1"></a>    K, K, C_in_filter, C_out <span class="op">=</span> filters.shape</span>
<span id="cb1-646"><a href="#cb1-646" aria-hidden="true" tabindex="-1"></a>    out_h, out_w <span class="op">=</span> H <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span>, W <span class="op">-</span> K <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb1-647"><a href="#cb1-647" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-648"><a href="#cb1-648" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Input shape: </span><span class="sc">{</span>input_tensor<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-649"><a href="#cb1-649" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Filters shape: </span><span class="sc">{</span>filters<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-650"><a href="#cb1-650" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Output shape: (</span><span class="sc">{</span>out_h<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>out_w<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>C_out<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb1-651"><a href="#cb1-651" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-652"><a href="#cb1-652" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reference convolution with nested loops</span></span>
<span id="cb1-653"><a href="#cb1-653" aria-hidden="true" tabindex="-1"></a>    reference_output <span class="op">=</span> np.zeros((out_h, out_w, C_out))</span>
<span id="cb1-654"><a href="#cb1-654" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(out_h):</span>
<span id="cb1-655"><a href="#cb1-655" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(out_w):</span>
<span id="cb1-656"><a href="#cb1-656" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> c_out <span class="kw">in</span> <span class="bu">range</span>(C_out):</span>
<span id="cb1-657"><a href="#cb1-657" aria-hidden="true" tabindex="-1"></a>                window <span class="op">=</span> input_tensor[i:i<span class="op">+</span>K, j:j<span class="op">+</span>K, :]  <span class="co"># [K, K, C_in]</span></span>
<span id="cb1-658"><a href="#cb1-658" aria-hidden="true" tabindex="-1"></a>                reference_output[i, j, c_out] <span class="op">=</span> np.<span class="bu">sum</span>(window <span class="op">*</span> filters[:, :, :, c_out])</span>
<span id="cb1-659"><a href="#cb1-659" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-660"><a href="#cb1-660" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Im2col approach using direct as_strided (like the figure shows)</span></span>
<span id="cb1-661"><a href="#cb1-661" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract all channels at once using as_strided</span></span>
<span id="cb1-662"><a href="#cb1-662" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> numpy.lib.stride_tricks <span class="im">import</span> as_strided</span>
<span id="cb1-663"><a href="#cb1-663" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-664"><a href="#cb1-664" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create 5D windows [out_h, out_w, K, K, C_in] directly</span></span>
<span id="cb1-665"><a href="#cb1-665" aria-hidden="true" tabindex="-1"></a>    windows_5d <span class="op">=</span> as_strided(</span>
<span id="cb1-666"><a href="#cb1-666" aria-hidden="true" tabindex="-1"></a>        input_tensor,</span>
<span id="cb1-667"><a href="#cb1-667" aria-hidden="true" tabindex="-1"></a>        shape<span class="op">=</span>(out_h, out_w, K, K, C_in),</span>
<span id="cb1-668"><a href="#cb1-668" aria-hidden="true" tabindex="-1"></a>        strides<span class="op">=</span>(input_tensor.strides[<span class="dv">0</span>], input_tensor.strides[<span class="dv">1</span>], </span>
<span id="cb1-669"><a href="#cb1-669" aria-hidden="true" tabindex="-1"></a>                input_tensor.strides[<span class="dv">0</span>], input_tensor.strides[<span class="dv">1</span>], input_tensor.strides[<span class="dv">2</span>])</span>
<span id="cb1-670"><a href="#cb1-670" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-671"><a href="#cb1-671" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-672"><a href="#cb1-672" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to im2col format: [num_windows, patch_size]</span></span>
<span id="cb1-673"><a href="#cb1-673" aria-hidden="true" tabindex="-1"></a>    num_windows <span class="op">=</span> out_h <span class="op">*</span> out_w</span>
<span id="cb1-674"><a href="#cb1-674" aria-hidden="true" tabindex="-1"></a>    patch_size <span class="op">=</span> K <span class="op">*</span> K <span class="op">*</span> C_in</span>
<span id="cb1-675"><a href="#cb1-675" aria-hidden="true" tabindex="-1"></a>    im2col_matrix <span class="op">=</span> windows_5d.reshape(num_windows, patch_size)</span>
<span id="cb1-676"><a href="#cb1-676" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-677"><a href="#cb1-677" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reshape filters and apply</span></span>
<span id="cb1-678"><a href="#cb1-678" aria-hidden="true" tabindex="-1"></a>    filters_reshaped <span class="op">=</span> filters.reshape(patch_size, C_out)</span>
<span id="cb1-679"><a href="#cb1-679" aria-hidden="true" tabindex="-1"></a>    im2col_output_flat <span class="op">=</span> im2col_matrix <span class="op">@</span> filters_reshaped</span>
<span id="cb1-680"><a href="#cb1-680" aria-hidden="true" tabindex="-1"></a>    im2col_output <span class="op">=</span> im2col_output_flat.reshape(out_h, out_w, C_out)</span>
<span id="cb1-681"><a href="#cb1-681" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-682"><a href="#cb1-682" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Im2col matrix shape: </span><span class="sc">{</span>im2col_matrix<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-683"><a href="#cb1-683" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Reshaped filters shape: </span><span class="sc">{</span>filters_reshaped<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-684"><a href="#cb1-684" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-685"><a href="#cb1-685" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare results</span></span>
<span id="cb1-686"><a href="#cb1-686" aria-hidden="true" tabindex="-1"></a>    difference <span class="op">=</span> np.linalg.norm(reference_output <span class="op">-</span> im2col_output)</span>
<span id="cb1-687"><a href="#cb1-687" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">L2 norm difference (reference vs im2col): </span><span class="sc">{</span>difference<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-688"><a href="#cb1-688" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-689"><a href="#cb1-689" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> difference <span class="op">&lt;</span> <span class="fl">1e-10</span>:</span>
<span id="cb1-690"><a href="#cb1-690" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"✅ SUCCESS: Multi-channel im2col matches reference!"</span>)</span>
<span id="cb1-691"><a href="#cb1-691" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-692"><a href="#cb1-692" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"❌ ERROR: Multi-channel results differ"</span>)</span>
<span id="cb1-693"><a href="#cb1-693" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-694"><a href="#cb1-694" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> reference_output, im2col_output</span>
<span id="cb1-695"><a href="#cb1-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-696"><a href="#cb1-696" aria-hidden="true" tabindex="-1"></a><span class="co"># Run multi-channel demonstration</span></span>
<span id="cb1-697"><a href="#cb1-697" aria-hidden="true" tabindex="-1"></a>multi_channel_convolution()</span>
<span id="cb1-698"><a href="#cb1-698" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb1-699"><a href="#cb1-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-700"><a href="#cb1-700" aria-hidden="true" tabindex="-1"></a>For multi-channel convolution:</span>
<span id="cb1-701"><a href="#cb1-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-702"><a href="#cb1-702" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Input**: <span class="in">`[H, W, C_in]`</span> </span>
<span id="cb1-703"><a href="#cb1-703" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Filters**: <span class="in">`[K, K, C_in, C_out]`</span></span>
<span id="cb1-704"><a href="#cb1-704" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Im2col matrix**: <span class="in">`[num_windows, K×K×C_in]`</span></span>
<span id="cb1-705"><a href="#cb1-705" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Reshaped filters**: <span class="in">`[K×K×C_in, C_out]`</span></span>
<span id="cb1-706"><a href="#cb1-706" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Output**: <span class="in">`[out_h, out_w, C_out]`</span></span>
<span id="cb1-707"><a href="#cb1-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-708"><a href="#cb1-708" aria-hidden="true" tabindex="-1"></a>The same im2col principle applies, but now each window includes all input channels, and we can compute all output channels simultaneously.</span>
<span id="cb1-709"><a href="#cb1-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-710"><a href="#cb1-710" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb1-711"><a href="#cb1-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-712"><a href="#cb1-712" aria-hidden="true" tabindex="-1"></a>We've demonstrated the complete evolution from naive convolution to optimized tensor descriptor-based implementation:</span>
<span id="cb1-713"><a href="#cb1-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-714"><a href="#cb1-714" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Naive approach**: Direct mathematical implementation with nested loops</span>
<span id="cb1-715"><a href="#cb1-715" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Window extraction**: Using <span class="in">`as_strided`</span> to create efficient memory views</span>
<span id="cb1-716"><a href="#cb1-716" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Tensor descriptors**: Achieving the same with structured transformations</span>
<span id="cb1-717"><a href="#cb1-717" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Im2col transformation**: Converting convolution to matrix multiplication</span>
<span id="cb1-718"><a href="#cb1-718" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Multi-channel extension**: Scaling to realistic deep learning scenarios</span>
<span id="cb1-719"><a href="#cb1-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-720"><a href="#cb1-720" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key Insights</span></span>
<span id="cb1-721"><a href="#cb1-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-722"><a href="#cb1-722" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Memory efficiency**: Tensor descriptors avoid data duplication by creating views</span>
<span id="cb1-723"><a href="#cb1-723" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Parallelization**: Im2col enables massive parallelization through matrix multiplication</span>
<span id="cb1-724"><a href="#cb1-724" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Generalization**: The tensor descriptor **approach** extends naturally to complex memory patterns</span>
<span id="cb1-725"><a href="#cb1-725" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**GPU acceleration**: These transformations form the foundation for efficient GPU kernels</span>
<span id="cb1-726"><a href="#cb1-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-727"><a href="#cb1-727" aria-hidden="true" tabindex="-1"></a>The tensor descriptor system provides a unified framework for describing these transformations, making it possible to generate efficient code for various hardware architectures automatically. It is also important to note that the tensor descriptor machinary is implmented in compile time C++ code, therefore very efficient. This python implementation is just a simulator to demonstrate the concept.</span>
<span id="cb1-728"><a href="#cb1-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-729"><a href="#cb1-729" aria-hidden="true" tabindex="-1"></a><span class="fu">### Performance Characteristics</span></span>
<span id="cb1-730"><a href="#cb1-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-731"><a href="#cb1-731" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Method <span class="pp">|</span> Memory Usage <span class="pp">|</span> Parallelization <span class="pp">|</span> GPU Suitability <span class="pp">|</span></span>
<span id="cb1-732"><a href="#cb1-732" aria-hidden="true" tabindex="-1"></a><span class="pp">|--------|--------------|-----------------|-----------------|</span></span>
<span id="cb1-733"><a href="#cb1-733" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Naive loops <span class="pp">|</span> Low <span class="pp">|</span> Poor <span class="pp">|</span> Poor <span class="pp">|</span></span>
<span id="cb1-734"><a href="#cb1-734" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> As_strided <span class="pp">|</span> Medium <span class="pp">|</span> Good <span class="pp">|</span> Limited <span class="pp">|</span></span>
<span id="cb1-735"><a href="#cb1-735" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Tensor descriptors <span class="pp">|</span> Medium <span class="pp">|</span> Excellent <span class="pp">|</span> Excellent <span class="pp">|</span></span>
<span id="cb1-736"><a href="#cb1-736" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Im2col <span class="pp">|</span> High <span class="pp">|</span> Excellent <span class="pp">|</span> Excellent <span class="pp">|</span></span>
<span id="cb1-737"><a href="#cb1-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-738"><a href="#cb1-738" aria-hidden="true" tabindex="-1"></a>Tensor descriptors strike the optimal balance: they provide the parallelization benefits of im2col while maintaining the memory efficiency of strided operations, making them ideal for high-performance GPU implementations. </span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<script src="font-cleanup.js"></script>




</body></html>