<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Encoding Internals - The Internal Machinery – Tile Distribution Documentation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-038ebe7de1ad581fc619d66ba7f7845b.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-9cae0046c5fab5900eed4751693c39dd.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-038ebe7de1ad581fc619d66ba7f7845b.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-185961ed47a39db2ff9d8581d2d02664.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-1f647ac581ac6b74d75948daead8752e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-185961ed47a39db2ff9d8581d2d02664.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/live-runtime/live-runtime.js" type="module"></script>
<link href="../site_libs/quarto-contrib/live-runtime/live-runtime.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    mermaid.initialize({ 
        startOnLoad: true,
        theme: 'default',
        themeVariables: {
            primaryColor: '#f0f7ff',
            primaryTextColor: '#1e293b',
            primaryBorderColor: '#2563eb',
            lineColor: '#6b7280',
            secondaryColor: '#fef3e2',
            tertiaryColor: '#f0fdf4',
            background: '#ffffff',
            mainBkg: '#f0f7ff',
            secondBkg: '#fef3e2',
            tertiaryBkg: '#f0fdf4',
            primaryTextColor: '#1e293b',
            fontSize: '16px'
        }
    });
});
</script>
<script type="module" src="../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">


<link rel="stylesheet" href="../global-font-override.css">
<link rel="stylesheet" href="../diagram-sizing-fixes.css">
</head>

<body class="nav-sidebar docked quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../concepts/05_encoding_internals.html">Implementation Deep Dive</a></li><li class="breadcrumb-item"><a href="../concepts/05_encoding_internals.html">Encoding Internals - The Internal Machinery</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Tile Distribution Documentation</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tile Distribution Documentation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/00_introduction_motivation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction and Motivation - Why Tile Distribution Matters</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/01_buffer_view.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Buffer Views - Raw Memory Access</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/01_tensor_view.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tensor Views - Multi-Dimensional Structure</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Transformation Engine</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_tensor_coordinates.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Coordinates</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Individual Transforms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_adaptors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tensor Adaptors - Chaining Transformations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_descriptors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tensor Descriptors - Complete Tensor Specifications</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_convolution_example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Convolution Implementation with Tensor Descriptors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/02_coordinate_movement.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced Coordinate Operations</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Distribution API</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/03_tile_distribution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tile Distribution - The Core API</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/03_tile_window.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tile Window - Data Access Gateway</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/03_sweep_tile.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sweep Tile - Elegant Iteration</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Coordinate Systems</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/04_coordinate_systems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coordinate Systems - The Mathematical Foundation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Implementation Deep Dive</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/05_encoding_internals.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Encoding Internals - The Internal Machinery</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/05_static_distributed_tensor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Static Distributed Tensor - Thread-Local Data Containers</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Thread Mapping</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts/06_thread_mapping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Thread Mapping - Connecting to Hardware</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#encoding-structure" id="toc-encoding-structure" class="nav-link" data-scroll-target="#encoding-structure">Encoding Structure</a></li>
  <li><a href="#what-is-tile-distribution-encoding" id="toc-what-is-tile-distribution-encoding" class="nav-link" data-scroll-target="#what-is-tile-distribution-encoding">What is Tile Distribution Encoding?</a></li>
  <li><a href="#encoding-structure-deep-dive" id="toc-encoding-structure-deep-dive" class="nav-link" data-scroll-target="#encoding-structure-deep-dive">Encoding Structure Deep Dive</a></li>
  <li><a href="#c-template-implementation" id="toc-c-template-implementation" class="nav-link" data-scroll-target="#c-template-implementation">C++ Template Implementation</a>
  <ul class="collapse">
  <li><a href="#key-c-features-used" id="toc-key-c-features-used" class="nav-link" data-scroll-target="#key-c-features-used">Key C++ Features Used</a></li>
  </ul></li>
  <li><a href="#parameter-breakdown" id="toc-parameter-breakdown" class="nav-link" data-scroll-target="#parameter-breakdown">Parameter Breakdown</a>
  <ul class="collapse">
  <li><a href="#r-dimensions-replication-specification" id="toc-r-dimensions-replication-specification" class="nav-link" data-scroll-target="#r-dimensions-replication-specification">R-Dimensions: Replication Specification</a></li>
  <li><a href="#h-dimensions-hierarchical-decomposition" id="toc-h-dimensions-hierarchical-decomposition" class="nav-link" data-scroll-target="#h-dimensions-hierarchical-decomposition">H-Dimensions: Hierarchical Decomposition</a></li>
  <li><a href="#p-dimensions-partition-mapping" id="toc-p-dimensions-partition-mapping" class="nav-link" data-scroll-target="#p-dimensions-partition-mapping">P-Dimensions: Partition Mapping</a></li>
  <li><a href="#y-dimensions-logical-view-mapping" id="toc-y-dimensions-logical-view-mapping" class="nav-link" data-scroll-target="#y-dimensions-logical-view-mapping">Y-Dimensions: Logical View Mapping</a></li>
  <li><a href="#prh-mappings" id="toc-prh-mappings" class="nav-link" data-scroll-target="#prh-mappings">P→RH Mappings</a></li>
  <li><a href="#yrh-mappings" id="toc-yrh-mappings" class="nav-link" data-scroll-target="#yrh-mappings">Y→RH Mappings</a></li>
  </ul></li>
  <li><a href="#from-encoding-to-tile-distribution" id="toc-from-encoding-to-tile-distribution" class="nav-link" data-scroll-target="#from-encoding-to-tile-distribution">From Encoding to Tile Distribution</a></li>
  <li><a href="#the-py-x-transformation-chain" id="toc-the-py-x-transformation-chain" class="nav-link" data-scroll-target="#the-py-x-transformation-chain">The P+Y → X Transformation Chain</a>
  <ul class="collapse">
  <li><a href="#c-transformation-chain-implementation" id="toc-c-transformation-chain-implementation" class="nav-link" data-scroll-target="#c-transformation-chain-implementation">C++ Transformation Chain Implementation</a></li>
  <li><a href="#how-transforms-work-in-c" id="toc-how-transforms-work-in-c" class="nav-link" data-scroll-target="#how-transforms-work-in-c">How Transforms Work in C++</a></li>
  </ul></li>
  <li><a href="#the-y-to-d-linearization" id="toc-the-y-to-d-linearization" class="nav-link" data-scroll-target="#the-y-to-d-linearization">The Y to D Linearization</a>
  <ul class="collapse">
  <li><a href="#c-implementation-of-yd-descriptor" id="toc-c-implementation-of-yd-descriptor" class="nav-link" data-scroll-target="#c-implementation-of-yd-descriptor">C++ Implementation of Y→D Descriptor</a></li>
  <li><a href="#memory-layout-optimization" id="toc-memory-layout-optimization" class="nav-link" data-scroll-target="#memory-layout-optimization">Memory Layout Optimization</a></li>
  <li><a href="#y-to-d-linearization-details" id="toc-y-to-d-linearization-details" class="nav-link" data-scroll-target="#y-to-d-linearization-details">Y to D Linearization Details</a></li>
  </ul></li>
  <li><a href="#practical-examples" id="toc-practical-examples" class="nav-link" data-scroll-target="#practical-examples">Practical Examples</a></li>
  <li><a href="#testing-your-understanding" id="toc-testing-your-understanding" class="nav-link" data-scroll-target="#testing-your-understanding">Testing Your Understanding</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways</a>
  <ul class="collapse">
  <li><a href="#mathematical-foundation" id="toc-mathematical-foundation" class="nav-link" data-scroll-target="#mathematical-foundation">Mathematical Foundation</a></li>
  <li><a href="#automatic-code-generation" id="toc-automatic-code-generation" class="nav-link" data-scroll-target="#automatic-code-generation">Automatic Code Generation</a></li>
  <li><a href="#component-architecture" id="toc-component-architecture" class="nav-link" data-scroll-target="#component-architecture">Component Architecture</a></li>
  <li><a href="#performance-implications" id="toc-performance-implications" class="nav-link" data-scroll-target="#performance-implications">Performance Implications</a></li>
  <li><a href="#practical-applications" id="toc-practical-applications" class="nav-link" data-scroll-target="#practical-applications">Practical Applications</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../concepts/05_encoding_internals.html">Implementation Deep Dive</a></li><li class="breadcrumb-item"><a href="../concepts/05_encoding_internals.html">Encoding Internals - The Internal Machinery</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Encoding Internals - The Internal Machinery</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div>
<div id="pyodide-1" class="exercise-cell">

</div>
<script type="pyodide-1-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOnRydWUsImVjaG8iOmZhbHNlLCJlZGl0IjpmYWxzZSwiZXZhbCI6dHJ1ZSwib3V0cHV0IjpmYWxzZX0sImNvZGUiOiJcbiMgQXV0by1pbnN0YWxsIHB5dGhvbmNrIHBhY2thZ2VcbmltcG9ydCBtaWNyb3BpcFxuYXdhaXQgbWljcm9waXAuaW5zdGFsbChcImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9naGFtYXJpYW4vcHl0aG9uY2svbWFzdGVyL2RvY3VtZW50YXRpb24vcHl0aG9uY2stMC4xLjAtcHkzLW5vbmUtYW55LndobFwiKVxuXG4jIFNldHVwIHB5dGVuc29yIHBhdGggZm9yIHB5b2RpZGUgZW52aXJvbm1lbnRcbmltcG9ydCBzeXNcbmltcG9ydCBvc1xuaW1wb3J0IG51bXB5IGFzIG5wXG5cbiMgQWRkIHRoZSBwcm9qZWN0IHJvb3QgdG8gcGF0aCBzbyB3ZSBjYW4gaW1wb3J0IHB5dGVuc29yXG5zeXMucGF0aC5pbnNlcnQoMCwgJy9ob21lL2FnaGFtYXJpL2dpdGh1Yi9jb21wb3NhYmxlX2tlcm5lbC92aXN1YWxpc2F0aW9uJylcblxuIyBJbXBvcnQgdGhlIGFjdHVhbCBDSyBtb2R1bGVzXG5mcm9tIHB5dGVuc29yLnRpbGVfZGlzdHJpYnV0aW9uX2VuY29kaW5nIGltcG9ydCBUaWxlRGlzdHJpYnV0aW9uRW5jb2RpbmdcbmZyb20gcHl0ZW5zb3IudGlsZV9kaXN0cmlidXRpb24gaW1wb3J0IG1ha2Vfc3RhdGljX3RpbGVfZGlzdHJpYnV0aW9uIn0=
</script>
</div>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>The tile distribution encoding system represents the core mathematical framework that transforms high-level tensor distribution specifications into concrete, optimized GPU kernel implementations. This sophisticated compile-time machinery bridges the gap between abstract mathematical descriptions and executable coordinate transformations, enabling the Composable Kernel framework to generate highly efficient code for complex tensor operations.</p>
<p>At its heart, the encoding system defines how multi-dimensional tensor data is distributed across GPU processing elements through a hierarchical decomposition scheme. By specifying relationships between different coordinate spaces - replication (R), hierarchical (H), partition (P), and yield (Y) dimensions - the encoding provides a complete blueprint for data layout and access patterns that can be resolved entirely at compile time.</p>
</section>
<section id="encoding-structure" class="level2">
<h2 class="anchored" data-anchor-id="encoding-structure">Encoding Structure</h2>
<div class="mermaid">
graph TB
    subgraph "Encoding Components"
        RS["R-space Lengths<br>Replication dimensions"]
        HS["H-space Lengths<br>Hierarchical decomposition<br>[[2,2],[2,2]]"]
        P2RH["P→RH Mappings<br>Thread to hierarchy<br>Major/Minor"]
        Y2RH["Y→RH Mappings<br>Element to hierarchy<br>Major/Minor"]
    end
    
    subgraph "Generated Components"
        ADAPTOR["ps_ys_to_xs_adaptor<br>Coordinate transformer"]
        DESC["ys_to_d_descriptor<br>Memory linearizer"]
        ENC["Encoding<br>Original specification"]
    end
    
    subgraph "Transformation Chain"
        T1["Replicate<br>Transform"]
        T2["Unmerge<br>Transform"]
        T3["Merge<br>Transform"]
    end
    
    RS --&gt; T1
    HS --&gt; T2
    P2RH --&gt; ADAPTOR
    Y2RH --&gt; ADAPTOR
    
    T1 --&gt; T2
    T2 --&gt; T3
    T3 --&gt; ADAPTOR
    
    HS --&gt; DESC
    Y2RH --&gt; DESC
    
    style RS fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    style HS fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    style ADAPTOR fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    style DESC fill:#fff3e0,stroke:#f57c00,stroke-width:3px
</div>
</section>
<section id="what-is-tile-distribution-encoding" class="level2">
<h2 class="anchored" data-anchor-id="what-is-tile-distribution-encoding">What is Tile Distribution Encoding?</h2>
<p>The <code>tile_distribution_encoding</code> struct serves as a compile-time blueprint for defining complex tensor data layouts in GPU programming. It addresses a fundamental challenge in high-performance computing: how to map abstract tensor operations to the hierarchical memory and execution architecture of modern GPUs while maintaining both performance and programmability.</p>
<p>The encoding system operates through a multi-stage transformation pipeline that converts high-level specifications into concrete coordinate mappings. This pipeline consists of three primary components:</p>
<p>The <strong>ps_ys_to_xs_adaptor</strong> performs the crucial transformation from processing element coordinates (P) and logical access pattern coordinates (Y) to physical tensor coordinates (X). This adaptor encodes the complete mapping logic through a chain of coordinate transformations including replicate, unmerge, and merge operations.</p>
<p>The <strong>ys_to_d_descriptor</strong> manages the linearization of the multi-dimensional Y coordinate space into a one-dimensional data space suitable for register allocation. This component ensures efficient register utilization by mapping logical access patterns to physical storage locations.</p>
<p>The <strong>transformation chains</strong> are automatically constructed from the encoding parameters through template metaprogramming, ensuring zero runtime overhead. Each transformation in the chain corresponds to a specific coordinate space manipulation, collectively implementing the complete distribution strategy.</p>
<p>The C++ implementation leverages advanced template metaprogramming techniques:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From ck_tile/core/tensor/tile_distribution_encoding.hpp</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> RsLengths_<span class="op">,</span>    <span class="co">// Replication dimension lengths</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> HsLengthss_<span class="op">,</span>   <span class="co">// Hierarchical dimension lengths</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ps2RHssMajor_<span class="op">,</span> <span class="co">// P to RH mapping (major)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ps2RHssMinor_<span class="op">,</span> <span class="co">// P to RH mapping (minor)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ys2RHsMajor_<span class="op">,</span>  <span class="co">// Y to RH mapping (major)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ys2RHsMinor_<span class="op">&gt;</span>  <span class="co">// Y to RH mapping (minor)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> tile_distribution_encoding</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// All computations resolved at compile time</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> NDimX <span class="op">=</span> HsLengthss<span class="op">::</span>size<span class="op">();</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> NDimP <span class="op">=</span> Ps2RHssMajor<span class="op">::</span>size<span class="op">();</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> NDimY <span class="op">=</span> Ys2RHsMajor<span class="op">::</span>size<span class="op">();</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> NDimR <span class="op">=</span> RsLengths<span class="op">::</span>size<span class="op">();</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Nested detail struct performs complex compile-time calculations</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> detail</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Precomputed mappings and transformations</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">static</span> <span class="kw">constexpr</span> <span class="kw">auto</span> get_h_dim_lengths_prefix_sum<span class="op">();</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">static</span> <span class="kw">constexpr</span> <span class="kw">auto</span> get_uniformed_idx_y_to_h<span class="op">();</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... extensive compile-time computation ...</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="encoding-structure-deep-dive" class="level2">
<h2 class="anchored" data-anchor-id="encoding-structure-deep-dive">Encoding Structure Deep Dive</h2>
<p>The tile distribution encoding employs a sophisticated type system that captures the complete specification of tensor distribution patterns at compile time. Understanding this structure is essential for leveraging the full power of the CK framework’s optimization capabilities.</p>
<p>The encoding revolves around several interconnected dimension types that collectively define the distribution strategy:</p>
<div>
<div id="pyodide-2" class="exercise-cell">

</div>
<script type="pyodide-2-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6InByaW50KFwiVGlsZSBEaXN0cmlidXRpb24gRW5jb2RpbmcgU3RydWN0dXJlXCIpXG5wcmludChcIj1cIiAqIDUwKVxuXG4jIENyZWF0ZSBhIHNpbXBsZSBlbmNvZGluZyB0byBleGFtaW5lXG5lbmNvZGluZyA9IFRpbGVEaXN0cmlidXRpb25FbmNvZGluZyhcbiAgICByc19sZW5ndGhzPVtdLCAgICAgICAgICAgICAgICAgICAgIyBObyByZXBsaWNhdGlvblxuICAgIGhzX2xlbmd0aHNzPVtbMiwgMl0sIFsyLCAyXV0sICAgIyAyeDIgaGllcmFyY2hpY2FsIHRpbGVzXG4gICAgcHNfdG9fcmhzc19tYWpvcj1bWzFdLCBbMl1dLCAgICAgIyBQMCB0byBIMSwgUDEgdG8gSDIgIFxuICAgIHBzX3RvX3Joc3NfbWlub3I9W1swXSwgWzBdXSwgICAgICMgVXNlIGZpcnN0IGNvbXBvbmVudFxuICAgIHlzX3RvX3Joc19tYWpvcj1bMSwgMSwgMiwgMl0sICAgICMgWSBtYXBwaW5nIHRvIEhcbiAgICB5c190b19yaHNfbWlub3I9WzAsIDEsIDAsIDFdICAgICAjIFkgY29tcG9uZW50IHNlbGVjdGlvblxuKVxuXG5wcmludChcIkVuY29kaW5nIFBhcmFtZXRlcnM6XCIpXG5wcmludChmXCIgIHJzX2xlbmd0aHM6IHtlbmNvZGluZy5yc19sZW5ndGhzfVwiKVxucHJpbnQoZlwiICBoc19sZW5ndGhzczoge2VuY29kaW5nLmhzX2xlbmd0aHNzfVwiKVxucHJpbnQoZlwiICBwc190b19yaHNzX21ham9yOiB7ZW5jb2RpbmcucHNfdG9fcmhzc19tYWpvcn1cIilcbnByaW50KGZcIiAgcHNfdG9fcmhzc19taW5vcjoge2VuY29kaW5nLnBzX3RvX3Joc3NfbWlub3J9XCIpXG5wcmludChmXCIgIHlzX3RvX3Joc19tYWpvcjoge2VuY29kaW5nLnlzX3RvX3Joc19tYWpvcn1cIilcbnByaW50KGZcIiAgeXNfdG9fcmhzX21pbm9yOiB7ZW5jb2RpbmcueXNfdG9fcmhzX21pbm9yfVwiKVxuXG5wcmludChcIlxcbkVuY29kaW5nIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5IVwiKSJ9
</script>
</div>
</section>
<section id="c-template-implementation" class="level2">
<h2 class="anchored" data-anchor-id="c-template-implementation">C++ Template Implementation</h2>
<p>The encoding system is implemented as a C++ template struct that leverages compile-time computation for maximum performance:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From include/ck_tile/core/tensor/tile_distribution_encoding.hpp</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> RsLengths_<span class="op">,</span>      <span class="co">// Replication dimensions</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> HsLengthss_<span class="op">,</span>     <span class="co">// Hierarchical dimensions (tuple of tuples)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ps2RHssMajor_<span class="op">,</span>   <span class="co">// P→RH major mapping</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ps2RHssMinor_<span class="op">,</span>   <span class="co">// P→RH minor mapping</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ys2RHsMajor_<span class="op">,</span>    <span class="co">// Y→RH major mapping</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ys2RhsMinor_<span class="op">,</span>    <span class="co">// Y→RH minor mapping</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> RHs2Xs_<span class="op">&gt;</span>         <span class="co">// RH→X final mapping</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> tile_distribution_encoding</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="dt">rs_lengths_type</span> <span class="op">=</span> RsLengths_<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="dt">hs_lengthss_type</span> <span class="op">=</span> HsLengthss_<span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Static member functions for compile-time access</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">constexpr</span> <span class="kw">auto</span> get_rs_lengths<span class="op">()</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dt">rs_lengths_type</span><span class="op">{};</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">constexpr</span> <span class="kw">auto</span> get_hs_lengthss<span class="op">()</span> </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dt">hs_lengthss_type</span><span class="op">{};</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute total number of dimensions</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> get_num_of_dimension_p<span class="op">()</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> size<span class="op">(</span>Ps2RHssMajor_<span class="op">{});</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> get_num_of_dimension_y<span class="op">()</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> size<span class="op">(</span>Ys2RHsMajor_<span class="op">{});</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="key-c-features-used" class="level3">
<h3 class="anchored" data-anchor-id="key-c-features-used">Key C++ Features Used</h3>
<ol type="1">
<li><strong>Template Metaprogramming</strong>: All parameters are types, not values, enabling compile-time optimization</li>
<li><strong>Constexpr Functions</strong>: Everything is computed at compile time</li>
<li><strong>Type Aliases</strong>: Clean access to template parameters</li>
<li><strong>Static Member Functions</strong>: No runtime overhead</li>
</ol>
</section>
</section>
<section id="parameter-breakdown" class="level2">
<h2 class="anchored" data-anchor-id="parameter-breakdown">Parameter Breakdown</h2>
<p>Each template parameter in the encoding system serves a specific purpose in defining the overall distribution strategy. These parameters work together to create a complete specification that can be transformed into efficient GPU code.</p>
<section id="r-dimensions-replication-specification" class="level3">
<h3 class="anchored" data-anchor-id="r-dimensions-replication-specification">R-Dimensions: Replication Specification</h3>
<p>The <code>RsLengths</code> parameter defines dimensions that are replicated across processing units, enabling data sharing patterns essential for many tensor operations. In the transformation pipeline, these dimensions generate <code>coord_transform_enum::replicate</code> operations that broadcast data across multiple processing elements.</p>
<p>Replication serves several critical purposes in GPU kernel optimization. It enables efficient data reuse in operations like matrix multiplication where the same input data is needed by multiple output computations. It also facilitates reduction operations where multiple threads collaborate to compute a single result. The replication pattern directly impacts memory access efficiency and register utilization.</p>
<p>For example, in a GEMM operation: - Matrix A might have <code>RsLengths = sequence&lt;NWarp&gt;</code>, indicating replication across warps computing different N-dimension tiles - Matrix B might have <code>RsLengths = sequence&lt;MWarp&gt;</code>, indicating replication across warps computing different M-dimension tiles - The output matrix C typically has no replication at the outer level, as each element is uniquely owned</p>
</section>
<section id="h-dimensions-hierarchical-decomposition" class="level3">
<h3 class="anchored" data-anchor-id="h-dimensions-hierarchical-decomposition">H-Dimensions: Hierarchical Decomposition</h3>
<p>The <code>HsLengthss</code> parameter represents the hierarchical decomposition of tensor dimensions, encoded as a tuple of sequences. Each sequence defines how a logical tensor dimension (X-dimension) is broken down into finer-grained components that map to the GPU’s execution hierarchy.</p>
<p>This hierarchical decomposition is fundamental to achieving high performance on GPUs. It enables: - <strong>Memory coalescing</strong>: By aligning the decomposition with warp and thread organization - <strong>Register blocking</strong>: By defining tile sizes that fit in the register file - <strong>Shared memory utilization</strong>: By creating tiles that exploit data reuse</p>
<p>The decomposition typically follows a pattern like <code>sequence&lt;RepeatCount, WarpCount, ThreadCount, VectorSize&gt;</code>, where: - <code>RepeatCount</code>: Number of iterations each thread performs - <code>WarpCount</code>: Number of warps assigned to this dimension - <code>ThreadCount</code>: Number of threads per warp assigned to this dimension<br>
- <code>VectorSize</code>: Number of elements accessed in a single vector operation</p>
<p>In the transformation pipeline, each H-dimension group generates <code>coord_transform_enum::unmerge</code> operations that break down abstract dimensions into their hierarchical components:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Example from block GEMM implementation</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="kw">auto</span> hs_lengthss <span class="op">=</span> tuple<span class="op">&lt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    sequence<span class="op">&lt;</span>MIterPerWarp<span class="op">,</span> MWarp<span class="op">&gt;,</span>  <span class="co">// M-dimension decomposition</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    sequence<span class="op">&lt;</span>KIterPerWarp<span class="op">&gt;</span>          <span class="co">// K-dimension decomposition</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="p-dimensions-partition-mapping" class="level3">
<h3 class="anchored" data-anchor-id="p-dimensions-partition-mapping">P-Dimensions: Partition Mapping</h3>
<p>The <code>Ps2RHssMajor</code> and <code>Ps2RHssMinor</code> parameters define how partition dimensions map to the underlying RH-dimensions. Partition dimensions represent the fundamental unit of work assignment in the GPU’s execution model, typically corresponding to hardware constructs like warps and threads.</p>
<p>The mapping mechanism uses a major/minor indexing scheme where: - Major index identifies which RH-dimension group (0 for R-dimensions, 1 to NDimX for H-dimensions) - Minor index identifies the specific component within that group</p>
<p>This mapping enables flexible work distribution strategies. For instance, in a typical block-level distribution: - <code>NDimP = 1</code> might map to <code>{MWarp, NWarp}</code> for distributing work across warp groups - <code>NDimP = 2</code> at the combined level typically maps to <code>{warp_id, lane_id}</code> for thread-level distribution</p>
<p>The P-dimension mapping directly influences memory access patterns and computational efficiency:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// P-dimension retrieval in tile_distribution</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">auto</span> _get_partition_index<span class="op">()</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">constexpr</span><span class="op">(</span>NDimP <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> array<span class="op">&lt;</span><span class="dt">index_t</span><span class="op">,</span> <span class="dv">1</span><span class="op">&gt;{</span>get_lane_id<span class="op">()};</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="kw">constexpr</span><span class="op">(</span>NDimP <span class="op">==</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> array<span class="op">&lt;</span><span class="dt">index_t</span><span class="op">,</span> <span class="dv">2</span><span class="op">&gt;{</span>get_warp_id<span class="op">(),</span> get_lane_id<span class="op">()};</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="y-dimensions-logical-view-mapping" class="level3">
<h3 class="anchored" data-anchor-id="y-dimensions-logical-view-mapping">Y-Dimensions: Logical View Mapping</h3>
<p>The <code>Ys2RHsMajor</code> and <code>Ys2RHsMinor</code> parameters define the logical view of the tile data - how users perceive and access the distributed tensor. Y-dimensions represent the iteration space for accessing tile elements, abstracting away the complexity of the underlying distribution.</p>
<p>The Y-to-RH mapping serves multiple purposes: - <strong>Interface definition</strong>: Provides a clean API for accessing distributed data - <strong>Access pattern encoding</strong>: Defines the order in which elements are processed - <strong>Vectorization support</strong>: Enables efficient vector operations by grouping contiguous elements</p>
<p>In practice, Y-dimensions often correspond to the logical dimensions of the operation being performed. For a matrix multiplication tile: - Y0 might represent the M-dimension iteration space - Y1 might represent the K-dimension iteration space</p>
<p>The mapping ensures that logical access patterns translate to efficient physical memory operations.</p>
<ul>
<li><code>[[4, 4], [4, 4]]</code> → 4x4 tiles (16 elements per thread)</li>
<li><code>[[2, 4], [4, 2]]</code> → 2x4 and 4x2 tiles (8 elements per thread)</li>
</ul>
</section>
<section id="prh-mappings" class="level3">
<h3 class="anchored" data-anchor-id="prh-mappings">P→RH Mappings</h3>
<p><strong>🔹 ps_to_rhss_major/minor (P→RH Mappings)</strong></p>
<p>Maps partition coordinates to RH space: - Controls which H dimensions each P dimension affects - major/minor specify different levels of the mapping</p>
<p><strong>📝 Conceptual Example:</strong> <code>ps_to_rhss_major=[[1], [2]]</code> means: - P dimension 0 maps to H dimension 1 - P dimension 1 maps to H dimension 2</p>
<p>This determines how thread coordinates affect tile placement.</p>
</section>
<section id="yrh-mappings" class="level3">
<h3 class="anchored" data-anchor-id="yrh-mappings">Y→RH Mappings</h3>
<p><strong>🔹 ys_to_rhs_major/minor (Y→RH Mappings)</strong></p>
<p>Maps Y coordinates to RH space: - Determines how logical Y coordinates map to hierarchical structure - Controls the internal organization of each thread’s tile</p>
<p><strong>📝 Example Mapping:</strong> <code>ys_to_rhs_major=[1, 1, 2, 2]</code> means: - Y[0] maps to H1 - Y[1] maps to H1<br>
- Y[2] maps to H2 - Y[3] maps to H2</p>
<p>This creates the internal structure of thread tiles.</p>
</section>
</section>
<section id="from-encoding-to-tile-distribution" class="level2">
<h2 class="anchored" data-anchor-id="from-encoding-to-tile-distribution">From Encoding to Tile Distribution</h2>
<p>The magic happens when <code>make_static_tile_distribution()</code> transforms the mathematical encoding into runtime components:</p>
<div>
<div id="pyodide-3" class="exercise-cell">

</div>
<script type="pyodide-3-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6InByaW50KFwi8J+UpyBGcm9tIEVuY29kaW5nIHRvIFRpbGUgRGlzdHJpYnV0aW9uXCIpXG5wcmludChcIj1cIiAqIDUwKVxuXG5wcmludChcIlRoZSB0cmFuc2Zvcm1hdGlvbiBwcm9jZXNzOlwiKVxucHJpbnQoXCIxLiBBbmFseXplIGVuY29kaW5nIHBhcmFtZXRlcnNcIilcbnByaW50KFwiMi4gQnVpbGQgdHJhbnNmb3JtYXRpb24gY2hhaW5zXCIpXG5wcmludChcIjMuIENyZWF0ZSBydW50aW1lIGNvbXBvbmVudHNcIilcbnByaW50KFwiNC4gT3B0aW1pemUgZm9yIHBlcmZvcm1hbmNlXCIpXG5cbiMgQ3JlYXRlIHRpbGUgZGlzdHJpYnV0aW9uIGZyb20gZW5jb2RpbmdcbnRyeTpcbiAgICB0aWxlX2Rpc3RyaWJ1dGlvbiA9IG1ha2Vfc3RhdGljX3RpbGVfZGlzdHJpYnV0aW9uKGVuY29kaW5nKVxuICAgIFxuICAgIHByaW50KFwiXFxu4pyFIFRpbGUgZGlzdHJpYnV0aW9uIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5IVwiKVxuICAgIHByaW50KFwiXFxu8J+TpiBJbnRlcm5hbCBDb21wb25lbnRzIENyZWF0ZWQ6XCIpXG4gICAgcHJpbnQoXCIgIOKAoiBwc195c190b194c19hZGFwdG9yOiBNYXBzIChQLFkpIGNvb3JkaW5hdGVzIHRvIFggY29vcmRpbmF0ZXNcIilcbiAgICBwcmludChcIiAg4oCiIHlzX3RvX2RfZGVzY3JpcHRvcjogTWFwcyBZIGNvb3JkaW5hdGVzIHRvIGxpbmVhcml6ZWQgc3RvcmFnZVwiKVxuICAgIHByaW50KFwiICDigKIgZW5jb2Rpbmc6IE9yaWdpbmFsIG1hdGhlbWF0aWNhbCBzcGVjaWZpY2F0aW9uXCIpXG4gICAgXG4gICAgIyBTaG93IHRoZSBjb21wb25lbnRzIGV4aXN0XG4gICAgcHJpbnQoZlwiXFxu8J+UjSBDb21wb25lbnQgVmVyaWZpY2F0aW9uOlwiKVxuICAgIGNvbXBvbmVudHMgPSBbXG4gICAgICAgICgncHNfeXNfdG9feHNfYWRhcHRvcicsICdQK1kg4oaSIFggdHJhbnNmb3JtYXRpb24nKSxcbiAgICAgICAgKCd5c190b19kX2Rlc2NyaXB0b3InLCAnWSDihpIgRCBsaW5lYXJpemF0aW9uJyksXG4gICAgICAgICgnZW5jb2RpbmcnLCAnT3JpZ2luYWwgc3BlY2lmaWNhdGlvbicpXG4gICAgXVxuICAgIFxuICAgIGZvciBjb21wb25lbnQsIGRlc2NyaXB0aW9uIGluIGNvbXBvbmVudHM6XG4gICAgICAgIGhhc19jb21wb25lbnQgPSBoYXNhdHRyKHRpbGVfZGlzdHJpYnV0aW9uLCBjb21wb25lbnQpXG4gICAgICAgIHN0YXR1cyA9IFwi4pyFXCIgaWYgaGFzX2NvbXBvbmVudCBlbHNlIFwi4p2MXCJcbiAgICAgICAgcHJpbnQoZlwiICB7c3RhdHVzfSB7Y29tcG9uZW50fToge2Rlc2NyaXB0aW9ufVwiKVxuICAgICAgICBcbmV4Y2VwdCBFeGNlcHRpb24gYXMgZTpcbiAgICBwcmludChmXCLimqDvuI8gQ3JlYXRpb24gZmFpbGVkOiB7ZX1cIilcbiAgICBwcmludChcIk5vdGU6IFRoaXMgZGVtb25zdHJhdGVzIHRoZSBjb25jZXB0IGV2ZW4gaWYgY3JlYXRpb24gZmFpbHNcIikifQ==
</script>
</div>
</section>
<section id="the-py-x-transformation-chain" class="level2">
<h2 class="anchored" data-anchor-id="the-py-x-transformation-chain">The P+Y → X Transformation Chain</h2>
<p>The heart of the system is the adaptor that implements the P+Y → X transformation.</p>
<div class="mermaid">
flowchart LR
    subgraph "Input Coordinates"
        P["P-coordinates<br>[warp_id, lane_id]"]
        Y["Y-coordinates<br>[y0, y1, y2, y3]"]
    end
    
    subgraph "Transformation Pipeline"
        C1["Combine P+Y"]
        T1["Replicate<br>Transform<br>(if R-dims exist)"]
        T2["Unmerge<br>Transform<br>(break into H-dims)"]
        T3["Merge<br>Transform<br>(combine to X-dims)"]
    end
    
    subgraph "Output"
        X["X-coordinates<br>[x0, x1]<br>Tensor position"]
    end
    
    P --&gt; C1
    Y --&gt; C1
    C1 --&gt; T1
    T1 --&gt; T2
    T2 --&gt; T3
    T3 --&gt; X
    
    style P fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style Y fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    style X fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
</div>
<section id="c-transformation-chain-implementation" class="level3">
<h3 class="anchored" data-anchor-id="c-transformation-chain-implementation">C++ Transformation Chain Implementation</h3>
<p>The transformation chain is built using C++ template metaprogramming to create a compile-time pipeline:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Building the transformation chain in make_static_tile_distribution</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> Encoding<span class="op">&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>CK_TILE_HOST_DEVICE <span class="kw">auto</span> make_ps_ys_to_xs_adaptor<span class="op">(</span><span class="at">const</span> Encoding<span class="op">&amp;</span> encoding<span class="op">)</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Step 1: Create individual transforms</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="kw">auto</span> replicate_transform <span class="op">=</span> make_replicate_transform<span class="op">(</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        encoding<span class="op">.</span>get_rs_lengths<span class="op">());</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="kw">auto</span> unmerge_transform <span class="op">=</span> make_unmerge_transform<span class="op">(</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        encoding<span class="op">.</span>get_hs_lengthss<span class="op">());</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="kw">auto</span> merge_transform <span class="op">=</span> make_merge_transform<span class="op">(</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        encoding<span class="op">.</span>get_rhs_to_xs_mapping<span class="op">());</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Step 2: Chain transforms together</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="kw">auto</span> transform_chain <span class="op">=</span> chain_transforms<span class="op">(</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        replicate_transform<span class="op">,</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        unmerge_transform<span class="op">,</span> </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        merge_transform<span class="op">);</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Step 3: Create adaptor with the chain</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> make_tile_adaptor<span class="op">(</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        transform_chain<span class="op">,</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        encoding<span class="op">.</span>get_lower_dimension_hidden_idss<span class="op">());</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="how-transforms-work-in-c" class="level3">
<h3 class="anchored" data-anchor-id="how-transforms-work-in-c">How Transforms Work in C++</h3>
<p>Each transform is a compile-time object that knows how to convert coordinates:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: Replicate transform implementation</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> Lengths<span class="op">&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> replicate_transform</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> num_of_upper_dimension <span class="op">=</span> size<span class="op">(</span>Lengths<span class="op">{});</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> num_of_lower_dimension <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> num_of_upper_dimension<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> UpperIndex<span class="op">&gt;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="kw">constexpr</span> <span class="kw">auto</span> </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    calculate_lower_index<span class="op">(</span><span class="at">const</span> UpperIndex<span class="op">&amp;</span> idx_upper<span class="op">)</span> <span class="at">const</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Replicate each coordinate: [a,b] -&gt; [a,b,0,0]</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> idx_lower <span class="op">=</span> make_zero_multi_index<span class="op">&lt;</span>num_of_lower_dimension<span class="op">&gt;();</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        static_for<span class="op">&lt;</span><span class="dv">0</span><span class="op">,</span> num_of_upper_dimension<span class="op">,</span> <span class="dv">1</span><span class="op">&gt;{}([&amp;](</span><span class="kw">auto</span> i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            idx_lower<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> idx_upper<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            idx_lower<span class="op">(</span>i <span class="op">+</span> num_of_upper_dimension<span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> idx_lower<span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>🔗 The P+Y → X Transformation Chain</strong></p>
<p>The <code>ps_ys_to_xs_adaptor</code> implements a chain of transformations: 1. Start with P coordinates (which thread) 2. Add Y coordinates (which element in thread’s tile) 3. Apply replication transforms (R-space) 4. Apply hierarchical transforms (H-space) 5. Merge into final X coordinates</p>
<p><strong>💡 Why This Chain Works:</strong> - Each transform handles one aspect of the mapping - Transforms are composable and efficient - The chain is built automatically from encoding - Same pattern works for any distribution strategy</p>
<p><strong>📝 Conceptual Example:</strong> - Input: P=[1,0] + Y=[0,1] → Combined=[1,0,0,1] - Transform 1: Handle replication (none in this case) - Transform 2: Handle hierarchical structure - Transform 3: Merge to final coordinates - Output: X=[0,3] (final tensor position)</p>
</section>
</section>
<section id="the-y-to-d-linearization" class="level2">
<h2 class="anchored" data-anchor-id="the-y-to-d-linearization">The Y to D Linearization</h2>
<p>The descriptor handles the linearization of Y coordinates to memory addresses.</p>
<section id="c-implementation-of-yd-descriptor" class="level3">
<h3 class="anchored" data-anchor-id="c-implementation-of-yd-descriptor">C++ Implementation of Y→D Descriptor</h3>
<p>The Y→D descriptor is responsible for converting multi-dimensional Y coordinates into linear memory offsets:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Y to D descriptor implementation</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> YLengths<span class="op">,</span> <span class="kw">typename</span> YStrides<span class="op">&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ys_to_d_descriptor</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> num_of_dimension <span class="op">=</span> size<span class="op">(</span>YLengths<span class="op">{});</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate linear offset from Y coordinates</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> YIndex<span class="op">&gt;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="kw">constexpr</span> <span class="dt">index_t</span> </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    calculate_offset<span class="op">(</span><span class="at">const</span> YIndex<span class="op">&amp;</span> idx_y<span class="op">)</span> <span class="at">const</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">index_t</span> offset <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        static_for<span class="op">&lt;</span><span class="dv">0</span><span class="op">,</span> num_of_dimension<span class="op">,</span> <span class="dv">1</span><span class="op">&gt;{}([&amp;](</span><span class="kw">auto</span> i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            offset <span class="op">+=</span> idx_y<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> YStrides<span class="op">{}[</span>i<span class="op">];</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> offset<span class="op">;</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get element space size (total elements per thread)</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    get_element_space_size<span class="op">()</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> reduce_on_sequence<span class="op">(</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            YLengths<span class="op">{},</span> </span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>            multiplies<span class="op">{},</span> </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>            number<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;{});</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage in distributed tensor</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> TileDistribution<span class="op">&gt;</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> static_distributed_tensor</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> ys_to_d_descriptor <span class="op">=</span> <span class="kw">typename</span> TileDistribution<span class="op">::</span>ys_to_d_descriptor<span class="op">;</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Thread-local storage</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> thread_buffer_size <span class="op">=</span> </span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        ys_to_d_descriptor<span class="op">::</span>get_element_space_size<span class="op">();</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    DataType <span class="va">thread_buffer_</span><span class="op">[</span>thread_buffer_size<span class="op">];</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Access element at Y coordinate</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> YIndex<span class="op">&gt;</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE DataType<span class="op">&amp;</span> at<span class="op">(</span><span class="at">const</span> YIndex<span class="op">&amp;</span> idx_y<span class="op">)</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="dt">index_t</span> offset <span class="op">=</span> ys_to_d_descriptor<span class="op">{}.</span>calculate_offset<span class="op">(</span>idx_y<span class="op">);</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">thread_buffer_</span><span class="op">[</span>offset<span class="op">];</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="memory-layout-optimization" class="level3">
<h3 class="anchored" data-anchor-id="memory-layout-optimization">Memory Layout Optimization</h3>
<p>The descriptor enables efficient register allocation:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Optimized layout for vector operations</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="dt">index_t</span> M<span class="op">,</span> <span class="dt">index_t</span> N<span class="op">,</span> <span class="dt">index_t</span> VectorSize<span class="op">&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> make_ys_to_d_descriptor_for_gemm</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Layout: [M/VectorSize][N][VectorSize]</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This ensures vector loads are contiguous in memory</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> type <span class="op">=</span> tile_descriptor<span class="op">&lt;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        sequence<span class="op">&lt;</span>M<span class="op">/</span>VectorSize<span class="op">,</span> N<span class="op">,</span> VectorSize<span class="op">&gt;,</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        sequence<span class="op">&lt;</span>N <span class="op">*</span> VectorSize<span class="op">,</span> VectorSize<span class="op">,</span> <span class="dv">1</span><span class="op">&gt;&gt;;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="y-to-d-linearization-details" class="level3">
<h3 class="anchored" data-anchor-id="y-to-d-linearization-details">Y to D Linearization Details</h3>
<p>The <code>ys_to_d_descriptor</code> handles memory layout within each thread: 1. Start with Y coordinates [y0, y1, y2, y3] 2. Apply thread’s local layout (usually row-major) 3. Compute linear offset within thread’s buffer 4. Result: D coordinate (memory address)</p>
<p><strong>📝 Example with [2, 2] tile:</strong> - Y=[0,0] → D=0 - Y=[0,1] → D=1 - Y=[1,0] → D=2 - Y=[1,1] → D=3</p>
<p><strong>💡 Why Separate from Adaptor:</strong> - Adaptor handles inter-thread coordination (P+Y → X) - Descriptor handles intra-thread layout (Y → D) - This separation enables different memory layouts - Each thread can have its own descriptor</p>
</section>
</section>
<section id="practical-examples" class="level2">
<h2 class="anchored" data-anchor-id="practical-examples">Practical Examples</h2>
<p>Different encodings create different behaviors:</p>
<p><strong>🎯 Example 1: Simple 2x2 Distribution</strong></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>simple_encoding <span class="op">=</span> TileDistributionEncoding(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    rs_lengths<span class="op">=</span>[],</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    hs_lengthss<span class="op">=</span>[[<span class="dv">2</span>], [<span class="dv">2</span>]],</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    ps_to_rhss_major<span class="op">=</span>[[], []],</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    ps_to_rhss_minor<span class="op">=</span>[[], []],</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    ys_to_rhs_major<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    ys_to_rhs_minor<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>No replication</li>
<li>Simple hierarchical structure</li>
<li>Direct P→H mapping</li>
<li>Good for basic matrix operations</li>
</ul>
<p><strong>🎯 Example 2: With Replication</strong></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>replicated_encoding <span class="op">=</span> TileDistributionEncoding(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    rs_lengths<span class="op">=</span>[<span class="dv">2</span>],  <span class="co"># 2-way replication</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    hs_lengthss<span class="op">=</span>[[<span class="dv">2</span>], [<span class="dv">2</span>]],</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    ps_to_rhss_major<span class="op">=</span>[[], []],</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    ps_to_rhss_minor<span class="op">=</span>[[], []],</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    ys_to_rhs_major<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    ys_to_rhs_minor<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>2-way replication for data sharing</li>
<li>Same hierarchical structure</li>
<li>Good for broadcast operations</li>
<li>Enables thread cooperation</li>
</ul>
</section>
<section id="testing-your-understanding" class="level2">
<h2 class="anchored" data-anchor-id="testing-your-understanding">Testing Your Understanding</h2>
<p>Let’s verify your understanding of encoding internals:</p>
<div>
<div id="pyodide-4" class="exercise-cell">

</div>
<script type="pyodide-4-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOmZhbHNlLCJlZGl0Ijp0cnVlLCJldmFsIjp0cnVlfSwiY29kZSI6InByaW50KFwi8J+nqiBUZXN0aW5nIEVuY29kaW5nIEludGVybmFscyBVbmRlcnN0YW5kaW5nXCIpXG5wcmludChcIj1cIiAqIDUwKVxuXG5kZWYgdGVzdF9lbmNvZGluZ19jcmVhdGlvbigpOlxuICAgIFwiXCJcIlRlc3QgdGhhdCB3ZSBjYW4gY3JlYXRlIHZhbGlkIGVuY29kaW5ncy5cIlwiXCJcbiAgICB0cnk6XG4gICAgICAgIHRlc3RfZW5jb2RpbmcgPSBUaWxlRGlzdHJpYnV0aW9uRW5jb2RpbmcoXG4gICAgICAgICAgICByc19sZW5ndGhzPVtdLFxuICAgICAgICAgICAgaHNfbGVuZ3Roc3M9W1syXSwgWzJdXSxcbiAgICAgICAgICAgIHBzX3RvX3Joc3NfbWFqb3I9W1tdLCBbXV0sXG4gICAgICAgICAgICBwc190b19yaHNzX21pbm9yPVtbXSwgW11dLFxuICAgICAgICAgICAgeXNfdG9fcmhzX21ham9yPVsxLCAyXSxcbiAgICAgICAgICAgIHlzX3RvX3Joc19taW5vcj1bMCwgMF1cbiAgICAgICAgKVxuICAgICAgICByZXR1cm4gVHJ1ZVxuICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZTpcbiAgICAgICAgcHJpbnQoZlwiRXJyb3I6IHtlfVwiKVxuICAgICAgICByZXR1cm4gRmFsc2VcblxuZGVmIHRlc3RfZW5jb2RpbmdfaGFzX3JlcXVpcmVkX2ZpZWxkcygpOlxuICAgIFwiXCJcIlRlc3QgdGhhdCBlbmNvZGluZyBoYXMgYWxsIHJlcXVpcmVkIGZpZWxkcy5cIlwiXCJcbiAgICBlbmNvZGluZyA9IFRpbGVEaXN0cmlidXRpb25FbmNvZGluZyhcbiAgICAgICAgcnNfbGVuZ3Rocz1bXSxcbiAgICAgICAgaHNfbGVuZ3Roc3M9W1syXSwgWzJdXSxcbiAgICAgICAgcHNfdG9fcmhzc19tYWpvcj1bW10sIFtdXSxcbiAgICAgICAgcHNfdG9fcmhzc19taW5vcj1bW10sIFtdXSxcbiAgICAgICAgeXNfdG9fcmhzX21ham9yPVsxLCAyXSxcbiAgICAgICAgeXNfdG9fcmhzX21pbm9yPVswLCAwXVxuICAgIClcbiAgICBcbiAgICByZXF1aXJlZF9maWVsZHMgPSBbXG4gICAgICAgICdyc19sZW5ndGhzJywgJ2hzX2xlbmd0aHNzJywgJ3BzX3RvX3Joc3NfbWFqb3InLCBcbiAgICAgICAgJ3BzX3RvX3Joc3NfbWlub3InLCAneXNfdG9fcmhzX21ham9yJywgJ3lzX3RvX3Joc19taW5vcidcbiAgICBdXG4gICAgXG4gICAgZm9yIGZpZWxkIGluIHJlcXVpcmVkX2ZpZWxkczpcbiAgICAgICAgaWYgbm90IGhhc2F0dHIoZW5jb2RpbmcsIGZpZWxkKTpcbiAgICAgICAgICAgIHJldHVybiBGYWxzZVxuICAgIHJldHVybiBUcnVlXG5cbmRlZiB0ZXN0X2RpZmZlcmVudF9lbmNvZGluZ3MoKTpcbiAgICBcIlwiXCJUZXN0IGNyZWF0aW5nIGRpZmZlcmVudCB0eXBlcyBvZiBlbmNvZGluZ3MuXCJcIlwiXG4gICAgZW5jb2RpbmdzID0gW1xuICAgICAgICAjIFNpbXBsZSBlbmNvZGluZ1xuICAgICAgICBUaWxlRGlzdHJpYnV0aW9uRW5jb2RpbmcoXG4gICAgICAgICAgICByc19sZW5ndGhzPVtdLFxuICAgICAgICAgICAgaHNfbGVuZ3Roc3M9W1syXSwgWzJdXSxcbiAgICAgICAgICAgIHBzX3RvX3Joc3NfbWFqb3I9W1tdLCBbXV0sXG4gICAgICAgICAgICBwc190b19yaHNzX21pbm9yPVtbXSwgW11dLFxuICAgICAgICAgICAgeXNfdG9fcmhzX21ham9yPVsxLCAyXSxcbiAgICAgICAgICAgIHlzX3RvX3Joc19taW5vcj1bMCwgMF1cbiAgICAgICAgKSxcbiAgICAgICAgIyBXaXRoIHJlcGxpY2F0aW9uXG4gICAgICAgIFRpbGVEaXN0cmlidXRpb25FbmNvZGluZyhcbiAgICAgICAgICAgIHJzX2xlbmd0aHM9WzJdLFxuICAgICAgICAgICAgaHNfbGVuZ3Roc3M9W1syXSwgWzJdXSxcbiAgICAgICAgICAgIHBzX3RvX3Joc3NfbWFqb3I9W1tdLCBbXV0sXG4gICAgICAgICAgICBwc190b19yaHNzX21pbm9yPVtbXSwgW11dLFxuICAgICAgICAgICAgeXNfdG9fcmhzX21ham9yPVsxLCAyXSxcbiAgICAgICAgICAgIHlzX3RvX3Joc19taW5vcj1bMCwgMF1cbiAgICAgICAgKVxuICAgIF1cbiAgICBcbiAgICByZXR1cm4gbGVuKGVuY29kaW5ncykgPT0gMlxuXG4jIFJ1biB0ZXN0c1xudGVzdHMgPSBbXG4gICAgKFwiRW5jb2RpbmcgY3JlYXRpb25cIiwgdGVzdF9lbmNvZGluZ19jcmVhdGlvbiksXG4gICAgKFwiUmVxdWlyZWQgZmllbGRzXCIsIHRlc3RfZW5jb2RpbmdfaGFzX3JlcXVpcmVkX2ZpZWxkcyksXG4gICAgKFwiRGlmZmVyZW50IGVuY29kaW5nc1wiLCB0ZXN0X2RpZmZlcmVudF9lbmNvZGluZ3MpXG5dXG5cbnByaW50KFwiUnVubmluZyBlbmNvZGluZyBpbnRlcm5hbHMgdGVzdHM6XCIpXG5mb3IgdGVzdF9uYW1lLCB0ZXN0X2Z1bmMgaW4gdGVzdHM6XG4gICAgdHJ5OlxuICAgICAgICByZXN1bHQgPSB0ZXN0X2Z1bmMoKVxuICAgICAgICBzdGF0dXMgPSBcIlBBU1NcIiBpZiByZXN1bHQgZWxzZSBcIkZBSUxcIlxuICAgICAgICBwcmludChmXCIgIFt7c3RhdHVzfV0ge3Rlc3RfbmFtZX1cIilcbiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6XG4gICAgICAgIHByaW50KGZcIiAgW0VSUk9SXSB7dGVzdF9uYW1lfSAtIHtzdHIoZSl9XCIpIn0=
</script>
</div>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<p>The tile distribution encoding system represents a sophisticated solution to the challenge of mapping high-level tensor operations to GPU hardware. Understanding its internals reveals several key architectural principles:</p>
<section id="mathematical-foundation" class="level3">
<h3 class="anchored" data-anchor-id="mathematical-foundation">Mathematical Foundation</h3>
<p>The encoding structure provides a complete mathematical specification of thread organization and data distribution:</p>
<ol type="1">
<li><strong>Dimensional Hierarchy</strong>: The system defines four types of dimensions (R, H, P, Y) that collectively describe the complete distribution strategy</li>
<li><strong>Compile-Time Resolution</strong>: All relationships and transformations are resolved at compile time, ensuring zero runtime overhead</li>
<li><strong>Composable Transformations</strong>: Individual coordinate transformations (replicate, unmerge, merge) compose to create complex mappings</li>
<li><strong>Hardware Alignment</strong>: The hierarchical decomposition naturally aligns with GPU hardware organization</li>
</ol>
</section>
<section id="automatic-code-generation" class="level3">
<h3 class="anchored" data-anchor-id="automatic-code-generation">Automatic Code Generation</h3>
<p>The transformation from mathematical specification to executable code happens through a sophisticated pipeline:</p>
<ol type="1">
<li><strong>Encoding Analysis</strong>: The <code>make_adaptor_encoding_for_tile_distribution</code> function analyzes the encoding parameters</li>
<li><strong>Transform Chain Construction</strong>: Individual transformations are instantiated and connected based on the specification</li>
<li><strong>Optimization Application</strong>: Compile-time optimizations eliminate overhead and generate efficient code</li>
<li><strong>Component Integration</strong>: The generated adaptors and descriptors integrate seamlessly with the broader CK framework</li>
</ol>
</section>
<section id="component-architecture" class="level3">
<h3 class="anchored" data-anchor-id="component-architecture">Component Architecture</h3>
<p>The clean separation of concerns enables both flexibility and performance:</p>
<ul>
<li>The <strong>ps_ys_to_xs_adaptor</strong> handles the complex mapping from logical to physical coordinates</li>
<li>The <strong>ys_to_d_descriptor</strong> manages efficient linearization for register allocation</li>
<li>Each component has a well-defined interface enabling independent optimization</li>
<li>Components compose naturally to create complete distribution systems</li>
</ul>
</section>
<section id="performance-implications" class="level3">
<h3 class="anchored" data-anchor-id="performance-implications">Performance Implications</h3>
<p>Every aspect of the encoding system is designed with GPU performance in mind:</p>
<ul>
<li><strong>Memory Coalescing</strong>: Hierarchical decomposition ensures adjacent threads access adjacent memory</li>
<li><strong>Register Efficiency</strong>: Y-to-D linearization optimizes register allocation and minimizes spills</li>
<li><strong>Bank Conflict Avoidance</strong>: Careful dimension ordering prevents shared memory bank conflicts</li>
<li><strong>Vectorization Support</strong>: The encoding naturally supports vector operations for maximum throughput</li>
</ul>
</section>
<section id="practical-applications" class="level3">
<h3 class="anchored" data-anchor-id="practical-applications">Practical Applications</h3>
<p>The encoding system’s flexibility enables efficient implementation of diverse operations:</p>
<ul>
<li><strong>Matrix Multiplication</strong>: Hierarchical tiling with appropriate replication patterns</li>
<li><strong>Convolution</strong>: Spatial tiling with proper boundary handling</li>
<li><strong>Reduction Operations</strong>: Collaborative patterns through R-dimension specification</li>
<li><strong>Complex Fusion</strong>: Multiple operations can share distribution patterns for efficiency</li>
</ul>
<p>The encoding internals demonstrate how the Composable Kernel framework achieves both mathematical elegance and practical performance. By leveraging compile-time computation and sophisticated type system design, the same mathematical framework that provides clarity and composability also generates code that rivals hand-optimized implementations. This synergy between abstraction and performance represents the core strength of the CK approach to GPU kernel development.</p>


<!-- -->

<script type="pyodide-data">
eyJvcHRpb25zIjp7ImVudiI6eyJQTE9UTFlfUkVOREVSRVIiOiJwbG90bHlfbWltZXR5cGUifSwiaW5kZXhVUkwiOiJodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvcHlvZGlkZS92MC4yNy4wL2Z1bGwvIn0sInBhY2thZ2VzIjp7InBrZ3MiOlsicHlvZGlkZV9odHRwIiwibWljcm9waXAiLCJpcHl0aG9uIiwibnVtcHkiLCJwYW5kYXMiLCJzeW1weSIsIm1pY3JvcGlwIl19fQ==
</script>
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W3siY2VsbE5hbWUiOiJweW9kaWRlLTQiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoidmlld29mIF9weW9kaWRlX2VkaXRvcl80ID0ge1xuICBjb25zdCB7IFB5b2RpZGVFeGVyY2lzZUVkaXRvciwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS00LWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtNC1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBQeW9kaWRlRXhlcmNpc2VFZGl0b3IoXG4gICAgcHlvZGlkZU9qcy5weW9kaWRlUHJvbWlzZSxcbiAgICBibG9jay5jb2RlLFxuICAgIG9wdGlvbnNcbiAgKTtcblxuICByZXR1cm4gZWRpdG9yLmNvbnRhaW5lcjtcbn1cbl9weW9kaWRlX3ZhbHVlXzQgPSBweW9kaWRlT2pzLnByb2Nlc3MoX3B5b2RpZGVfZWRpdG9yXzQsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTMiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoidmlld29mIF9weW9kaWRlX2VkaXRvcl8zID0ge1xuICBjb25zdCB7IFB5b2RpZGVFeGVyY2lzZUVkaXRvciwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS0zLWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtMy1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBQeW9kaWRlRXhlcmNpc2VFZGl0b3IoXG4gICAgcHlvZGlkZU9qcy5weW9kaWRlUHJvbWlzZSxcbiAgICBibG9jay5jb2RlLFxuICAgIG9wdGlvbnNcbiAgKTtcblxuICByZXR1cm4gZWRpdG9yLmNvbnRhaW5lcjtcbn1cbl9weW9kaWRlX3ZhbHVlXzMgPSBweW9kaWRlT2pzLnByb2Nlc3MoX3B5b2RpZGVfZWRpdG9yXzMsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTIiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoidmlld29mIF9weW9kaWRlX2VkaXRvcl8yID0ge1xuICBjb25zdCB7IFB5b2RpZGVFeGVyY2lzZUVkaXRvciwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS0yLWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHB5b2RpZGUtMi1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBQeW9kaWRlRXhlcmNpc2VFZGl0b3IoXG4gICAgcHlvZGlkZU9qcy5weW9kaWRlUHJvbWlzZSxcbiAgICBibG9jay5jb2RlLFxuICAgIG9wdGlvbnNcbiAgKTtcblxuICByZXR1cm4gZWRpdG9yLmNvbnRhaW5lcjtcbn1cbl9weW9kaWRlX3ZhbHVlXzIgPSBweW9kaWRlT2pzLnByb2Nlc3MoX3B5b2RpZGVfZWRpdG9yXzIsIHt9KTtcbiJ9LHsiY2VsbE5hbWUiOiJweW9kaWRlLTEiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0Iiwic291cmNlIjoiX3B5b2RpZGVfdmFsdWVfMSA9IHtcbiAgY29uc3QgeyBoaWdobGlnaHRQeXRob24sIGI2NERlY29kZX0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwicHlvZGlkZS0xLWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgLy8gRGVmYXVsdCBldmFsdWF0aW9uIGNvbmZpZ3VyYXRpb25cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe1xuICAgIGlkOiBcInB5b2RpZGUtMS1jb250ZW50c1wiLFxuICAgIGVjaG86IHRydWUsXG4gICAgb3V0cHV0OiB0cnVlXG4gIH0sIGJsb2NrLmF0dHIpO1xuXG4gIC8vIEV2YWx1YXRlIHRoZSBwcm92aWRlZCBQeXRob24gY29kZVxuICBjb25zdCByZXN1bHQgPSBweW9kaWRlT2pzLnByb2Nlc3Moe2NvZGU6IGJsb2NrLmNvZGUsIG9wdGlvbnN9LCB7fSk7XG5cbiAgLy8gRWFybHkgeWllbGQgd2hpbGUgd2Ugd2FpdCBmb3IgdGhlIGZpcnN0IGV2YWx1YXRpb24gYW5kIHJlbmRlclxuICBpZiAob3B0aW9ucy5vdXRwdXQgJiYgIShcIjFcIiBpbiBweW9kaWRlT2pzLnJlbmRlcmVkT2pzKSkge1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgY29uc3Qgc3Bpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG5cbiAgICBpZiAob3B0aW9ucy5lY2hvKSB7XG4gICAgICAvLyBTaG93IG91dHB1dCBhcyBoaWdobGlnaHRlZCBzb3VyY2VcbiAgICAgIGNvbnN0IHByZUVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwicHJlXCIpO1xuICAgICAgY29udGFpbmVyLmNsYXNzTmFtZSA9IFwic291cmNlQ29kZVwiO1xuICAgICAgcHJlRWxlbS5jbGFzc05hbWUgPSBcInNvdXJjZUNvZGUgcHl0aG9uXCI7XG4gICAgICBwcmVFbGVtLmFwcGVuZENoaWxkKGhpZ2hsaWdodFB5dGhvbihibG9jay5jb2RlKSk7XG4gICAgICBzcGlubmVyLmNsYXNzTmFtZSA9IFwic3Bpbm5lci1ncm93IHNwaW5uZXItZ3Jvdy1zbSBtLTIgcG9zaXRpb24tYWJzb2x1dGUgdG9wLTAgZW5kLTBcIjtcbiAgICAgIHByZUVsZW0uYXBwZW5kQ2hpbGQoc3Bpbm5lcik7XG4gICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQocHJlRWxlbSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNwaW5uZXIuY2xhc3NOYW1lID0gXCJzcGlubmVyLWJvcmRlciBzcGlubmVyLWJvcmRlci1zbVwiO1xuICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHNwaW5uZXIpO1xuICAgIH1cblxuICAgIHlpZWxkIGNvbnRhaW5lcjtcbiAgfVxuXG4gIHB5b2RpZGVPanMucmVuZGVyZWRPanNbXCIxXCJdID0gdHJ1ZTtcbiAgeWllbGQgYXdhaXQgcmVzdWx0O1xufVxuIn0seyJjZWxsTmFtZSI6InB5b2RpZGUtcHJlbHVkZSIsImlubGluZSI6ZmFsc2UsIm1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InB5b2RpZGVPanMgPSB7XG4gIGNvbnN0IHtcbiAgICBQeW9kaWRlRXZhbHVhdG9yLFxuICAgIFB5b2RpZGVFbnZpcm9ubWVudE1hbmFnZXIsXG4gICAgc2V0dXBQeXRob24sXG4gICAgc3RhcnRQeW9kaWRlV29ya2VyLFxuICAgIGI2NERlY29kZSxcbiAgICBjb2xsYXBzZVBhdGgsXG4gIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHN0YXR1c0NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZXhlcmNpc2UtbG9hZGluZy1zdGF0dXNcIik7XG4gIGNvbnN0IGluZGljYXRvckNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZXhlcmNpc2UtbG9hZGluZy1pbmRpY2F0b3JcIik7XG4gIGluZGljYXRvckNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKFwiZC1ub25lXCIpO1xuXG4gIGxldCBzdGF0dXNUZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKVxuICBzdGF0dXNUZXh0LmNsYXNzTGlzdCA9IFwiZXhlcmNpc2UtbG9hZGluZy1kZXRhaWxzXCI7XG4gIHN0YXR1c1RleHQgPSBzdGF0dXNDb250YWluZXIuYXBwZW5kQ2hpbGQoc3RhdHVzVGV4dCk7XG4gIHN0YXR1c1RleHQudGV4dENvbnRlbnQgPSBgSW5pdGlhbGlzZWA7XG5cbiAgLy8gSG9pc3QgaW5kaWNhdG9yIG91dCBmcm9tIGZpbmFsIHNsaWRlIHdoZW4gcnVubmluZyB1bmRlciByZXZlYWxcbiAgY29uc3QgcmV2ZWFsU3RhdHVzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5yZXZlYWwgLmV4ZXJjaXNlLWxvYWRpbmctaW5kaWNhdG9yXCIpO1xuICBpZiAocmV2ZWFsU3RhdHVzKSB7XG4gICAgcmV2ZWFsU3RhdHVzLnJlbW92ZSgpO1xuICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucmV2ZWFsID4gLnNsaWRlc1wiKS5hcHBlbmRDaGlsZChyZXZlYWxTdGF0dXMpO1xuICB9XG5cbiAgLy8gTWFrZSBhbnkgcmV2ZWFsIHNsaWRlcyB3aXRoIGxpdmUgY2VsbHMgc2Nyb2xsYWJsZVxuICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLnJldmVhbCAuZXhlcmNpc2UtY2VsbFwiKS5mb3JFYWNoKChlbCkgPT4ge1xuICAgIGVsLmNsb3Nlc3QoJ3NlY3Rpb24uc2xpZGUnKS5jbGFzc0xpc3QuYWRkKFwic2Nyb2xsYWJsZVwiKTtcbiAgfSlcblxuICAvLyBQeW9kaWRlIHN1cHBsZW1lbnRhbCBkYXRhIGFuZCBvcHRpb25zXG4gIGNvbnN0IGRhdGFDb250ZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihgc2NyaXB0W3R5cGU9XFxcInB5b2RpZGUtZGF0YVxcXCJdYCkudGV4dENvbnRlbnQ7XG4gIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGI2NERlY29kZShkYXRhQ29udGVudCkpO1xuXG4gIC8vIEdyYWIgbGlzdCBvZiByZXNvdXJjZXMgdG8gYmUgZG93bmxvYWRlZFxuICBjb25zdCBmaWxlc0NvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwidmZzLWZpbGVcXFwiXWApLnRleHRDb250ZW50O1xuICBjb25zdCBmaWxlcyA9IEpTT04ucGFyc2UoYjY0RGVjb2RlKGZpbGVzQ29udGVudCkpO1xuXG4gIGxldCBweW9kaWRlUHJvbWlzZSA9IChhc3luYyAoKSA9PiB7XG4gICAgc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9IGBEb3dubG9hZGluZyBQeW9kaWRlYDtcbiAgICBjb25zdCBweW9kaWRlID0gYXdhaXQgc3RhcnRQeW9kaWRlV29ya2VyKGRhdGEub3B0aW9ucyk7XG5cbiAgICBzdGF0dXNUZXh0LnRleHRDb250ZW50ID0gYERvd25sb2FkaW5nIHBhY2thZ2U6IG1pY3JvcGlwYDtcbiAgICBhd2FpdCBweW9kaWRlLmxvYWRQYWNrYWdlKFwibWljcm9waXBcIik7XG4gICAgY29uc3QgbWljcm9waXAgPSBhd2FpdCBweW9kaWRlLnB5aW1wb3J0KFwibWljcm9waXBcIik7XG4gICAgYXdhaXQgZGF0YS5wYWNrYWdlcy5wa2dzLm1hcCgocGtnKSA9PiAoKSA9PiB7XG4gICAgICBzdGF0dXNUZXh0LnRleHRDb250ZW50ID0gYERvd25sb2FkaW5nIHBhY2thZ2U6ICR7cGtnfWA7XG4gICAgICByZXR1cm4gbWljcm9waXAuaW5zdGFsbChwa2cpO1xuICAgIH0pLnJlZHVjZSgoY3VyLCBuZXh0KSA9PiBjdXIudGhlbihuZXh0KSwgUHJvbWlzZS5yZXNvbHZlKCkpO1xuICAgIGF3YWl0IG1pY3JvcGlwLmRlc3Ryb3koKTtcblxuICAgIC8vIERvd25sb2FkIGFuZCBpbnN0YWxsIHJlc291cmNlc1xuICAgIGF3YWl0IGZpbGVzLm1hcCgoZmlsZSkgPT4gYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbmFtZSA9IGZpbGUuc3Vic3RyaW5nKGZpbGUubGFzdEluZGV4T2YoJy8nKSArIDEpO1xuICAgICAgc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9IGBEb3dubG9hZGluZyByZXNvdXJjZTogJHtuYW1lfWA7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGZpbGUpO1xuICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbid0IGRvd25sb2FkIFxcYCR7ZmlsZX1cXGAuIEVycm9yICR7cmVzcG9uc2Uuc3RhdHVzfTogXCIke3Jlc3BvbnNlLnN0YXR1c1RleHR9XCIuYCk7XG4gICAgICB9XG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuYXJyYXlCdWZmZXIoKTtcblxuICAgICAgLy8gU3RvcmUgVVJMcyBpbiB0aGUgY3dkIHdpdGhvdXQgYW55IHN1YmRpcmVjdG9yeSBzdHJ1Y3R1cmVcbiAgICAgIGlmIChmaWxlLmluY2x1ZGVzKFwiOi8vXCIpKSB7XG4gICAgICAgIGZpbGUgPSBuYW1lO1xuICAgICAgfVxuXG4gICAgICAvLyBDb2xsYXBzZSBoaWdoZXIgZGlyZWN0b3J5IHN0cnVjdHVyZVxuICAgICAgZmlsZSA9IGNvbGxhcHNlUGF0aChmaWxlKTtcblxuICAgICAgLy8gQ3JlYXRlIGRpcmVjdG9yeSB0cmVlLCBpZ25vcmluZyBcImRpcmVjdG9yeSBleGlzdHNcIiBWRlMgZXJyb3JzXG4gICAgICBjb25zdCBwYXJ0cyA9IGZpbGUuc3BsaXQoJy8nKS5zbGljZSgwLCAtMSk7XG4gICAgICBsZXQgcGF0aCA9ICcnO1xuICAgICAgd2hpbGUgKHBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcGF0aCArPSBwYXJ0cy5zaGlmdCgpICsgJy8nO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHB5b2RpZGUuRlMubWtkaXIocGF0aCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBpZiAoZS5uYW1lICE9PSBcIkVycm5vRXJyb3JcIikgdGhyb3cgZTtcbiAgICAgICAgICBpZiAoZS5lcnJubyAhPT0gMjApIHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yVGV4dFB0ciA9IGF3YWl0IHB5b2RpZGUuX21vZHVsZS5fc3RyZXJyb3IoZS5lcnJubyk7XG4gICAgICAgICAgICBjb25zdCBlcnJvclRleHQgPSBhd2FpdCBweW9kaWRlLl9tb2R1bGUuVVRGOFRvU3RyaW5nKGVycm9yVGV4dFB0cik7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpbGVzeXN0ZW0gRXJyb3IgJHtlLmVycm5vfSBcIiR7ZXJyb3JUZXh0fVwiLmApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBXcml0ZSB0aGlzIGZpbGUgdG8gdGhlIFZGU1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHB5b2RpZGUuRlMud3JpdGVGaWxlKGZpbGUsIG5ldyBVaW50OEFycmF5KGRhdGEpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGUubmFtZSAhPT0gXCJFcnJub0Vycm9yXCIpIHRocm93IGU7XG4gICAgICAgIGNvbnN0IGVycm9yVGV4dFB0ciA9IGF3YWl0IHB5b2RpZGUuX21vZHVsZS5fc3RyZXJyb3IoZS5lcnJubyk7XG4gICAgICAgIGNvbnN0IGVycm9yVGV4dCA9IGF3YWl0IHB5b2RpZGUuX21vZHVsZS5VVEY4VG9TdHJpbmcoZXJyb3JUZXh0UHRyKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlc3lzdGVtIEVycm9yICR7ZS5lcnJub30gXCIke2Vycm9yVGV4dH1cIi5gKTtcbiAgICAgIH1cbiAgICB9KS5yZWR1Y2UoKGN1ciwgbmV4dCkgPT4gY3VyLnRoZW4obmV4dCksIFByb21pc2UucmVzb2x2ZSgpKTtcblxuICAgIHN0YXR1c1RleHQudGV4dENvbnRlbnQgPSBgUHlvZGlkZSBlbnZpcm9ubWVudCBzZXR1cGA7XG4gICAgYXdhaXQgc2V0dXBQeXRob24ocHlvZGlkZSk7XG5cbiAgICBzdGF0dXNUZXh0LnJlbW92ZSgpO1xuICAgIGlmIChzdGF0dXNDb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID09IDApIHtcbiAgICAgIHN0YXR1c0NvbnRhaW5lci5wYXJlbnROb2RlLnJlbW92ZSgpO1xuICAgIH1cbiAgICByZXR1cm4gcHlvZGlkZTtcbiAgfSkoKS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgc3RhdHVzVGV4dC5zdHlsZS5jb2xvciA9IFwidmFyKC0tZXhlcmNpc2UtZWRpdG9yLWhsLWVyLCAjQUQwMDAwKVwiO1xuICAgIHN0YXR1c1RleHQudGV4dENvbnRlbnQgPSBlcnIubWVzc2FnZTtcbiAgICAvL2luZGljYXRvckNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKFwiLnNwaW5uZXItZ3Jvd1wiKS5jbGFzc0xpc3QuYWRkKFwiZC1ub25lXCIpO1xuICAgIHRocm93IGVycjtcbiAgfSk7XG5cbiAgLy8gS2VlcCB0cmFjayBvZiBpbml0aWFsIE9KUyBibG9jayByZW5kZXJcbiAgY29uc3QgcmVuZGVyZWRPanMgPSB7fTtcblxuICBjb25zdCBwcm9jZXNzID0gYXN5bmMgKGNvbnRleHQsIGlucHV0cykgPT4ge1xuICAgIGNvbnN0IHB5b2RpZGUgPSBhd2FpdCBweW9kaWRlUHJvbWlzZTtcbiAgICBjb25zdCBldmFsdWF0b3IgPSBuZXcgUHlvZGlkZUV2YWx1YXRvcihweW9kaWRlLCBjb250ZXh0KTtcbiAgICBhd2FpdCBldmFsdWF0b3IucHJvY2VzcyhpbnB1dHMpO1xuICAgIHJldHVybiBldmFsdWF0b3IuY29udGFpbmVyO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBweW9kaWRlUHJvbWlzZSxcbiAgICByZW5kZXJlZE9qcyxcbiAgICBwcm9jZXNzLFxuICB9O1xufVxuIn1dfQ==
</script>
<div id="exercise-loading-indicator" class="exercise-loading-indicator d-none d-flex align-items-center gap-2">
<div id="exercise-loading-status" class="d-flex gap-2">

</div>
<div class="spinner-grow spinner-grow-sm">

</div>
</div>
<script type="vfs-file">
W10=
</script>
</section>
</section>

</main> <!-- /main -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W119
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../../concepts";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb11" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Encoding Internals - The Internal Machinery"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">  live-html:</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    mermaid:</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">      theme: default</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">#| autorun: true</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Auto-install pythonck package</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> micropip</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> micropip.install(<span class="st">"https://raw.githubusercontent.com/ghamarian/pythonck/master/documentation/pythonck-0.1.0-py3-none-any.whl"</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup pytensor path for pyodide environment</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the project root to path so we can import pytensor</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>sys.path.insert(<span class="dv">0</span>, <span class="st">'/home/aghamari/github/composable_kernel/visualisation'</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Import the actual CK modules</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytensor.tile_distribution_encoding <span class="im">import</span> TileDistributionEncoding</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytensor.tile_distribution <span class="im">import</span> make_static_tile_distribution</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>The tile distribution encoding system represents the core mathematical framework that transforms high-level tensor distribution specifications into concrete, optimized GPU kernel implementations. This sophisticated compile-time machinery bridges the gap between abstract mathematical descriptions and executable coordinate transformations, enabling the Composable Kernel framework to generate highly efficient code for complex tensor operations.</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>At its heart, the encoding system defines how multi-dimensional tensor data is distributed across GPU processing elements through a hierarchical decomposition scheme. By specifying relationships between different coordinate spaces - replication (R), hierarchical (H), partition (P), and yield (Y) dimensions - the encoding provides a complete blueprint for data layout and access patterns that can be resolved entirely at compile time.</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="fu">## Encoding Structure</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;div class="mermaid"&gt;</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="in">graph TB</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph "Encoding Components"</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a><span class="in">        RS["R-space Lengths&lt;br/&gt;Replication dimensions"]</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="in">        HS["H-space Lengths&lt;br/&gt;Hierarchical decomposition&lt;br/&gt;[[2,2],[2,2]]"]</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="in">        P2RH["P→RH Mappings&lt;br/&gt;Thread to hierarchy&lt;br/&gt;Major/Minor"]</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="in">        Y2RH["Y→RH Mappings&lt;br/&gt;Element to hierarchy&lt;br/&gt;Major/Minor"]</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph "Generated Components"</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="in">        ADAPTOR["ps_ys_to_xs_adaptor&lt;br/&gt;Coordinate transformer"]</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a><span class="in">        DESC["ys_to_d_descriptor&lt;br/&gt;Memory linearizer"]</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a><span class="in">        ENC["Encoding&lt;br/&gt;Original specification"]</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph "Transformation Chain"</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a><span class="in">        T1["Replicate&lt;br/&gt;Transform"]</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a><span class="in">        T2["Unmerge&lt;br/&gt;Transform"]</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a><span class="in">        T3["Merge&lt;br/&gt;Transform"]</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a><span class="in">    RS --&gt; T1</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a><span class="in">    HS --&gt; T2</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="in">    P2RH --&gt; ADAPTOR</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a><span class="in">    Y2RH --&gt; ADAPTOR</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a><span class="in">    T1 --&gt; T2</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a><span class="in">    T2 --&gt; T3</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a><span class="in">    T3 --&gt; ADAPTOR</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a><span class="in">    HS --&gt; DESC</span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a><span class="in">    Y2RH --&gt; DESC</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a><span class="in">    style RS fill:#fce4ec,stroke:#c2185b,stroke-width:2px</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a><span class="in">    style HS fill:#e8f5e9,stroke:#388e3c,stroke-width:2px</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a><span class="in">    style ADAPTOR fill:#e3f2fd,stroke:#1976d2,stroke-width:3px</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a><span class="in">    style DESC fill:#fff3e0,stroke:#f57c00,stroke-width:3px</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/div&gt;</span></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a><span class="fu">## What is Tile Distribution Encoding?</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>The <span class="in">`tile_distribution_encoding`</span> struct serves as a compile-time blueprint for defining complex tensor data layouts in GPU programming. It addresses a fundamental challenge in high-performance computing: how to map abstract tensor operations to the hierarchical memory and execution architecture of modern GPUs while maintaining both performance and programmability.</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>The encoding system operates through a multi-stage transformation pipeline that converts high-level specifications into concrete coordinate mappings. This pipeline consists of three primary components:</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>The **ps_ys_to_xs_adaptor** performs the crucial transformation from processing element coordinates (P) and logical access pattern coordinates (Y) to physical tensor coordinates (X). This adaptor encodes the complete mapping logic through a chain of coordinate transformations including replicate, unmerge, and merge operations.</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>The **ys_to_d_descriptor** manages the linearization of the multi-dimensional Y coordinate space into a one-dimensional data space suitable for register allocation. This component ensures efficient register utilization by mapping logical access patterns to physical storage locations.</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>The **transformation chains** are automatically constructed from the encoding parameters through template metaprogramming, ensuring zero runtime overhead. Each transformation in the chain corresponds to a specific coordinate space manipulation, collectively implementing the complete distribution strategy.</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>The C++ implementation leverages advanced template metaprogramming techniques:</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a><span class="co">// From ck_tile/core/tensor/tile_distribution_encoding.hpp</span></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> RsLengths_<span class="op">,</span>    <span class="co">// Replication dimension lengths</span></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> HsLengthss_<span class="op">,</span>   <span class="co">// Hierarchical dimension lengths</span></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ps2RHssMajor_<span class="op">,</span> <span class="co">// P to RH mapping (major)</span></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ps2RHssMinor_<span class="op">,</span> <span class="co">// P to RH mapping (minor)</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ys2RHsMajor_<span class="op">,</span>  <span class="co">// Y to RH mapping (major)</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ys2RHsMinor_<span class="op">&gt;</span>  <span class="co">// Y to RH mapping (minor)</span></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> tile_distribution_encoding</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">// All computations resolved at compile time</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> NDimX <span class="op">=</span> HsLengthss<span class="op">::</span>size<span class="op">();</span></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> NDimP <span class="op">=</span> Ps2RHssMajor<span class="op">::</span>size<span class="op">();</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> NDimY <span class="op">=</span> Ys2RHsMajor<span class="op">::</span>size<span class="op">();</span></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> NDimR <span class="op">=</span> RsLengths<span class="op">::</span>size<span class="op">();</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Nested detail struct performs complex compile-time calculations</span></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> detail</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Precomputed mappings and transformations</span></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>        <span class="at">static</span> <span class="kw">constexpr</span> <span class="kw">auto</span> get_h_dim_lengths_prefix_sum<span class="op">();</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>        <span class="at">static</span> <span class="kw">constexpr</span> <span class="kw">auto</span> get_uniformed_idx_y_to_h<span class="op">();</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... extensive compile-time computation ...</span></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a><span class="fu">## Encoding Structure Deep Dive</span></span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>The tile distribution encoding employs a sophisticated type system that captures the complete specification of tensor distribution patterns at compile time. Understanding this structure is essential for leveraging the full power of the CK framework's optimization capabilities.</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>The encoding revolves around several interconnected dimension types that collectively define the distribution strategy:</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Tile Distribution Encoding Structure"</span>)</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple encoding to examine</span></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>encoding <span class="op">=</span> TileDistributionEncoding(</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>    rs_lengths<span class="op">=</span>[],                    <span class="co"># No replication</span></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>    hs_lengthss<span class="op">=</span>[[<span class="dv">2</span>, <span class="dv">2</span>], [<span class="dv">2</span>, <span class="dv">2</span>]],   <span class="co"># 2x2 hierarchical tiles</span></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>    ps_to_rhss_major<span class="op">=</span>[[<span class="dv">1</span>], [<span class="dv">2</span>]],     <span class="co"># P0 to H1, P1 to H2  </span></span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>    ps_to_rhss_minor<span class="op">=</span>[[<span class="dv">0</span>], [<span class="dv">0</span>]],     <span class="co"># Use first component</span></span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>    ys_to_rhs_major<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>],    <span class="co"># Y mapping to H</span></span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>    ys_to_rhs_minor<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>]     <span class="co"># Y component selection</span></span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Encoding Parameters:"</span>)</span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  rs_lengths: </span><span class="sc">{</span>encoding<span class="sc">.</span>rs_lengths<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  hs_lengthss: </span><span class="sc">{</span>encoding<span class="sc">.</span>hs_lengthss<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  ps_to_rhss_major: </span><span class="sc">{</span>encoding<span class="sc">.</span>ps_to_rhss_major<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  ps_to_rhss_minor: </span><span class="sc">{</span>encoding<span class="sc">.</span>ps_to_rhss_minor<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  ys_to_rhs_major: </span><span class="sc">{</span>encoding<span class="sc">.</span>ys_to_rhs_major<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  ys_to_rhs_minor: </span><span class="sc">{</span>encoding<span class="sc">.</span>ys_to_rhs_minor<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Encoding created successfully!"</span>)</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a><span class="fu">## C++ Template Implementation</span></span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>The encoding system is implemented as a C++ template struct that leverages compile-time computation for maximum performance:</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a><span class="co">// From include/ck_tile/core/tensor/tile_distribution_encoding.hpp</span></span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> RsLengths_<span class="op">,</span>      <span class="co">// Replication dimensions</span></span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> HsLengthss_<span class="op">,</span>     <span class="co">// Hierarchical dimensions (tuple of tuples)</span></span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ps2RHssMajor_<span class="op">,</span>   <span class="co">// P→RH major mapping</span></span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ps2RHssMinor_<span class="op">,</span>   <span class="co">// P→RH minor mapping</span></span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ys2RHsMajor_<span class="op">,</span>    <span class="co">// Y→RH major mapping</span></span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> Ys2RhsMinor_<span class="op">,</span>    <span class="co">// Y→RH minor mapping</span></span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>          <span class="kw">typename</span> RHs2Xs_<span class="op">&gt;</span>         <span class="co">// RH→X final mapping</span></span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> tile_distribution_encoding</span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="dt">rs_lengths_type</span> <span class="op">=</span> RsLengths_<span class="op">;</span></span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="dt">hs_lengthss_type</span> <span class="op">=</span> HsLengthss_<span class="op">;</span></span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Static member functions for compile-time access</span></span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">constexpr</span> <span class="kw">auto</span> get_rs_lengths<span class="op">()</span></span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dt">rs_lengths_type</span><span class="op">{};</span></span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">constexpr</span> <span class="kw">auto</span> get_hs_lengthss<span class="op">()</span> </span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dt">hs_lengthss_type</span><span class="op">{};</span></span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute total number of dimensions</span></span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> get_num_of_dimension_p<span class="op">()</span></span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> size<span class="op">(</span>Ps2RHssMajor_<span class="op">{});</span></span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> get_num_of_dimension_y<span class="op">()</span></span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> size<span class="op">(</span>Ys2RHsMajor_<span class="op">{});</span></span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key C++ Features Used</span></span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Template Metaprogramming**: All parameters are types, not values, enabling compile-time optimization</span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Constexpr Functions**: Everything is computed at compile time</span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Type Aliases**: Clean access to template parameters</span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Static Member Functions**: No runtime overhead</span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parameter Breakdown</span></span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a>Each template parameter in the encoding system serves a specific purpose in defining the overall distribution strategy. These parameters work together to create a complete specification that can be transformed into efficient GPU code.</span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a><span class="fu">### R-Dimensions: Replication Specification</span></span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a>The <span class="in">`RsLengths`</span> parameter defines dimensions that are replicated across processing units, enabling data sharing patterns essential for many tensor operations. In the transformation pipeline, these dimensions generate <span class="in">`coord_transform_enum::replicate`</span> operations that broadcast data across multiple processing elements.</span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a>Replication serves several critical purposes in GPU kernel optimization. It enables efficient data reuse in operations like matrix multiplication where the same input data is needed by multiple output computations. It also facilitates reduction operations where multiple threads collaborate to compute a single result. The replication pattern directly impacts memory access efficiency and register utilization.</span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a>For example, in a GEMM operation:</span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Matrix A might have <span class="in">`RsLengths = sequence&lt;NWarp&gt;`</span>, indicating replication across warps computing different N-dimension tiles</span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Matrix B might have <span class="in">`RsLengths = sequence&lt;MWarp&gt;`</span>, indicating replication across warps computing different M-dimension tiles</span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The output matrix C typically has no replication at the outer level, as each element is uniquely owned</span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a><span class="fu">### H-Dimensions: Hierarchical Decomposition</span></span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a>The <span class="in">`HsLengthss`</span> parameter represents the hierarchical decomposition of tensor dimensions, encoded as a tuple of sequences. Each sequence defines how a logical tensor dimension (X-dimension) is broken down into finer-grained components that map to the GPU's execution hierarchy.</span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a>This hierarchical decomposition is fundamental to achieving high performance on GPUs. It enables:</span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Memory coalescing**: By aligning the decomposition with warp and thread organization</span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Register blocking**: By defining tile sizes that fit in the register file</span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Shared memory utilization**: By creating tiles that exploit data reuse</span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a>The decomposition typically follows a pattern like <span class="in">`sequence&lt;RepeatCount, WarpCount, ThreadCount, VectorSize&gt;`</span>, where:</span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`RepeatCount`</span>: Number of iterations each thread performs</span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`WarpCount`</span>: Number of warps assigned to this dimension</span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`ThreadCount`</span>: Number of threads per warp assigned to this dimension  </span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`VectorSize`</span>: Number of elements accessed in a single vector operation</span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a>In the transformation pipeline, each H-dimension group generates <span class="in">`coord_transform_enum::unmerge`</span> operations that break down abstract dimensions into their hierarchical components:</span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a><span class="co">// Example from block GEMM implementation</span></span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="kw">auto</span> hs_lengthss <span class="op">=</span> tuple<span class="op">&lt;</span></span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a>    sequence<span class="op">&lt;</span>MIterPerWarp<span class="op">,</span> MWarp<span class="op">&gt;,</span>  <span class="co">// M-dimension decomposition</span></span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a>    sequence<span class="op">&lt;</span>KIterPerWarp<span class="op">&gt;</span>          <span class="co">// K-dimension decomposition</span></span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;;</span></span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a><span class="fu">### P-Dimensions: Partition Mapping</span></span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a>The <span class="in">`Ps2RHssMajor`</span> and <span class="in">`Ps2RHssMinor`</span> parameters define how partition dimensions map to the underlying RH-dimensions. Partition dimensions represent the fundamental unit of work assignment in the GPU's execution model, typically corresponding to hardware constructs like warps and threads.</span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a>The mapping mechanism uses a major/minor indexing scheme where:</span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Major index identifies which RH-dimension group (0 for R-dimensions, 1 to NDimX for H-dimensions)</span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Minor index identifies the specific component within that group</span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a>This mapping enables flexible work distribution strategies. For instance, in a typical block-level distribution:</span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`NDimP = 1`</span> might map to <span class="in">`{MWarp, NWarp}`</span> for distributing work across warp groups</span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`NDimP = 2`</span> at the combined level typically maps to <span class="in">`{warp_id, lane_id}`</span> for thread-level distribution</span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a>The P-dimension mapping directly influences memory access patterns and computational efficiency:</span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a><span class="co">// P-dimension retrieval in tile_distribution</span></span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a>CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">auto</span> _get_partition_index<span class="op">()</span></span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">constexpr</span><span class="op">(</span>NDimP <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> array<span class="op">&lt;</span><span class="dt">index_t</span><span class="op">,</span> <span class="dv">1</span><span class="op">&gt;{</span>get_lane_id<span class="op">()};</span></span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="kw">constexpr</span><span class="op">(</span>NDimP <span class="op">==</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> array<span class="op">&lt;</span><span class="dt">index_t</span><span class="op">,</span> <span class="dv">2</span><span class="op">&gt;{</span>get_warp_id<span class="op">(),</span> get_lane_id<span class="op">()};</span></span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a><span class="fu">### Y-Dimensions: Logical View Mapping</span></span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a>The <span class="in">`Ys2RHsMajor`</span> and <span class="in">`Ys2RHsMinor`</span> parameters define the logical view of the tile data - how users perceive and access the distributed tensor. Y-dimensions represent the iteration space for accessing tile elements, abstracting away the complexity of the underlying distribution.</span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a>The Y-to-RH mapping serves multiple purposes:</span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Interface definition**: Provides a clean API for accessing distributed data</span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Access pattern encoding**: Defines the order in which elements are processed</span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Vectorization support**: Enables efficient vector operations by grouping contiguous elements</span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a>In practice, Y-dimensions often correspond to the logical dimensions of the operation being performed. For a matrix multiplication tile:</span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Y0 might represent the M-dimension iteration space</span>
<span id="cb11-282"><a href="#cb11-282" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Y1 might represent the K-dimension iteration space</span>
<span id="cb11-283"><a href="#cb11-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-284"><a href="#cb11-284" aria-hidden="true" tabindex="-1"></a>The mapping ensures that logical access patterns translate to efficient physical memory operations.</span>
<span id="cb11-285"><a href="#cb11-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-286"><a href="#cb11-286" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`[[4, 4], [4, 4]]`</span> → 4x4 tiles (16 elements per thread)</span>
<span id="cb11-287"><a href="#cb11-287" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`[[2, 4], [4, 2]]`</span> → 2x4 and 4x2 tiles (8 elements per thread)</span>
<span id="cb11-288"><a href="#cb11-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-289"><a href="#cb11-289" aria-hidden="true" tabindex="-1"></a><span class="fu">### P→RH Mappings</span></span>
<span id="cb11-290"><a href="#cb11-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-291"><a href="#cb11-291" aria-hidden="true" tabindex="-1"></a>**🔹 ps_to_rhss_major/minor (P→RH Mappings)**</span>
<span id="cb11-292"><a href="#cb11-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-293"><a href="#cb11-293" aria-hidden="true" tabindex="-1"></a>Maps partition coordinates to RH space:</span>
<span id="cb11-294"><a href="#cb11-294" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Controls which H dimensions each P dimension affects</span>
<span id="cb11-295"><a href="#cb11-295" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>major/minor specify different levels of the mapping</span>
<span id="cb11-296"><a href="#cb11-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-297"><a href="#cb11-297" aria-hidden="true" tabindex="-1"></a>**📝 Conceptual Example:**</span>
<span id="cb11-298"><a href="#cb11-298" aria-hidden="true" tabindex="-1"></a><span class="in">`ps_to_rhss_major=[[1], [2]]`</span> means:</span>
<span id="cb11-299"><a href="#cb11-299" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>P dimension 0 maps to H dimension 1</span>
<span id="cb11-300"><a href="#cb11-300" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>P dimension 1 maps to H dimension 2</span>
<span id="cb11-301"><a href="#cb11-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-302"><a href="#cb11-302" aria-hidden="true" tabindex="-1"></a>This determines how thread coordinates affect tile placement.</span>
<span id="cb11-303"><a href="#cb11-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-304"><a href="#cb11-304" aria-hidden="true" tabindex="-1"></a><span class="fu">### Y→RH Mappings</span></span>
<span id="cb11-305"><a href="#cb11-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-306"><a href="#cb11-306" aria-hidden="true" tabindex="-1"></a>**🔹 ys_to_rhs_major/minor (Y→RH Mappings)**</span>
<span id="cb11-307"><a href="#cb11-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-308"><a href="#cb11-308" aria-hidden="true" tabindex="-1"></a>Maps Y coordinates to RH space:</span>
<span id="cb11-309"><a href="#cb11-309" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Determines how logical Y coordinates map to hierarchical structure</span>
<span id="cb11-310"><a href="#cb11-310" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Controls the internal organization of each thread's tile</span>
<span id="cb11-311"><a href="#cb11-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-312"><a href="#cb11-312" aria-hidden="true" tabindex="-1"></a>**📝 Example Mapping:**</span>
<span id="cb11-313"><a href="#cb11-313" aria-hidden="true" tabindex="-1"></a><span class="in">`ys_to_rhs_major=[1, 1, 2, 2]`</span> means:</span>
<span id="cb11-314"><a href="#cb11-314" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Y<span class="co">[</span><span class="ot">0</span><span class="co">]</span> maps to H1</span>
<span id="cb11-315"><a href="#cb11-315" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Y<span class="co">[</span><span class="ot">1</span><span class="co">]</span> maps to H1  </span>
<span id="cb11-316"><a href="#cb11-316" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Y<span class="co">[</span><span class="ot">2</span><span class="co">]</span> maps to H2</span>
<span id="cb11-317"><a href="#cb11-317" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Y<span class="co">[</span><span class="ot">3</span><span class="co">]</span> maps to H2</span>
<span id="cb11-318"><a href="#cb11-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-319"><a href="#cb11-319" aria-hidden="true" tabindex="-1"></a>This creates the internal structure of thread tiles.</span>
<span id="cb11-320"><a href="#cb11-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-321"><a href="#cb11-321" aria-hidden="true" tabindex="-1"></a><span class="fu">## From Encoding to Tile Distribution</span></span>
<span id="cb11-322"><a href="#cb11-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-323"><a href="#cb11-323" aria-hidden="true" tabindex="-1"></a>The magic happens when <span class="in">`make_static_tile_distribution()`</span> transforms the mathematical encoding into runtime components:</span>
<span id="cb11-324"><a href="#cb11-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-327"><a href="#cb11-327" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb11-328"><a href="#cb11-328" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🔧 From Encoding to Tile Distribution"</span>)</span>
<span id="cb11-329"><a href="#cb11-329" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb11-330"><a href="#cb11-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-331"><a href="#cb11-331" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The transformation process:"</span>)</span>
<span id="cb11-332"><a href="#cb11-332" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"1. Analyze encoding parameters"</span>)</span>
<span id="cb11-333"><a href="#cb11-333" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"2. Build transformation chains"</span>)</span>
<span id="cb11-334"><a href="#cb11-334" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"3. Create runtime components"</span>)</span>
<span id="cb11-335"><a href="#cb11-335" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"4. Optimize for performance"</span>)</span>
<span id="cb11-336"><a href="#cb11-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-337"><a href="#cb11-337" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tile distribution from encoding</span></span>
<span id="cb11-338"><a href="#cb11-338" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb11-339"><a href="#cb11-339" aria-hidden="true" tabindex="-1"></a>    tile_distribution <span class="op">=</span> make_static_tile_distribution(encoding)</span>
<span id="cb11-340"><a href="#cb11-340" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-341"><a href="#cb11-341" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✅ Tile distribution created successfully!"</span>)</span>
<span id="cb11-342"><a href="#cb11-342" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">📦 Internal Components Created:"</span>)</span>
<span id="cb11-343"><a href="#cb11-343" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  • ps_ys_to_xs_adaptor: Maps (P,Y) coordinates to X coordinates"</span>)</span>
<span id="cb11-344"><a href="#cb11-344" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  • ys_to_d_descriptor: Maps Y coordinates to linearized storage"</span>)</span>
<span id="cb11-345"><a href="#cb11-345" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  • encoding: Original mathematical specification"</span>)</span>
<span id="cb11-346"><a href="#cb11-346" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-347"><a href="#cb11-347" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show the components exist</span></span>
<span id="cb11-348"><a href="#cb11-348" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🔍 Component Verification:"</span>)</span>
<span id="cb11-349"><a href="#cb11-349" aria-hidden="true" tabindex="-1"></a>    components <span class="op">=</span> [</span>
<span id="cb11-350"><a href="#cb11-350" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'ps_ys_to_xs_adaptor'</span>, <span class="st">'P+Y → X transformation'</span>),</span>
<span id="cb11-351"><a href="#cb11-351" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'ys_to_d_descriptor'</span>, <span class="st">'Y → D linearization'</span>),</span>
<span id="cb11-352"><a href="#cb11-352" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'encoding'</span>, <span class="st">'Original specification'</span>)</span>
<span id="cb11-353"><a href="#cb11-353" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-354"><a href="#cb11-354" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-355"><a href="#cb11-355" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> component, description <span class="kw">in</span> components:</span>
<span id="cb11-356"><a href="#cb11-356" aria-hidden="true" tabindex="-1"></a>        has_component <span class="op">=</span> <span class="bu">hasattr</span>(tile_distribution, component)</span>
<span id="cb11-357"><a href="#cb11-357" aria-hidden="true" tabindex="-1"></a>        status <span class="op">=</span> <span class="st">"✅"</span> <span class="cf">if</span> has_component <span class="cf">else</span> <span class="st">"❌"</span></span>
<span id="cb11-358"><a href="#cb11-358" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>status<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>component<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>description<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-359"><a href="#cb11-359" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-360"><a href="#cb11-360" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-361"><a href="#cb11-361" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"⚠️ Creation failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-362"><a href="#cb11-362" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Note: This demonstrates the concept even if creation fails"</span>)</span>
<span id="cb11-363"><a href="#cb11-363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-364"><a href="#cb11-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-365"><a href="#cb11-365" aria-hidden="true" tabindex="-1"></a><span class="fu">## The P+Y → X Transformation Chain</span></span>
<span id="cb11-366"><a href="#cb11-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-367"><a href="#cb11-367" aria-hidden="true" tabindex="-1"></a>The heart of the system is the adaptor that implements the P+Y → X transformation.</span>
<span id="cb11-368"><a href="#cb11-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-369"><a href="#cb11-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb11-370"><a href="#cb11-370" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;div class="mermaid"&gt;</span></span>
<span id="cb11-371"><a href="#cb11-371" aria-hidden="true" tabindex="-1"></a><span class="in">flowchart LR</span></span>
<span id="cb11-372"><a href="#cb11-372" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph "Input Coordinates"</span></span>
<span id="cb11-373"><a href="#cb11-373" aria-hidden="true" tabindex="-1"></a><span class="in">        P["P-coordinates&lt;br/&gt;[warp_id, lane_id]"]</span></span>
<span id="cb11-374"><a href="#cb11-374" aria-hidden="true" tabindex="-1"></a><span class="in">        Y["Y-coordinates&lt;br/&gt;[y0, y1, y2, y3]"]</span></span>
<span id="cb11-375"><a href="#cb11-375" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb11-376"><a href="#cb11-376" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb11-377"><a href="#cb11-377" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph "Transformation Pipeline"</span></span>
<span id="cb11-378"><a href="#cb11-378" aria-hidden="true" tabindex="-1"></a><span class="in">        C1["Combine P+Y"]</span></span>
<span id="cb11-379"><a href="#cb11-379" aria-hidden="true" tabindex="-1"></a><span class="in">        T1["Replicate&lt;br/&gt;Transform&lt;br/&gt;(if R-dims exist)"]</span></span>
<span id="cb11-380"><a href="#cb11-380" aria-hidden="true" tabindex="-1"></a><span class="in">        T2["Unmerge&lt;br/&gt;Transform&lt;br/&gt;(break into H-dims)"]</span></span>
<span id="cb11-381"><a href="#cb11-381" aria-hidden="true" tabindex="-1"></a><span class="in">        T3["Merge&lt;br/&gt;Transform&lt;br/&gt;(combine to X-dims)"]</span></span>
<span id="cb11-382"><a href="#cb11-382" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb11-383"><a href="#cb11-383" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb11-384"><a href="#cb11-384" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph "Output"</span></span>
<span id="cb11-385"><a href="#cb11-385" aria-hidden="true" tabindex="-1"></a><span class="in">        X["X-coordinates&lt;br/&gt;[x0, x1]&lt;br/&gt;Tensor position"]</span></span>
<span id="cb11-386"><a href="#cb11-386" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb11-387"><a href="#cb11-387" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb11-388"><a href="#cb11-388" aria-hidden="true" tabindex="-1"></a><span class="in">    P --&gt; C1</span></span>
<span id="cb11-389"><a href="#cb11-389" aria-hidden="true" tabindex="-1"></a><span class="in">    Y --&gt; C1</span></span>
<span id="cb11-390"><a href="#cb11-390" aria-hidden="true" tabindex="-1"></a><span class="in">    C1 --&gt; T1</span></span>
<span id="cb11-391"><a href="#cb11-391" aria-hidden="true" tabindex="-1"></a><span class="in">    T1 --&gt; T2</span></span>
<span id="cb11-392"><a href="#cb11-392" aria-hidden="true" tabindex="-1"></a><span class="in">    T2 --&gt; T3</span></span>
<span id="cb11-393"><a href="#cb11-393" aria-hidden="true" tabindex="-1"></a><span class="in">    T3 --&gt; X</span></span>
<span id="cb11-394"><a href="#cb11-394" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb11-395"><a href="#cb11-395" aria-hidden="true" tabindex="-1"></a><span class="in">    style P fill:#e3f2fd,stroke:#1976d2,stroke-width:2px</span></span>
<span id="cb11-396"><a href="#cb11-396" aria-hidden="true" tabindex="-1"></a><span class="in">    style Y fill:#fff3e0,stroke:#f57c00,stroke-width:2px</span></span>
<span id="cb11-397"><a href="#cb11-397" aria-hidden="true" tabindex="-1"></a><span class="in">    style X fill:#e8f5e9,stroke:#388e3c,stroke-width:2px</span></span>
<span id="cb11-398"><a href="#cb11-398" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/div&gt;</span></span>
<span id="cb11-399"><a href="#cb11-399" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-400"><a href="#cb11-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-401"><a href="#cb11-401" aria-hidden="true" tabindex="-1"></a><span class="fu">### C++ Transformation Chain Implementation</span></span>
<span id="cb11-402"><a href="#cb11-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-403"><a href="#cb11-403" aria-hidden="true" tabindex="-1"></a>The transformation chain is built using C++ template metaprogramming to create a compile-time pipeline:</span>
<span id="cb11-404"><a href="#cb11-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-405"><a href="#cb11-405" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb11-406"><a href="#cb11-406" aria-hidden="true" tabindex="-1"></a><span class="co">// Building the transformation chain in make_static_tile_distribution</span></span>
<span id="cb11-407"><a href="#cb11-407" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> Encoding<span class="op">&gt;</span></span>
<span id="cb11-408"><a href="#cb11-408" aria-hidden="true" tabindex="-1"></a>CK_TILE_HOST_DEVICE <span class="kw">auto</span> make_ps_ys_to_xs_adaptor<span class="op">(</span><span class="at">const</span> Encoding<span class="op">&amp;</span> encoding<span class="op">)</span></span>
<span id="cb11-409"><a href="#cb11-409" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-410"><a href="#cb11-410" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Step 1: Create individual transforms</span></span>
<span id="cb11-411"><a href="#cb11-411" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="kw">auto</span> replicate_transform <span class="op">=</span> make_replicate_transform<span class="op">(</span></span>
<span id="cb11-412"><a href="#cb11-412" aria-hidden="true" tabindex="-1"></a>        encoding<span class="op">.</span>get_rs_lengths<span class="op">());</span></span>
<span id="cb11-413"><a href="#cb11-413" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-414"><a href="#cb11-414" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="kw">auto</span> unmerge_transform <span class="op">=</span> make_unmerge_transform<span class="op">(</span></span>
<span id="cb11-415"><a href="#cb11-415" aria-hidden="true" tabindex="-1"></a>        encoding<span class="op">.</span>get_hs_lengthss<span class="op">());</span></span>
<span id="cb11-416"><a href="#cb11-416" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-417"><a href="#cb11-417" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="kw">auto</span> merge_transform <span class="op">=</span> make_merge_transform<span class="op">(</span></span>
<span id="cb11-418"><a href="#cb11-418" aria-hidden="true" tabindex="-1"></a>        encoding<span class="op">.</span>get_rhs_to_xs_mapping<span class="op">());</span></span>
<span id="cb11-419"><a href="#cb11-419" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-420"><a href="#cb11-420" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Step 2: Chain transforms together</span></span>
<span id="cb11-421"><a href="#cb11-421" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="kw">auto</span> transform_chain <span class="op">=</span> chain_transforms<span class="op">(</span></span>
<span id="cb11-422"><a href="#cb11-422" aria-hidden="true" tabindex="-1"></a>        replicate_transform<span class="op">,</span></span>
<span id="cb11-423"><a href="#cb11-423" aria-hidden="true" tabindex="-1"></a>        unmerge_transform<span class="op">,</span> </span>
<span id="cb11-424"><a href="#cb11-424" aria-hidden="true" tabindex="-1"></a>        merge_transform<span class="op">);</span></span>
<span id="cb11-425"><a href="#cb11-425" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-426"><a href="#cb11-426" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Step 3: Create adaptor with the chain</span></span>
<span id="cb11-427"><a href="#cb11-427" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> make_tile_adaptor<span class="op">(</span></span>
<span id="cb11-428"><a href="#cb11-428" aria-hidden="true" tabindex="-1"></a>        transform_chain<span class="op">,</span></span>
<span id="cb11-429"><a href="#cb11-429" aria-hidden="true" tabindex="-1"></a>        encoding<span class="op">.</span>get_lower_dimension_hidden_idss<span class="op">());</span></span>
<span id="cb11-430"><a href="#cb11-430" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-431"><a href="#cb11-431" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-432"><a href="#cb11-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-433"><a href="#cb11-433" aria-hidden="true" tabindex="-1"></a><span class="fu">### How Transforms Work in C++</span></span>
<span id="cb11-434"><a href="#cb11-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-435"><a href="#cb11-435" aria-hidden="true" tabindex="-1"></a>Each transform is a compile-time object that knows how to convert coordinates:</span>
<span id="cb11-436"><a href="#cb11-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-437"><a href="#cb11-437" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb11-438"><a href="#cb11-438" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: Replicate transform implementation</span></span>
<span id="cb11-439"><a href="#cb11-439" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> Lengths<span class="op">&gt;</span></span>
<span id="cb11-440"><a href="#cb11-440" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> replicate_transform</span>
<span id="cb11-441"><a href="#cb11-441" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-442"><a href="#cb11-442" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> num_of_upper_dimension <span class="op">=</span> size<span class="op">(</span>Lengths<span class="op">{});</span></span>
<span id="cb11-443"><a href="#cb11-443" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> num_of_lower_dimension <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> num_of_upper_dimension<span class="op">;</span></span>
<span id="cb11-444"><a href="#cb11-444" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-445"><a href="#cb11-445" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> UpperIndex<span class="op">&gt;</span></span>
<span id="cb11-446"><a href="#cb11-446" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="kw">constexpr</span> <span class="kw">auto</span> </span>
<span id="cb11-447"><a href="#cb11-447" aria-hidden="true" tabindex="-1"></a>    calculate_lower_index<span class="op">(</span><span class="at">const</span> UpperIndex<span class="op">&amp;</span> idx_upper<span class="op">)</span> <span class="at">const</span></span>
<span id="cb11-448"><a href="#cb11-448" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-449"><a href="#cb11-449" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Replicate each coordinate: [a,b] -&gt; [a,b,0,0]</span></span>
<span id="cb11-450"><a href="#cb11-450" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> idx_lower <span class="op">=</span> make_zero_multi_index<span class="op">&lt;</span>num_of_lower_dimension<span class="op">&gt;();</span></span>
<span id="cb11-451"><a href="#cb11-451" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-452"><a href="#cb11-452" aria-hidden="true" tabindex="-1"></a>        static_for<span class="op">&lt;</span><span class="dv">0</span><span class="op">,</span> num_of_upper_dimension<span class="op">,</span> <span class="dv">1</span><span class="op">&gt;{}([&amp;](</span><span class="kw">auto</span> i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-453"><a href="#cb11-453" aria-hidden="true" tabindex="-1"></a>            idx_lower<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> idx_upper<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb11-454"><a href="#cb11-454" aria-hidden="true" tabindex="-1"></a>            idx_lower<span class="op">(</span>i <span class="op">+</span> num_of_upper_dimension<span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-455"><a href="#cb11-455" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb11-456"><a href="#cb11-456" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-457"><a href="#cb11-457" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> idx_lower<span class="op">;</span></span>
<span id="cb11-458"><a href="#cb11-458" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-459"><a href="#cb11-459" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb11-460"><a href="#cb11-460" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-461"><a href="#cb11-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-462"><a href="#cb11-462" aria-hidden="true" tabindex="-1"></a>**🔗 The P+Y → X Transformation Chain**</span>
<span id="cb11-463"><a href="#cb11-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-464"><a href="#cb11-464" aria-hidden="true" tabindex="-1"></a>The <span class="in">`ps_ys_to_xs_adaptor`</span> implements a chain of transformations:</span>
<span id="cb11-465"><a href="#cb11-465" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Start with P coordinates (which thread)</span>
<span id="cb11-466"><a href="#cb11-466" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Add Y coordinates (which element in thread's tile)</span>
<span id="cb11-467"><a href="#cb11-467" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Apply replication transforms (R-space)</span>
<span id="cb11-468"><a href="#cb11-468" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Apply hierarchical transforms (H-space)</span>
<span id="cb11-469"><a href="#cb11-469" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Merge into final X coordinates</span>
<span id="cb11-470"><a href="#cb11-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-471"><a href="#cb11-471" aria-hidden="true" tabindex="-1"></a>**💡 Why This Chain Works:**</span>
<span id="cb11-472"><a href="#cb11-472" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each transform handles one aspect of the mapping</span>
<span id="cb11-473"><a href="#cb11-473" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Transforms are composable and efficient</span>
<span id="cb11-474"><a href="#cb11-474" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The chain is built automatically from encoding</span>
<span id="cb11-475"><a href="#cb11-475" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Same pattern works for any distribution strategy</span>
<span id="cb11-476"><a href="#cb11-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-477"><a href="#cb11-477" aria-hidden="true" tabindex="-1"></a>**📝 Conceptual Example:**</span>
<span id="cb11-478"><a href="#cb11-478" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Input: P=<span class="co">[</span><span class="ot">1,0</span><span class="co">]</span> + Y=<span class="co">[</span><span class="ot">0,1</span><span class="co">]</span> → Combined=<span class="co">[</span><span class="ot">1,0,0,1</span><span class="co">]</span></span>
<span id="cb11-479"><a href="#cb11-479" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Transform 1: Handle replication (none in this case)</span>
<span id="cb11-480"><a href="#cb11-480" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Transform 2: Handle hierarchical structure</span>
<span id="cb11-481"><a href="#cb11-481" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Transform 3: Merge to final coordinates</span>
<span id="cb11-482"><a href="#cb11-482" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Output: X=<span class="co">[</span><span class="ot">0,3</span><span class="co">]</span> (final tensor position)</span>
<span id="cb11-483"><a href="#cb11-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-484"><a href="#cb11-484" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Y to D Linearization</span></span>
<span id="cb11-485"><a href="#cb11-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-486"><a href="#cb11-486" aria-hidden="true" tabindex="-1"></a>The descriptor handles the linearization of Y coordinates to memory addresses.</span>
<span id="cb11-487"><a href="#cb11-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-488"><a href="#cb11-488" aria-hidden="true" tabindex="-1"></a><span class="fu">### C++ Implementation of Y→D Descriptor</span></span>
<span id="cb11-489"><a href="#cb11-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-490"><a href="#cb11-490" aria-hidden="true" tabindex="-1"></a>The Y→D descriptor is responsible for converting multi-dimensional Y coordinates into linear memory offsets:</span>
<span id="cb11-491"><a href="#cb11-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-492"><a href="#cb11-492" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb11-493"><a href="#cb11-493" aria-hidden="true" tabindex="-1"></a><span class="co">// Y to D descriptor implementation</span></span>
<span id="cb11-494"><a href="#cb11-494" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> YLengths<span class="op">,</span> <span class="kw">typename</span> YStrides<span class="op">&gt;</span></span>
<span id="cb11-495"><a href="#cb11-495" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ys_to_d_descriptor</span>
<span id="cb11-496"><a href="#cb11-496" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-497"><a href="#cb11-497" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> num_of_dimension <span class="op">=</span> size<span class="op">(</span>YLengths<span class="op">{});</span></span>
<span id="cb11-498"><a href="#cb11-498" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-499"><a href="#cb11-499" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate linear offset from Y coordinates</span></span>
<span id="cb11-500"><a href="#cb11-500" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> YIndex<span class="op">&gt;</span></span>
<span id="cb11-501"><a href="#cb11-501" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="kw">constexpr</span> <span class="dt">index_t</span> </span>
<span id="cb11-502"><a href="#cb11-502" aria-hidden="true" tabindex="-1"></a>    calculate_offset<span class="op">(</span><span class="at">const</span> YIndex<span class="op">&amp;</span> idx_y<span class="op">)</span> <span class="at">const</span></span>
<span id="cb11-503"><a href="#cb11-503" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-504"><a href="#cb11-504" aria-hidden="true" tabindex="-1"></a>        <span class="dt">index_t</span> offset <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-505"><a href="#cb11-505" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-506"><a href="#cb11-506" aria-hidden="true" tabindex="-1"></a>        static_for<span class="op">&lt;</span><span class="dv">0</span><span class="op">,</span> num_of_dimension<span class="op">,</span> <span class="dv">1</span><span class="op">&gt;{}([&amp;](</span><span class="kw">auto</span> i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-507"><a href="#cb11-507" aria-hidden="true" tabindex="-1"></a>            offset <span class="op">+=</span> idx_y<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> YStrides<span class="op">{}[</span>i<span class="op">];</span></span>
<span id="cb11-508"><a href="#cb11-508" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb11-509"><a href="#cb11-509" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-510"><a href="#cb11-510" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> offset<span class="op">;</span></span>
<span id="cb11-511"><a href="#cb11-511" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-512"><a href="#cb11-512" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-513"><a href="#cb11-513" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get element space size (total elements per thread)</span></span>
<span id="cb11-514"><a href="#cb11-514" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> </span>
<span id="cb11-515"><a href="#cb11-515" aria-hidden="true" tabindex="-1"></a>    get_element_space_size<span class="op">()</span></span>
<span id="cb11-516"><a href="#cb11-516" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-517"><a href="#cb11-517" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> reduce_on_sequence<span class="op">(</span></span>
<span id="cb11-518"><a href="#cb11-518" aria-hidden="true" tabindex="-1"></a>            YLengths<span class="op">{},</span> </span>
<span id="cb11-519"><a href="#cb11-519" aria-hidden="true" tabindex="-1"></a>            multiplies<span class="op">{},</span> </span>
<span id="cb11-520"><a href="#cb11-520" aria-hidden="true" tabindex="-1"></a>            number<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;{});</span></span>
<span id="cb11-521"><a href="#cb11-521" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-522"><a href="#cb11-522" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb11-523"><a href="#cb11-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-524"><a href="#cb11-524" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage in distributed tensor</span></span>
<span id="cb11-525"><a href="#cb11-525" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> TileDistribution<span class="op">&gt;</span></span>
<span id="cb11-526"><a href="#cb11-526" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> static_distributed_tensor</span>
<span id="cb11-527"><a href="#cb11-527" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-528"><a href="#cb11-528" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> ys_to_d_descriptor <span class="op">=</span> <span class="kw">typename</span> TileDistribution<span class="op">::</span>ys_to_d_descriptor<span class="op">;</span></span>
<span id="cb11-529"><a href="#cb11-529" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-530"><a href="#cb11-530" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Thread-local storage</span></span>
<span id="cb11-531"><a href="#cb11-531" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">index_t</span> thread_buffer_size <span class="op">=</span> </span>
<span id="cb11-532"><a href="#cb11-532" aria-hidden="true" tabindex="-1"></a>        ys_to_d_descriptor<span class="op">::</span>get_element_space_size<span class="op">();</span></span>
<span id="cb11-533"><a href="#cb11-533" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-534"><a href="#cb11-534" aria-hidden="true" tabindex="-1"></a>    DataType <span class="va">thread_buffer_</span><span class="op">[</span>thread_buffer_size<span class="op">];</span></span>
<span id="cb11-535"><a href="#cb11-535" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-536"><a href="#cb11-536" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Access element at Y coordinate</span></span>
<span id="cb11-537"><a href="#cb11-537" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> YIndex<span class="op">&gt;</span></span>
<span id="cb11-538"><a href="#cb11-538" aria-hidden="true" tabindex="-1"></a>    CK_TILE_HOST_DEVICE DataType<span class="op">&amp;</span> at<span class="op">(</span><span class="at">const</span> YIndex<span class="op">&amp;</span> idx_y<span class="op">)</span></span>
<span id="cb11-539"><a href="#cb11-539" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-540"><a href="#cb11-540" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="dt">index_t</span> offset <span class="op">=</span> ys_to_d_descriptor<span class="op">{}.</span>calculate_offset<span class="op">(</span>idx_y<span class="op">);</span></span>
<span id="cb11-541"><a href="#cb11-541" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">thread_buffer_</span><span class="op">[</span>offset<span class="op">];</span></span>
<span id="cb11-542"><a href="#cb11-542" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-543"><a href="#cb11-543" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb11-544"><a href="#cb11-544" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-545"><a href="#cb11-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-546"><a href="#cb11-546" aria-hidden="true" tabindex="-1"></a><span class="fu">### Memory Layout Optimization</span></span>
<span id="cb11-547"><a href="#cb11-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-548"><a href="#cb11-548" aria-hidden="true" tabindex="-1"></a>The descriptor enables efficient register allocation:</span>
<span id="cb11-549"><a href="#cb11-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-550"><a href="#cb11-550" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb11-551"><a href="#cb11-551" aria-hidden="true" tabindex="-1"></a><span class="co">// Optimized layout for vector operations</span></span>
<span id="cb11-552"><a href="#cb11-552" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="dt">index_t</span> M<span class="op">,</span> <span class="dt">index_t</span> N<span class="op">,</span> <span class="dt">index_t</span> VectorSize<span class="op">&gt;</span></span>
<span id="cb11-553"><a href="#cb11-553" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> make_ys_to_d_descriptor_for_gemm</span>
<span id="cb11-554"><a href="#cb11-554" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-555"><a href="#cb11-555" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Layout: [M/VectorSize][N][VectorSize]</span></span>
<span id="cb11-556"><a href="#cb11-556" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This ensures vector loads are contiguous in memory</span></span>
<span id="cb11-557"><a href="#cb11-557" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> type <span class="op">=</span> tile_descriptor<span class="op">&lt;</span></span>
<span id="cb11-558"><a href="#cb11-558" aria-hidden="true" tabindex="-1"></a>        sequence<span class="op">&lt;</span>M<span class="op">/</span>VectorSize<span class="op">,</span> N<span class="op">,</span> VectorSize<span class="op">&gt;,</span></span>
<span id="cb11-559"><a href="#cb11-559" aria-hidden="true" tabindex="-1"></a>        sequence<span class="op">&lt;</span>N <span class="op">*</span> VectorSize<span class="op">,</span> VectorSize<span class="op">,</span> <span class="dv">1</span><span class="op">&gt;&gt;;</span></span>
<span id="cb11-560"><a href="#cb11-560" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb11-561"><a href="#cb11-561" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-562"><a href="#cb11-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-563"><a href="#cb11-563" aria-hidden="true" tabindex="-1"></a><span class="fu">### Y to D Linearization Details</span></span>
<span id="cb11-564"><a href="#cb11-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-565"><a href="#cb11-565" aria-hidden="true" tabindex="-1"></a>The <span class="in">`ys_to_d_descriptor`</span> handles memory layout within each thread:</span>
<span id="cb11-566"><a href="#cb11-566" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Start with Y coordinates <span class="co">[</span><span class="ot">y0, y1, y2, y3</span><span class="co">]</span></span>
<span id="cb11-567"><a href="#cb11-567" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Apply thread's local layout (usually row-major)</span>
<span id="cb11-568"><a href="#cb11-568" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Compute linear offset within thread's buffer</span>
<span id="cb11-569"><a href="#cb11-569" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Result: D coordinate (memory address)</span>
<span id="cb11-570"><a href="#cb11-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-571"><a href="#cb11-571" aria-hidden="true" tabindex="-1"></a>**📝 Example with [2, 2] tile:**</span>
<span id="cb11-572"><a href="#cb11-572" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Y=<span class="co">[</span><span class="ot">0,0</span><span class="co">]</span> → D=0</span>
<span id="cb11-573"><a href="#cb11-573" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Y=<span class="co">[</span><span class="ot">0,1</span><span class="co">]</span> → D=1</span>
<span id="cb11-574"><a href="#cb11-574" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Y=<span class="co">[</span><span class="ot">1,0</span><span class="co">]</span> → D=2</span>
<span id="cb11-575"><a href="#cb11-575" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Y=<span class="co">[</span><span class="ot">1,1</span><span class="co">]</span> → D=3</span>
<span id="cb11-576"><a href="#cb11-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-577"><a href="#cb11-577" aria-hidden="true" tabindex="-1"></a>**💡 Why Separate from Adaptor:**</span>
<span id="cb11-578"><a href="#cb11-578" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Adaptor handles inter-thread coordination (P+Y → X)</span>
<span id="cb11-579"><a href="#cb11-579" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Descriptor handles intra-thread layout (Y → D)</span>
<span id="cb11-580"><a href="#cb11-580" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This separation enables different memory layouts</span>
<span id="cb11-581"><a href="#cb11-581" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each thread can have its own descriptor</span>
<span id="cb11-582"><a href="#cb11-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-583"><a href="#cb11-583" aria-hidden="true" tabindex="-1"></a><span class="fu">## Practical Examples</span></span>
<span id="cb11-584"><a href="#cb11-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-585"><a href="#cb11-585" aria-hidden="true" tabindex="-1"></a>Different encodings create different behaviors:</span>
<span id="cb11-586"><a href="#cb11-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-587"><a href="#cb11-587" aria-hidden="true" tabindex="-1"></a>**🎯 Example 1: Simple 2x2 Distribution**</span>
<span id="cb11-588"><a href="#cb11-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-589"><a href="#cb11-589" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb11-590"><a href="#cb11-590" aria-hidden="true" tabindex="-1"></a>simple_encoding <span class="op">=</span> TileDistributionEncoding(</span>
<span id="cb11-591"><a href="#cb11-591" aria-hidden="true" tabindex="-1"></a>    rs_lengths<span class="op">=</span>[],</span>
<span id="cb11-592"><a href="#cb11-592" aria-hidden="true" tabindex="-1"></a>    hs_lengthss<span class="op">=</span>[[<span class="dv">2</span>], [<span class="dv">2</span>]],</span>
<span id="cb11-593"><a href="#cb11-593" aria-hidden="true" tabindex="-1"></a>    ps_to_rhss_major<span class="op">=</span>[[], []],</span>
<span id="cb11-594"><a href="#cb11-594" aria-hidden="true" tabindex="-1"></a>    ps_to_rhss_minor<span class="op">=</span>[[], []],</span>
<span id="cb11-595"><a href="#cb11-595" aria-hidden="true" tabindex="-1"></a>    ys_to_rhs_major<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb11-596"><a href="#cb11-596" aria-hidden="true" tabindex="-1"></a>    ys_to_rhs_minor<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb11-597"><a href="#cb11-597" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-598"><a href="#cb11-598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-599"><a href="#cb11-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-600"><a href="#cb11-600" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>No replication</span>
<span id="cb11-601"><a href="#cb11-601" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Simple hierarchical structure</span>
<span id="cb11-602"><a href="#cb11-602" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Direct P→H mapping</span>
<span id="cb11-603"><a href="#cb11-603" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Good for basic matrix operations</span>
<span id="cb11-604"><a href="#cb11-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-605"><a href="#cb11-605" aria-hidden="true" tabindex="-1"></a>**🎯 Example 2: With Replication**</span>
<span id="cb11-606"><a href="#cb11-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-607"><a href="#cb11-607" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb11-608"><a href="#cb11-608" aria-hidden="true" tabindex="-1"></a>replicated_encoding <span class="op">=</span> TileDistributionEncoding(</span>
<span id="cb11-609"><a href="#cb11-609" aria-hidden="true" tabindex="-1"></a>    rs_lengths<span class="op">=</span>[<span class="dv">2</span>],  <span class="co"># 2-way replication</span></span>
<span id="cb11-610"><a href="#cb11-610" aria-hidden="true" tabindex="-1"></a>    hs_lengthss<span class="op">=</span>[[<span class="dv">2</span>], [<span class="dv">2</span>]],</span>
<span id="cb11-611"><a href="#cb11-611" aria-hidden="true" tabindex="-1"></a>    ps_to_rhss_major<span class="op">=</span>[[], []],</span>
<span id="cb11-612"><a href="#cb11-612" aria-hidden="true" tabindex="-1"></a>    ps_to_rhss_minor<span class="op">=</span>[[], []],</span>
<span id="cb11-613"><a href="#cb11-613" aria-hidden="true" tabindex="-1"></a>    ys_to_rhs_major<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb11-614"><a href="#cb11-614" aria-hidden="true" tabindex="-1"></a>    ys_to_rhs_minor<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb11-615"><a href="#cb11-615" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-616"><a href="#cb11-616" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-617"><a href="#cb11-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-618"><a href="#cb11-618" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>2-way replication for data sharing</span>
<span id="cb11-619"><a href="#cb11-619" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Same hierarchical structure</span>
<span id="cb11-620"><a href="#cb11-620" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Good for broadcast operations</span>
<span id="cb11-621"><a href="#cb11-621" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Enables thread cooperation</span>
<span id="cb11-622"><a href="#cb11-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-623"><a href="#cb11-623" aria-hidden="true" tabindex="-1"></a><span class="fu">## Testing Your Understanding</span></span>
<span id="cb11-624"><a href="#cb11-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-625"><a href="#cb11-625" aria-hidden="true" tabindex="-1"></a>Let's verify your understanding of encoding internals:</span>
<span id="cb11-626"><a href="#cb11-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-629"><a href="#cb11-629" aria-hidden="true" tabindex="-1"></a><span class="in">```{pyodide}</span></span>
<span id="cb11-630"><a href="#cb11-630" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🧪 Testing Encoding Internals Understanding"</span>)</span>
<span id="cb11-631"><a href="#cb11-631" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb11-632"><a href="#cb11-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-633"><a href="#cb11-633" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_encoding_creation():</span>
<span id="cb11-634"><a href="#cb11-634" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Test that we can create valid encodings."""</span></span>
<span id="cb11-635"><a href="#cb11-635" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb11-636"><a href="#cb11-636" aria-hidden="true" tabindex="-1"></a>        test_encoding <span class="op">=</span> TileDistributionEncoding(</span>
<span id="cb11-637"><a href="#cb11-637" aria-hidden="true" tabindex="-1"></a>            rs_lengths<span class="op">=</span>[],</span>
<span id="cb11-638"><a href="#cb11-638" aria-hidden="true" tabindex="-1"></a>            hs_lengthss<span class="op">=</span>[[<span class="dv">2</span>], [<span class="dv">2</span>]],</span>
<span id="cb11-639"><a href="#cb11-639" aria-hidden="true" tabindex="-1"></a>            ps_to_rhss_major<span class="op">=</span>[[], []],</span>
<span id="cb11-640"><a href="#cb11-640" aria-hidden="true" tabindex="-1"></a>            ps_to_rhss_minor<span class="op">=</span>[[], []],</span>
<span id="cb11-641"><a href="#cb11-641" aria-hidden="true" tabindex="-1"></a>            ys_to_rhs_major<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb11-642"><a href="#cb11-642" aria-hidden="true" tabindex="-1"></a>            ys_to_rhs_minor<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb11-643"><a href="#cb11-643" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-644"><a href="#cb11-644" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb11-645"><a href="#cb11-645" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-646"><a href="#cb11-646" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-647"><a href="#cb11-647" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb11-648"><a href="#cb11-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-649"><a href="#cb11-649" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_encoding_has_required_fields():</span>
<span id="cb11-650"><a href="#cb11-650" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Test that encoding has all required fields."""</span></span>
<span id="cb11-651"><a href="#cb11-651" aria-hidden="true" tabindex="-1"></a>    encoding <span class="op">=</span> TileDistributionEncoding(</span>
<span id="cb11-652"><a href="#cb11-652" aria-hidden="true" tabindex="-1"></a>        rs_lengths<span class="op">=</span>[],</span>
<span id="cb11-653"><a href="#cb11-653" aria-hidden="true" tabindex="-1"></a>        hs_lengthss<span class="op">=</span>[[<span class="dv">2</span>], [<span class="dv">2</span>]],</span>
<span id="cb11-654"><a href="#cb11-654" aria-hidden="true" tabindex="-1"></a>        ps_to_rhss_major<span class="op">=</span>[[], []],</span>
<span id="cb11-655"><a href="#cb11-655" aria-hidden="true" tabindex="-1"></a>        ps_to_rhss_minor<span class="op">=</span>[[], []],</span>
<span id="cb11-656"><a href="#cb11-656" aria-hidden="true" tabindex="-1"></a>        ys_to_rhs_major<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb11-657"><a href="#cb11-657" aria-hidden="true" tabindex="-1"></a>        ys_to_rhs_minor<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb11-658"><a href="#cb11-658" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-659"><a href="#cb11-659" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-660"><a href="#cb11-660" aria-hidden="true" tabindex="-1"></a>    required_fields <span class="op">=</span> [</span>
<span id="cb11-661"><a href="#cb11-661" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rs_lengths'</span>, <span class="st">'hs_lengthss'</span>, <span class="st">'ps_to_rhss_major'</span>, </span>
<span id="cb11-662"><a href="#cb11-662" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ps_to_rhss_minor'</span>, <span class="st">'ys_to_rhs_major'</span>, <span class="st">'ys_to_rhs_minor'</span></span>
<span id="cb11-663"><a href="#cb11-663" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-664"><a href="#cb11-664" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-665"><a href="#cb11-665" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> field <span class="kw">in</span> required_fields:</span>
<span id="cb11-666"><a href="#cb11-666" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(encoding, field):</span>
<span id="cb11-667"><a href="#cb11-667" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb11-668"><a href="#cb11-668" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb11-669"><a href="#cb11-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-670"><a href="#cb11-670" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_different_encodings():</span>
<span id="cb11-671"><a href="#cb11-671" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Test creating different types of encodings."""</span></span>
<span id="cb11-672"><a href="#cb11-672" aria-hidden="true" tabindex="-1"></a>    encodings <span class="op">=</span> [</span>
<span id="cb11-673"><a href="#cb11-673" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Simple encoding</span></span>
<span id="cb11-674"><a href="#cb11-674" aria-hidden="true" tabindex="-1"></a>        TileDistributionEncoding(</span>
<span id="cb11-675"><a href="#cb11-675" aria-hidden="true" tabindex="-1"></a>            rs_lengths<span class="op">=</span>[],</span>
<span id="cb11-676"><a href="#cb11-676" aria-hidden="true" tabindex="-1"></a>            hs_lengthss<span class="op">=</span>[[<span class="dv">2</span>], [<span class="dv">2</span>]],</span>
<span id="cb11-677"><a href="#cb11-677" aria-hidden="true" tabindex="-1"></a>            ps_to_rhss_major<span class="op">=</span>[[], []],</span>
<span id="cb11-678"><a href="#cb11-678" aria-hidden="true" tabindex="-1"></a>            ps_to_rhss_minor<span class="op">=</span>[[], []],</span>
<span id="cb11-679"><a href="#cb11-679" aria-hidden="true" tabindex="-1"></a>            ys_to_rhs_major<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb11-680"><a href="#cb11-680" aria-hidden="true" tabindex="-1"></a>            ys_to_rhs_minor<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb11-681"><a href="#cb11-681" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb11-682"><a href="#cb11-682" aria-hidden="true" tabindex="-1"></a>        <span class="co"># With replication</span></span>
<span id="cb11-683"><a href="#cb11-683" aria-hidden="true" tabindex="-1"></a>        TileDistributionEncoding(</span>
<span id="cb11-684"><a href="#cb11-684" aria-hidden="true" tabindex="-1"></a>            rs_lengths<span class="op">=</span>[<span class="dv">2</span>],</span>
<span id="cb11-685"><a href="#cb11-685" aria-hidden="true" tabindex="-1"></a>            hs_lengthss<span class="op">=</span>[[<span class="dv">2</span>], [<span class="dv">2</span>]],</span>
<span id="cb11-686"><a href="#cb11-686" aria-hidden="true" tabindex="-1"></a>            ps_to_rhss_major<span class="op">=</span>[[], []],</span>
<span id="cb11-687"><a href="#cb11-687" aria-hidden="true" tabindex="-1"></a>            ps_to_rhss_minor<span class="op">=</span>[[], []],</span>
<span id="cb11-688"><a href="#cb11-688" aria-hidden="true" tabindex="-1"></a>            ys_to_rhs_major<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb11-689"><a href="#cb11-689" aria-hidden="true" tabindex="-1"></a>            ys_to_rhs_minor<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb11-690"><a href="#cb11-690" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-691"><a href="#cb11-691" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-692"><a href="#cb11-692" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-693"><a href="#cb11-693" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">len</span>(encodings) <span class="op">==</span> <span class="dv">2</span></span>
<span id="cb11-694"><a href="#cb11-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-695"><a href="#cb11-695" aria-hidden="true" tabindex="-1"></a><span class="co"># Run tests</span></span>
<span id="cb11-696"><a href="#cb11-696" aria-hidden="true" tabindex="-1"></a>tests <span class="op">=</span> [</span>
<span id="cb11-697"><a href="#cb11-697" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Encoding creation"</span>, test_encoding_creation),</span>
<span id="cb11-698"><a href="#cb11-698" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Required fields"</span>, test_encoding_has_required_fields),</span>
<span id="cb11-699"><a href="#cb11-699" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Different encodings"</span>, test_different_encodings)</span>
<span id="cb11-700"><a href="#cb11-700" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb11-701"><a href="#cb11-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-702"><a href="#cb11-702" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Running encoding internals tests:"</span>)</span>
<span id="cb11-703"><a href="#cb11-703" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> test_name, test_func <span class="kw">in</span> tests:</span>
<span id="cb11-704"><a href="#cb11-704" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb11-705"><a href="#cb11-705" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> test_func()</span>
<span id="cb11-706"><a href="#cb11-706" aria-hidden="true" tabindex="-1"></a>        status <span class="op">=</span> <span class="st">"PASS"</span> <span class="cf">if</span> result <span class="cf">else</span> <span class="st">"FAIL"</span></span>
<span id="cb11-707"><a href="#cb11-707" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  [</span><span class="sc">{</span>status<span class="sc">}</span><span class="ss">] </span><span class="sc">{</span>test_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-708"><a href="#cb11-708" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-709"><a href="#cb11-709" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  [ERROR] </span><span class="sc">{</span>test_name<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-710"><a href="#cb11-710" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-711"><a href="#cb11-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-712"><a href="#cb11-712" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Takeaways</span></span>
<span id="cb11-713"><a href="#cb11-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-714"><a href="#cb11-714" aria-hidden="true" tabindex="-1"></a>The tile distribution encoding system represents a sophisticated solution to the challenge of mapping high-level tensor operations to GPU hardware. Understanding its internals reveals several key architectural principles:</span>
<span id="cb11-715"><a href="#cb11-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-716"><a href="#cb11-716" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mathematical Foundation</span></span>
<span id="cb11-717"><a href="#cb11-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-718"><a href="#cb11-718" aria-hidden="true" tabindex="-1"></a>The encoding structure provides a complete mathematical specification of thread organization and data distribution:</span>
<span id="cb11-719"><a href="#cb11-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-720"><a href="#cb11-720" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Dimensional Hierarchy**: The system defines four types of dimensions (R, H, P, Y) that collectively describe the complete distribution strategy</span>
<span id="cb11-721"><a href="#cb11-721" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Compile-Time Resolution**: All relationships and transformations are resolved at compile time, ensuring zero runtime overhead</span>
<span id="cb11-722"><a href="#cb11-722" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Composable Transformations**: Individual coordinate transformations (replicate, unmerge, merge) compose to create complex mappings</span>
<span id="cb11-723"><a href="#cb11-723" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Hardware Alignment**: The hierarchical decomposition naturally aligns with GPU hardware organization</span>
<span id="cb11-724"><a href="#cb11-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-725"><a href="#cb11-725" aria-hidden="true" tabindex="-1"></a><span class="fu">### Automatic Code Generation</span></span>
<span id="cb11-726"><a href="#cb11-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-727"><a href="#cb11-727" aria-hidden="true" tabindex="-1"></a>The transformation from mathematical specification to executable code happens through a sophisticated pipeline:</span>
<span id="cb11-728"><a href="#cb11-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-729"><a href="#cb11-729" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Encoding Analysis**: The <span class="in">`make_adaptor_encoding_for_tile_distribution`</span> function analyzes the encoding parameters</span>
<span id="cb11-730"><a href="#cb11-730" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Transform Chain Construction**: Individual transformations are instantiated and connected based on the specification</span>
<span id="cb11-731"><a href="#cb11-731" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Optimization Application**: Compile-time optimizations eliminate overhead and generate efficient code</span>
<span id="cb11-732"><a href="#cb11-732" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Component Integration**: The generated adaptors and descriptors integrate seamlessly with the broader CK framework</span>
<span id="cb11-733"><a href="#cb11-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-734"><a href="#cb11-734" aria-hidden="true" tabindex="-1"></a><span class="fu">### Component Architecture</span></span>
<span id="cb11-735"><a href="#cb11-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-736"><a href="#cb11-736" aria-hidden="true" tabindex="-1"></a>The clean separation of concerns enables both flexibility and performance:</span>
<span id="cb11-737"><a href="#cb11-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-738"><a href="#cb11-738" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The **ps_ys_to_xs_adaptor** handles the complex mapping from logical to physical coordinates</span>
<span id="cb11-739"><a href="#cb11-739" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The **ys_to_d_descriptor** manages efficient linearization for register allocation</span>
<span id="cb11-740"><a href="#cb11-740" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each component has a well-defined interface enabling independent optimization</span>
<span id="cb11-741"><a href="#cb11-741" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Components compose naturally to create complete distribution systems</span>
<span id="cb11-742"><a href="#cb11-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-743"><a href="#cb11-743" aria-hidden="true" tabindex="-1"></a><span class="fu">### Performance Implications</span></span>
<span id="cb11-744"><a href="#cb11-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-745"><a href="#cb11-745" aria-hidden="true" tabindex="-1"></a>Every aspect of the encoding system is designed with GPU performance in mind:</span>
<span id="cb11-746"><a href="#cb11-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-747"><a href="#cb11-747" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Memory Coalescing**: Hierarchical decomposition ensures adjacent threads access adjacent memory</span>
<span id="cb11-748"><a href="#cb11-748" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Register Efficiency**: Y-to-D linearization optimizes register allocation and minimizes spills</span>
<span id="cb11-749"><a href="#cb11-749" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Bank Conflict Avoidance**: Careful dimension ordering prevents shared memory bank conflicts</span>
<span id="cb11-750"><a href="#cb11-750" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Vectorization Support**: The encoding naturally supports vector operations for maximum throughput</span>
<span id="cb11-751"><a href="#cb11-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-752"><a href="#cb11-752" aria-hidden="true" tabindex="-1"></a><span class="fu">### Practical Applications</span></span>
<span id="cb11-753"><a href="#cb11-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-754"><a href="#cb11-754" aria-hidden="true" tabindex="-1"></a>The encoding system's flexibility enables efficient implementation of diverse operations:</span>
<span id="cb11-755"><a href="#cb11-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-756"><a href="#cb11-756" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Matrix Multiplication**: Hierarchical tiling with appropriate replication patterns</span>
<span id="cb11-757"><a href="#cb11-757" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Convolution**: Spatial tiling with proper boundary handling</span>
<span id="cb11-758"><a href="#cb11-758" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Reduction Operations**: Collaborative patterns through R-dimension specification</span>
<span id="cb11-759"><a href="#cb11-759" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Complex Fusion**: Multiple operations can share distribution patterns for efficiency</span>
<span id="cb11-760"><a href="#cb11-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-761"><a href="#cb11-761" aria-hidden="true" tabindex="-1"></a>The encoding internals demonstrate how the Composable Kernel framework achieves both mathematical elegance and practical performance. By leveraging compile-time computation and sophisticated type system design, the same mathematical framework that provides clarity and composability also generates code that rivals hand-optimized implementations. This synergy between abstraction and performance represents the core strength of the CK approach to GPU kernel development. </span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<script src="font-cleanup.js"></script>




</body></html>